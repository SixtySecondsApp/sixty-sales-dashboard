<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fathom Embed Test - Debug Page</title>
    <!-- Tailwind via CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React via CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-zinc-950 text-zinc-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // Demo data (real Fathom share URLs from your examples)
      const DEMO_ITEMS = [
        {
          id: "hQzHeu38iRs4z9jLKXReEYaLrUqqGwxg",
          title: "60 Seconds",
          company: "allegrosoft.com",
          repName: "Phil O'Brien",
          dateISO: "2025-08-26T17:00:00Z",
          durationMinutes: 21.98,
          sentimentScore: 0.32,
          coachRating: 78,
          actionItemsOpen: 3,
          transcriptDocUrl: "https://docs.google.com/document/d/1CiAMJMZscDRNjoDAvlL299SCoF3QPFoxZJDdf_drKb8/edit",
          shareUrl: "https://fathom.video/share/hQzHeu38iRs4z9jLKXReEYaLrUqqGwxg",
          actionItems: [
            { id: "1", title: "Send supporting content and examples", assignee: "Phil O'Brien", deadline: "29 Aug", priority: "High", seconds: 1283 },
            { id: "2", title: "Book follow-up with Loren", assignee: "Phil O'Brien", deadline: "28 Aug", priority: "Med", seconds: 540 },
            { id: "3", title: "Draft proposal outline", assignee: "Phil O'Brien", deadline: "30 Aug", priority: "Med", seconds: 1010 }
          ],
          attendees: [
            { name: "Loren S", email: "loren@allegrosoft.com", external: true },
            { name: "Phil O'Brien", email: "phil@sixtyseconds.video", external: false }
          ],
          summary: "Successfully uploading and processing company data. Enriching with LinkedIn info. Clear next steps include fixing data table view, connecting export, and scheduling a demo.",
          talk: { rep: 58, customer: 42, judgement: "a bit high for discovery" }
        },
        {
          id: "U1Yz5xseWpJ868zhtdsBypnN75jxiKVS",
          title: "Mike Stedman",
          company: "michaelstedman.com",
          repName: "Steve Gibson",
          dateISO: "2025-08-21T14:30:00Z",
          durationMinutes: 29.91,
          sentimentScore: 0.1,
          coachRating: 71,
          actionItemsOpen: 2,
          transcriptDocUrl: null,
          shareUrl: "https://fathom.video/share/U1Yz5xseWpJ868zhtdsBypnN75jxiKVS",
          actionItems: [],
          attendees: [],
          summary: "Exploration call",
          talk: { rep: 50, customer: 50, judgement: "on target" }
        }
      ];

      // FathomPlayer Component with improved timeout & fallback
      function FathomPlayer({
        shareUrl,
        id,
        autoplay = false,
        startSeconds = 0,
        aspectRatio = "16 / 9",
        className = "",
        title = "Fathom video",
        timeoutMs = 6000
      }) {
        const shareId = id || extractId(shareUrl);
        const [loaded, setLoaded] = useState(false);
        const [failed, setFailed] = useState(false);
        const timeoutRef = React.useRef(null);

        useEffect(() => {
          if (!shareId) return;
          setLoaded(false);
          setFailed(false);

          // Clear any existing timeout
          if (timeoutRef.current) {
            window.clearTimeout(timeoutRef.current);
          }

          // Set new timeout
          timeoutRef.current = window.setTimeout(() => {
            if (!loaded) {
              console.warn('[FathomPlayer] Iframe failed to load within timeout');
              setFailed(true);
            }
          }, timeoutMs);

          return () => {
            if (timeoutRef.current) {
              window.clearTimeout(timeoutRef.current);
            }
          };
        }, [shareId, startSeconds, autoplay, timeoutMs]);

        if (!shareId) return null;

        const src = toEmbedSrc(shareId, { autoplay, timestamp: startSeconds });
        const openInFathom = () => {
          const q = startSeconds ? `?timestamp=${Math.floor(startSeconds)}` : "";
          window.open(`https://fathom.video/share/${shareId}${q}`, "_blank");
        };

        return (
          <div
            className={`relative w-full rounded-2xl overflow-hidden bg-black ${className}`}
            style={{ aspectRatio: typeof aspectRatio === "number" ? String(aspectRatio) : aspectRatio }}
          >
            {!failed && (
              <iframe
                src={src}
                title={title}
                className="absolute inset-0 w-full h-full border-0"
                loading="lazy"
                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; fullscreen"
                allowFullScreen
                onLoad={() => {
                  console.log('[FathomPlayer] Iframe loaded successfully');
                  setLoaded(true);
                  // Clear timeout when loaded successfully
                  if (timeoutRef.current) {
                    window.clearTimeout(timeoutRef.current);
                    timeoutRef.current = null;
                  }
                }}
              />
            )}

            {!loaded && !failed && (
              <div className="absolute inset-0 flex items-center justify-center text-zinc-200 text-sm bg-black/30">
                <div className="flex flex-col items-center gap-2">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
                  <div>Loading video…</div>
                </div>
              </div>
            )}

            {failed && (
              <div className="absolute inset-0 flex flex-col items-center justify-center gap-3 bg-zinc-950 text-zinc-200 p-4 text-center">
                <div className="text-base font-medium">⚠️ Couldn't load the embedded video</div>
                <div className="text-xs text-zinc-400 max-w-md">
                  Some environments block third-party iframes. The video failed to load within {timeoutMs / 1000} seconds.
                </div>
                <button
                  onClick={openInFathom}
                  className="px-4 py-2 rounded-lg bg-zinc-800 hover:bg-zinc-700 border border-zinc-700 text-sm transition-colors"
                >
                  Open in Fathom →
                </button>
                <div className="text-xs text-zinc-500 mt-2">
                  ID: {shareId}
                </div>
              </div>
            )}
          </div>
        );
      }

      // Helper functions
      function extractId(input) {
        if (!input) return null;
        try {
          if (/^https?:\/\//i.test(input)) {
            const u = new URL(input);
            const parts = u.pathname.split("/").filter(Boolean);
            return parts.pop() || null;
          }
          return String(input).trim();
        } catch {
          return null;
        }
      }

      function toEmbedSrc(id, opts = {}) {
        const url = new URL(`https://fathom.video/embed/${id}`);
        if (typeof opts.autoplay === "boolean") url.searchParams.set("autoplay", opts.autoplay ? "1" : "0");
        if (typeof opts.timestamp === "number" && opts.timestamp > 0) {
          url.searchParams.set("timestamp", String(Math.floor(opts.timestamp)));
        }
        return url.toString();
      }

      function labelSentiment(s) {
        if (s == null) return "—";
        if (s <= -0.25) return "Challenging";
        if (s < 0.25) return "Neutral";
        return "Positive";
      }

      function hms(seconds) {
        const s = Math.max(0, Math.floor(seconds));
        const hh = String(Math.floor(s / 3600)).padStart(2, "0");
        const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
        const ss = String(s % 60).padStart(2, "0");
        return `${hh}:${mm}:${ss}`;
      }

      // Meetings List Page
      function MeetingsListPage({ items = [], onOpen }) {
        const [scope, setScope] = useState("me");
        const [q, setQ] = useState("");
        const [sort, setSort] = useState({ key: "dateISO", dir: "desc" });

        const filtered = React.useMemo(() => {
          const s = q.trim().toLowerCase();
          let arr = items.filter((m) => !s ||
            m.title.toLowerCase().includes(s) ||
            (m.company || "").toLowerCase().includes(s) ||
            (m.repName || "").toLowerCase().includes(s)
          );
          arr.sort((a, b) => {
            const key = sort.key;
            const av = a[key];
            const bv = b[key];
            if (key === "dateISO") return (new Date(av) - new Date(bv)) * (sort.dir === "asc" ? 1 : -1);
            if (typeof av === "number" && typeof bv === "number") return (av - bv) * (sort.dir === "asc" ? 1 : -1);
            return String(av).localeCompare(String(bv)) * (sort.dir === "asc" ? 1 : -1);
          });
          return arr;
        }, [items, q, sort]);

        const setSortKey = (k) => setSort((prev) => (prev.key === k ? { key: k, dir: prev.dir === "asc" ? "desc" : "asc" } : { key: k, dir: "desc" }));

        return (
          <div className="p-6">
            <div className="flex items-center justify-between mb-4">
              <div>
                <div className="text-2xl font-semibold">Fathom Embed Test</div>
                <div className="text-sm text-zinc-400 mt-1">Testing improved timeout handling & fallback UI</div>
              </div>
              <div className="bg-zinc-900 rounded-xl p-1 border border-zinc-800">
                <button onClick={() => setScope("me")} className={`px-3 py-1 rounded-lg text-sm ${scope === "me" ? "bg-zinc-800" : ""}`}>My</button>
                <button onClick={() => setScope("team")} className={`px-3 py-1 rounded-lg text-sm ${scope === "team" ? "bg-zinc-800" : ""}`}>Team</button>
              </div>
            </div>

            <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-4 mb-4">
              <label className="text-xs text-zinc-400">Search</label>
              <input value={q} onChange={(e) => setQ(e.target.value)} placeholder="Title, company, rep" className="mt-1 w-full bg-zinc-950 border border-zinc-800 rounded-xl px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-zinc-700" />
            </div>

            <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl overflow-hidden">
              <table className="w-full text-sm">
                <thead className="bg-zinc-900/70 text-zinc-400 select-none">
                  <tr>
                    <Th onClick={() => setSortKey("title")} active={sort.key === "title"} dir={sort.dir}>Title</Th>
                    <Th onClick={() => setSortKey("company")} active={sort.key === "company"} dir={sort.dir}>Company</Th>
                    <Th onClick={() => setSortKey("repName")} active={sort.key === "repName"} dir={sort.dir}>Rep</Th>
                    <Th onClick={() => setSortKey("dateISO")} active={sort.key === "dateISO"} dir={sort.dir}>Date</Th>
                    <Th onClick={() => setSortKey("durationMinutes")} active={sort.key === "durationMinutes"} dir={sort.dir}>Duration</Th>
                    <Th onClick={() => setSortKey("sentimentScore")} active={sort.key === "sentimentScore"} dir={sort.dir}>Sentiment</Th>
                    <Th onClick={() => setSortKey("coachRating")} active={sort.key === "coachRating"} dir={sort.dir}>Coach</Th>
                    <th className="text-left p-3">Open</th>
                  </tr>
                </thead>
                <tbody>
                  {filtered.map((m) => (
                    <tr key={m.id} className="border-t border-zinc-800 hover:bg-zinc-900/60">
                      <td className="p-3 font-medium">{m.title}</td>
                      <td className="p-3 text-zinc-300">{m.company || "—"}</td>
                      <td className="p-3 text-zinc-300">{m.repName || "—"}</td>
                      <td className="p-3 text-zinc-300 whitespace-nowrap">{new Date(m.dateISO).toLocaleString()}</td>
                      <td className="p-3 text-zinc-300">{Math.round(m.durationMinutes)}m</td>
                      <td className="p-3">
                        <span className={`px-2 py-1 rounded-full text-xs ${m.sentimentScore == null ? 'bg-zinc-800 text-zinc-200' : m.sentimentScore > 0.25 ? 'bg-emerald-900/60 text-emerald-300' : m.sentimentScore < -0.25 ? 'bg-rose-900/60 text-rose-300' : 'bg-zinc-800 text-zinc-200'}`}>{labelSentiment(m.sentimentScore)}</span>
                      </td>
                      <td className="p-3"><span className="px-2 py-1 rounded-full text-xs bg-violet-900/60 text-violet-300">{m.coachRating ?? "—"}</span></td>
                      <td className="p-3 text-right">
                        <button onClick={() => onOpen && onOpen(m.id)} className="px-3 py-1 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors">Open</button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="mt-4 p-4 bg-blue-900/20 border border-blue-800 rounded-2xl">
              <div className="text-sm font-semibold text-blue-300 mb-2">🧪 Test Information</div>
              <ul className="text-xs text-zinc-300 space-y-1">
                <li>• Using improved FathomPlayer with 6-second timeout</li>
                <li>• Fallback UI shows if iframe doesn't load</li>
                <li>• Click "Open" to test video embedding</li>
                <li>• Check browser console for debug logs</li>
              </ul>
            </div>
          </div>
        );
      }

      function Th({ children, active, dir, onClick }) {
        return (
          <th className="text-left p-3 cursor-pointer select-none hover:bg-zinc-800/50" onClick={onClick}>
            <span className="inline-flex items-center gap-1">
              {children}
              <span className={active ? "opacity-100 text-[10px]" : "opacity-20 text-[10px]"}>{dir === "asc" ? "▲" : "▼"}</span>
            </span>
          </th>
        );
      }

      // Meeting Detail Page
      function MeetingDetail({ meeting, onBack }) {
        const [start, setStart] = useState(0);

        return (
          <div className="p-6">
            <button onClick={onBack} className="mb-4 px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg transition-colors">← Back</button>

            <div className="flex items-center justify-between mb-4">
              <div>
                <div className="text-2xl font-semibold">{meeting.title}</div>
                <div className="text-sm text-zinc-400">{meeting.company} • {new Date(meeting.dateISO).toLocaleString()} • {Math.round(meeting.durationMinutes)}m</div>
              </div>
              <div className="flex gap-2">
                <span className={`px-2 py-1 rounded-full text-xs ${meeting.sentimentScore > 0.25 ? 'bg-emerald-900/60 text-emerald-300' : meeting.sentimentScore < -0.25 ? 'bg-rose-900/60 text-rose-300' : 'bg-zinc-800 text-zinc-200'}`}>{labelSentiment(meeting.sentimentScore)}</span>
                <span className="px-2 py-1 rounded-full text-xs bg-violet-900/60 text-violet-300">Coach {meeting.coachRating}</span>
              </div>
            </div>

            <div className="grid grid-cols-12 gap-6">
              <div className="col-span-12 lg:col-span-8">
                <FathomPlayer shareUrl={meeting.shareUrl} autoplay={false} startSeconds={start} className="mb-4" />

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-4">
                    <div className="font-semibold mb-2">AI Summary</div>
                    <p className="text-sm text-zinc-300 whitespace-pre-line">{meeting.summary}</p>
                    <div className="mt-3 flex gap-2">
                      {meeting.transcriptDocUrl && (
                        <a href={meeting.transcriptDocUrl} target="_blank" className="px-3 py-1.5 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-sm transition-colors">Open transcript</a>
                      )}
                    </div>
                  </div>

                  <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-4">
                    <div className="font-semibold mb-2">Action Items ({meeting.actionItems.length})</div>
                    <div className="space-y-3">
                      {meeting.actionItems.map((a) => (
                        <div key={a.id} className="p-3 bg-zinc-900 border border-zinc-800 rounded-xl">
                          <div className="font-medium text-sm">{a.title}</div>
                          <div className="text-xs text-zinc-400 mt-1">Assignee: {a.assignee} • Due {a.deadline} • Priority {a.priority}</div>
                          <div className="mt-2 flex gap-2">
                            <button
                              className="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs transition-colors"
                              onClick={() => {
                                console.log(`[Timestamp Jump] Seeking to ${a.seconds}s`);
                                setStart(a.seconds);
                              }}
                            >
                              ▶ Play from {hms(a.seconds)}
                            </button>
                            <a className="px-2 py-1 bg-zinc-800 hover:bg-zinc-700 rounded-lg text-xs transition-colors" target="_blank" href={`${meeting.shareUrl}?timestamp=${a.seconds}`}>Open in Fathom</a>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </div>

              <div className="col-span-12 lg:col-span-4">
                <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-4 mb-4">
                  <div className="font-semibold mb-2">Attendees</div>
                  <div className="space-y-2">
                    {meeting.attendees.map((p, idx) => (
                      <div key={idx} className="flex items-center justify-between text-sm">
                        <div>
                          <div className="text-zinc-200">{p.name}</div>
                          <div className="text-zinc-500 text-xs">{p.email}</div>
                        </div>
                        {p.external ? <span className="px-2 py-1 rounded-full text-xs bg-amber-900/60 text-amber-300">External</span> : <span className="px-2 py-1 rounded-full text-xs bg-zinc-800 text-zinc-200">Internal</span>}
                      </div>
                    ))}
                  </div>
                </div>

                <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-4 mb-4">
                  <div className="font-semibold mb-2">Talk Time</div>
                  <div className="space-y-2 text-sm">
                    <div className="flex justify-between">
                      <span className="text-zinc-400">Rep:</span>
                      <span className="font-semibold">{meeting.talk.rep}%</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-zinc-400">Customer:</span>
                      <span className="font-semibold">{meeting.talk.customer}%</span>
                    </div>
                    <div className="text-xs text-zinc-500 mt-2">
                      Judgement: {meeting.talk.judgement}
                    </div>
                  </div>
                </div>

                <div className="bg-zinc-900/70 border border-zinc-800 rounded-2xl p-4">
                  <div className="font-semibold mb-2">Debug Info</div>
                  <div className="text-xs font-mono text-zinc-400 space-y-1">
                    <div>Share ID: {meeting.id}</div>
                    <div>URL: {meeting.shareUrl}</div>
                    <div className="text-[10px] break-all">Embed: https://fathom.video/embed/{meeting.id}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // Main App Component
      function App() {
        const [openId, setOpenId] = useState(null);
        const current = DEMO_ITEMS.find(m => m.id === openId) || null;

        return (
          <div className="min-h-screen">
            {current ? (
              <MeetingDetail meeting={current} onBack={() => setOpenId(null)} />
            ) : (
              <MeetingsListPage items={DEMO_ITEMS} onOpen={(id) => setOpenId(id)} />
            )}
          </div>
        );
      }

      // Render the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
