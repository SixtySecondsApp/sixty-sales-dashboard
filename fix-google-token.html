<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Google Token</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Fix Google Token for Testing</h1>
        
        <div id="authStatus" class="bg-yellow-100 border border-yellow-400 rounded-lg p-4 mb-6">
            <p class="text-yellow-800">Checking authentication...</p>
        </div>
        
        <div id="testSection" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Update Google Integration</h2>
            
            <button id="updateTokenBtn" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 mr-4">
                Update to Test Token
            </button>
            
            <button id="checkTokenBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                Check Current Token
            </button>
        </div>
        
        <div id="loginSection" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Please Sign In</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Email</label>
                    <input type="email" id="loginEmail" value="andrew.bryce@sixtyseconds.video" 
                           class="w-full border rounded px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Password</label>
                    <input type="password" id="loginPassword" 
                           class="w-full border rounded px-3 py-2">
                </div>
                <button id="loginBtn" class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                    Sign In
                </button>
            </div>
        </div>

        <div id="results" class="bg-white rounded-lg shadow p-6 hidden">
            <h2 class="text-xl font-semibold mb-4">Results</h2>
            <div id="resultContent"></div>
        </div>
    </div>

    <script type="module">
        // Initialize Supabase client
        const supabaseUrl = 'https://ewtuefzeogytgmsnkpmb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3dHVlZnplb2d5dGdtc25rcG1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4OTQ5MjcsImV4cCI6MjA1MzQ3MDkyN30.O22Zx_xB_UuasB19V66g69fl6GdAdW38vuYQPbGUUf8';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // Check authentication on load
        async function checkAuth() {
            const { data: { user }, error } = await supabaseClient.auth.getUser();
            
            const authStatus = document.getElementById('authStatus');
            const testSection = document.getElementById('testSection');
            const loginSection = document.getElementById('loginSection');
            
            if (user) {
                authStatus.innerHTML = `<p class="text-green-800">✅ Authenticated as: ${user.email}</p>`;
                authStatus.className = 'bg-green-100 border border-green-400 rounded-lg p-4 mb-6';
                testSection.classList.remove('hidden');
                loginSection.classList.add('hidden');
            } else {
                authStatus.innerHTML = `<p class="text-red-800">❌ Not authenticated</p>`;
                authStatus.className = 'bg-red-100 border border-red-400 rounded-lg p-4 mb-6';
                testSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
            }
        }

        // Call checkAuth on load
        checkAuth();

        // Login functionality
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('Please enter both email and password');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) {
                    alert(`Login failed: ${error.message}`);
                } else {
                    await checkAuth(); // Refresh auth status
                }
            } catch (error) {
                alert(`Login error: ${error.message}`);
            }
        });

        function showResults(html) {
            const resultsDiv = document.getElementById('results');
            const resultContent = document.getElementById('resultContent');
            resultsDiv.classList.remove('hidden');
            resultContent.innerHTML = html;
        }

        document.getElementById('updateTokenBtn').addEventListener('click', async () => {
            showResults('<p class="text-gray-600">Updating Google integration token...</p>');
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError || !user) {
                    throw new Error('Not authenticated');
                }

                // Create test token
                const testToken = 'test_access_token_' + Date.now();
                const testRefreshToken = 'test_refresh_token_' + Date.now();
                const expiresAt = new Date(Date.now() + 3600000).toISOString(); // 1 hour from now

                // First check if integration exists
                const { data: existing, error: checkError } = await supabaseClient
                    .from('google_integrations')
                    .select('*')
                    .eq('user_id', user.id)
                    .limit(1);

                if (checkError) {
                    throw new Error(`Error checking existing integration: ${checkError.message}`);
                }

                let result;
                if (existing && existing.length > 0) {
                    // Update existing integration (only fields that exist in schema)
                    const { data: updateData, error: updateError } = await supabaseClient
                        .from('google_integrations')
                        .update({
                            access_token: testToken,
                            refresh_token: testRefreshToken,
                            is_active: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('user_id', user.id)
                        .select()
                        .single();

                    if (updateError) {
                        throw new Error(`Update failed: ${updateError.message}`);
                    }
                    result = updateData;
                } else {
                    // Create new integration (only fields that exist in schema)
                    const { data: insertData, error: insertError } = await supabaseClient
                        .from('google_integrations')
                        .insert({
                            user_id: user.id,
                            access_token: testToken,
                            refresh_token: testRefreshToken,
                            is_active: true
                        })
                        .select()
                        .single();

                    if (insertError) {
                        throw new Error(`Insert failed: ${insertError.message}`);
                    }
                    result = insertData;
                }

                let html = '<div class="space-y-4">';
                html += '<div class="text-green-600 border p-3 rounded">';
                html += '<strong>✅ Google Integration Updated Successfully!</strong><br>';
                html += 'Test token has been set. You can now test Google Docs creation.';
                html += '</div>';
                html += `<div class="border p-3 rounded bg-gray-50">`;
                html += `<h3 class="font-semibold mb-2">Updated Integration:</h3>`;
                html += `<p><strong>Access Token:</strong> ${result.access_token}</p>`;
                html += `<p><strong>Refresh Token:</strong> ${result.refresh_token}</p>`;
                html += `<p><strong>Active:</strong> ${result.is_active}</p>`;
                html += `<p><strong>Updated:</strong> ${result.updated_at}</p>`;
                html += '</div>';
                html += '</div>';
                showResults(html);
                
            } catch (error) {
                console.error('Update error:', error);
                showResults(`<div class="text-red-600">Error: ${error.message}</div>`);
            }
        });

        document.getElementById('checkTokenBtn').addEventListener('click', async () => {
            showResults('<p class="text-gray-600">Checking current Google integration...</p>');
            
            try {
                // Get current user
                const { data: { user }, error: userError } = await supabaseClient.auth.getUser();
                
                if (userError || !user) {
                    throw new Error('Not authenticated');
                }

                // Query google_integrations table
                const { data: integrations, error: integrationsError } = await supabaseClient
                    .from('google_integrations')
                    .select('*')
                    .eq('user_id', user.id);

                let html = '<div class="space-y-4">';
                html += `<p><strong>User ID:</strong> ${user.id}</p>`;
                
                if (integrationsError) {
                    html += `<div class="text-red-600 border p-3 rounded">`;
                    html += `<strong>Database Error:</strong><br>`;
                    html += `<pre>${JSON.stringify(integrationsError, null, 2)}</pre>`;
                    html += `</div>`;
                } else if (integrations && integrations.length > 0) {
                    html += '<div class="text-green-600 border p-3 rounded"><strong>✅ Google Integrations Found:</strong></div>';
                    integrations.forEach((integration, index) => {
                        const isTestToken = integration.access_token?.startsWith('test_access_token_');
                        html += `<div class="border p-3 rounded bg-gray-50">`;
                        html += `<h3 class="font-semibold">Integration ${index + 1}</h3>`;
                        html += `<p><strong>Active:</strong> ${integration.is_active}</p>`;
                        html += `<p><strong>Is Test Token:</strong> ${isTestToken ? 'Yes ✅' : 'No ❌'}</p>`;
                        html += `<p><strong>Access Token:</strong> ${integration.access_token?.substring(0, 30)}...</p>`;
                        html += `<p><strong>Refresh Token:</strong> ${integration.refresh_token ? 'Yes' : 'No'}</p>`;
                        html += `<p><strong>Expires At:</strong> ${integration.token_expires_at}</p>`;
                        html += `<p><strong>Created:</strong> ${integration.created_at}</p>`;
                        html += `<p><strong>Updated:</strong> ${integration.updated_at}</p>`;
                        html += '</div>';
                    });
                } else {
                    html += '<div class="text-red-600 border p-3 rounded">';
                    html += '<strong>❌ No Google Integrations Found</strong><br>';
                    html += 'Click "Update to Test Token" to create one.';
                    html += '</div>';
                }
                
                html += '</div>';
                showResults(html);
                
            } catch (error) {
                console.error('Check error:', error);
                showResults(`<div class="text-red-600">Error: ${error.message}</div>`);
            }
        });
    </script>
</body>
</html>