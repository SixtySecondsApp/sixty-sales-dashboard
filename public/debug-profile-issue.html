<!DOCTYPE html>
<html>
<head>
    <title>Debug Profile Issue</title>
    <style>
        body {
            background: #111;
            color: #fff;
            font-family: system-ui;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            background: #222;
            border-radius: 8px;
        }
        h2 { color: #37bd7e; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #3b82f6; }
        button {
            background: #37bd7e;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            background: #1a1a1a;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Profile Issue</h1>
    
    <div class="section">
        <h2>Step-by-Step Test</h2>
        <button onclick="runFullTest()">Run Full Test</button>
        <button onclick="fixProfile()">Fix Profile Now</button>
    </div>

    <div class="section">
        <h2>Test Progress</h2>
        <div id="progress"></div>
    </div>

    <div class="section">
        <h2>Results</h2>
        <pre id="results"></pre>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        const supabaseUrl = 'https://ewtuefzeogytgmsnkpmb.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3dHVlZnplb2d5dGdtc25rcG1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4OTQ5MjcsImV4cCI6MjA1MzQ3MDkyN30.O22Zx_xB_UuasB19V66g69fl6GdAdW38vuYQPbGUUf8';
        
        const supabase = createClient(supabaseUrl, supabaseAnonKey);
        
        function addStep(message, type = 'info') {
            const progress = document.getElementById('progress');
            const step = document.createElement('div');
            step.className = 'step';
            step.innerHTML = `<span class="${type}">${message}</span>`;
            progress.appendChild(step);
            console.log(message);
        }
        
        function showResult(data) {
            const results = document.getElementById('results');
            results.innerHTML = JSON.stringify(data, null, 2);
        }
        
        window.runFullTest = async function() {
            document.getElementById('progress').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            
            try {
                // Step 1: Check session
                addStep('Step 1: Checking session...');
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                
                if (sessionError) {
                    addStep(`‚ùå Session error: ${sessionError.message}`, 'error');
                    showResult({ sessionError });
                    return;
                }
                
                if (!session) {
                    addStep('‚ùå No session found', 'error');
                    showResult({ error: 'No session' });
                    return;
                }
                
                addStep(`‚úÖ Session found for: ${session.user.email}`, 'success');
                const userId = session.user.id;
                const userEmail = session.user.email;
                
                // Step 2: Try to fetch profile by ID
                addStep('Step 2: Fetching profile by ID...');
                const { data: profileById, error: idError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .maybeSingle();
                
                if (idError) {
                    addStep(`‚ùå ID fetch error: ${idError.message}`, 'error');
                    addStep(`Error code: ${idError.code}`, 'error');
                    addStep(`Error details: ${idError.details}`, 'error');
                } else if (profileById) {
                    addStep('‚úÖ Profile found by ID', 'success');
                    showResult({ profileById });
                    return;
                } else {
                    addStep('‚ö†Ô∏è No profile found by ID', 'warning');
                }
                
                // Step 3: Try to fetch profile by email
                addStep('Step 3: Fetching profile by email...');
                const { data: profileByEmail, error: emailError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('email', userEmail)
                    .maybeSingle();
                
                if (emailError) {
                    addStep(`‚ùå Email fetch error: ${emailError.message}`, 'error');
                    addStep(`Error code: ${emailError.code}`, 'error');
                } else if (profileByEmail) {
                    addStep('‚úÖ Profile found by email', 'success');
                    showResult({ profileByEmail });
                    return;
                } else {
                    addStep('‚ö†Ô∏è No profile found by email', 'warning');
                }
                
                // Step 4: Check if we can query the profiles table at all
                addStep('Step 4: Testing table access...');
                const { data: anyProfiles, error: tableError } = await supabase
                    .from('profiles')
                    .select('id')
                    .limit(1);
                
                if (tableError) {
                    addStep(`‚ùå Cannot access profiles table: ${tableError.message}`, 'error');
                    addStep('This might be an RLS issue', 'warning');
                } else if (anyProfiles && anyProfiles.length > 0) {
                    addStep(`‚úÖ Can access profiles table (${anyProfiles.length} records visible)`, 'success');
                } else {
                    addStep('‚ö†Ô∏è Profiles table is empty or no records visible', 'warning');
                }
                
                // Step 5: Show what we found
                addStep('Step 5: Summary');
                showResult({
                    sessionUser: {
                        id: userId,
                        email: userEmail
                    },
                    profileById: profileById || 'Not found',
                    profileByEmail: profileByEmail || 'Not found',
                    tableAccessible: !tableError,
                    errors: {
                        idError: idError?.message,
                        emailError: emailError?.message,
                        tableError: tableError?.message
                    }
                });
                
            } catch (error) {
                addStep(`‚ùå Unexpected error: ${error.message}`, 'error');
                showResult({ unexpectedError: error.message });
            }
        }
        
        window.fixProfile = async function() {
            document.getElementById('progress').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            
            addStep('Attempting to fix profile...');
            
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    addStep('‚ùå No session found', 'error');
                    return;
                }
                
                const userId = session.user.id;
                const userEmail = session.user.email;
                
                // First, try to insert a new profile
                addStep('Attempting to insert profile...');
                const { data: insertData, error: insertError } = await supabase
                    .from('profiles')
                    .insert({
                        id: userId,
                        email: userEmail,
                        first_name: 'Andrew',
                        last_name: 'Bryce',
                        stage: 'Director',
                        is_admin: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    })
                    .select()
                    .single();
                
                if (insertData) {
                    addStep('‚úÖ Profile created successfully!', 'success');
                    showResult({ created: insertData });
                    return;
                } else if (insertError && insertError.code === '23505') {
                    addStep('Profile already exists, attempting update...', 'warning');
                    
                    // Try to update existing profile
                    const { data: updateData, error: updateError } = await supabase
                        .from('profiles')
                        .update({
                            email: userEmail,
                            first_name: 'Andrew',
                            last_name: 'Bryce',
                            stage: 'Director',
                            is_admin: true,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', userId)
                        .select()
                        .single();
                    
                    if (updateData) {
                        addStep('‚úÖ Profile updated successfully!', 'success');
                        showResult({ updated: updateData });
                    } else {
                        addStep(`‚ùå Update failed: ${updateError?.message}`, 'error');
                        showResult({ updateError });
                    }
                } else {
                    addStep(`‚ùå Insert failed: ${insertError?.message}`, 'error');
                    showResult({ insertError });
                }
                
            } catch (error) {
                addStep(`‚ùå Unexpected error: ${error.message}`, 'error');
                showResult({ error: error.message });
            }
        }
        
        // Auto-run on load
        window.addEventListener('load', () => {
            runFullTest();
        });
    </script>
</body>
</html>