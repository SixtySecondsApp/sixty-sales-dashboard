import{j as e}from"./vendor-state-CpjwTZNq.js";import{r as o,a as ke}from"./vendor-react-DoYyFkVR.js";import{g as q,B,h as D,i as de,a as N,v as Fe,j as Te,F as K,s as re,l as G,c as Ie,k as Ue,m as Ze,b as Qe,u as Ge,n as He,o as qe,S as ze}from"./index.html-Cwo_Unfk.js";import{u as We,O as Xe}from"./OwnerFilter-bkhDp6eP.js";import{Dialog as ce,DialogContent as oe,DialogHeader as ee,DialogTitle as ae,DialogDescription as fe,DialogFooter as Se}from"./dialog-BBMx1wit.js";import{U as Oe,ar as be,E as ue,d as Y,as as je,A as le,Q as Ne,k as we,W as De,z as Ve,e as ne,X as he,a3 as Pe,a0 as Ae,S as Le,B as ge,at as Ye,Z as Je,a4 as Ke,M as ea,P as aa,F as sa,i as Ce,an as Me,aa as Re}from"./vendor-icons-HRBKouGg.js";import{motion as U,AnimatePresence as ye}from"./ui-animation-Dzb4KUJ1.js";import{p as W}from"./vendor-utils-Cb9OXVhE.js";import"./vendor-router-CQXjpROx.js";import"./vendor-supabase-BuXd-BBn.js";import"./ui-radix-core-CdvL28QE.js";import"./vendor-charts-D4YcUEy1.js";function Ee({isOpen:g,onClose:f,clientName:d,currentStatus:l,onSave:V}){const[T,k]=o.useState(l),[I,w]=o.useState(new Date().toISOString().split("T")[0]),[F,p]=o.useState(""),[m,M]=o.useState(""),j=[{value:"signed",label:"Signed",icon:be,color:"border-blue-500/50 bg-blue-500/10 text-blue-400",description:"Contract signed, awaiting setup"},{value:"deposit_paid",label:"Deposit Paid",icon:ue,color:"border-yellow-500/50 bg-yellow-500/10 text-yellow-400",description:"Initial payment received"},{value:"active",label:"Active",icon:Y,color:"border-emerald-500/50 bg-emerald-500/10 text-emerald-400",description:"One-off payment received, service active"},{value:"subscribed",label:"Subscribed",icon:Y,color:"border-green-500/50 bg-green-500/10 text-green-400",description:"Monthly subscription active and billing"},{value:"paused",label:"Paused",icon:je,color:"border-orange-500/50 bg-orange-500/10 text-orange-400",description:"Temporarily paused, not billing"},{value:"notice_given",label:"Notice Given",icon:le,color:"border-red-500/50 bg-red-500/10 text-red-400",description:"Client gave notice, awaiting final billing"},{value:"churned",label:"Churned",icon:Ne,color:"border-gray-500/50 bg-gray-500/10 text-gray-400",description:"Subscription ended, no longer billing"}],y=T==="notice_given"||T==="churned",_=()=>{V(T,y?{noticeDate:I,finalBillingDate:F,churnReason:m||void 0}:void 0)},L=c=>{if(!c)return"";const r=new Date(c);return r.setDate(r.getDate()+30),r.toISOString().split("T")[0]},O=c=>{w(c),c&&!F&&p(L(c))};return e.jsx(ce,{open:g,onOpenChange:c=>!c&&f(),children:e.jsxs(oe,{className:"bg-gray-900/95 backdrop-blur-xl border-gray-800/50 text-white p-6 rounded-xl max-w-2xl",children:[e.jsxs(ee,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(Oe,{className:"w-5 h-5 text-blue-500"}),"Manage Client Status"]}),e.jsxs(fe,{className:"text-sm text-gray-400",children:["Update status for: ",e.jsx("span",{className:"text-white font-medium",children:d})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Client Status"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:j.map(c=>{const r=T===c.value,i=c.icon;return e.jsxs("button",{onClick:()=>k(c.value),className:q("p-4 rounded-lg border-2 transition-colors text-left",r?c.color:"border-gray-700/50 bg-gray-800/50 text-gray-400 hover:border-gray-600/50"),children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(i,{className:"w-5 h-5"}),e.jsx("span",{className:"font-medium",children:c.label})]}),e.jsx("p",{className:"text-xs opacity-80",children:c.description})]},c.value)})})]}),y&&e.jsxs("div",{className:"space-y-4 p-4 bg-gray-800/30 rounded-lg border border-gray-700/30",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-yellow-400",children:[e.jsx(we,{className:"w-4 h-4"}),"Churn Tracking Information"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Notice Given Date *"}),e.jsx("input",{type:"date",value:I,onChange:c=>O(c.target.value),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Final Billing Date *"}),e.jsx("input",{type:"date",value:F,onChange:c=>p(c.target.value),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",required:!0}),e.jsx("p",{className:"text-xs text-gray-400",children:"When the subscription will stop billing"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Churn Reason (Optional)"}),e.jsx("textarea",{value:m,onChange:c=>M(c.target.value),placeholder:"e.g., Budget constraints, switching providers, business closure...",className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent",rows:3})]})]}),e.jsxs("div",{className:"bg-gray-800/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-sm text-gray-300",children:"Current Status"}),e.jsx("div",{className:"text-lg font-medium capitalize text-white",children:l.replace("_"," ")})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(B,{onClick:_,disabled:y&&(!I||!F),className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white",children:"Update Status"}),e.jsx(B,{onClick:f,variant:"outline",className:"bg-gray-800/50 border-gray-700/50 text-white hover:bg-gray-700/50",children:"Cancel"})]})]})]})})}function Be({isOpen:g,onClose:f,dealId:d,dealName:l,currentMRR:V=null,currentOneOff:T=null,currentAnnualValue:k=null,onSave:I}){const[w,F]=o.useState(!1),[p,m]=o.useState({monthly_mrr:V||0,one_off_revenue:T||0});o.useEffect(()=>{m({monthly_mrr:D(V||0,0,{fieldName:"current_mrr",allowZero:!0}),one_off_revenue:D(T||0,0,{fieldName:"current_one_off",allowZero:!0})})},[V,T,g]);const M=async()=>{if(!d){N.error("No deal ID provided");return}F(!0);try{const c=Fe(p.monthly_mrr),r=Te(p.one_off_revenue);if(!c.isValid){N.error(`Invalid MRR: ${c.errors.join(", ")}`),K.log("high","Invalid MRR in deal revenue modal",{dealId:d,value:p.monthly_mrr,errors:c.errors});return}if(!r.isValid){N.error(`Invalid revenue: ${r.errors.join(", ")}`),K.log("high","Invalid revenue in deal revenue modal",{dealId:d,value:p.one_off_revenue,errors:r.errors});return}const i=de(c.value,r.value);if(!i.isValid){N.error(`Invalid calculated lifetime value: ${i.errors.join(", ")}`),K.log("high","Invalid lifetime value calculation in deal revenue modal",{dealId:d,mrr:c.value,revenue:r.value,errors:i.errors});return}const{data:E,error:b}=await re.from("deals").update({monthly_mrr:c.value>0?c.value:null,one_off_revenue:r.value>0?r.value:null,annual_value:i.value>0?i.value:null,updated_at:new Date().toISOString()}).eq("id",d).select().single();if(b)throw G.error("Error updating deal revenue:",b),b;N.success("Deal revenue updated successfully"),I?.(),f()}catch(c){N.error(c.message||"Failed to update deal revenue")}finally{F(!1)}},j=D(p.monthly_mrr,0,{fieldName:"display_mrr",allowZero:!0}),y=D(p.one_off_revenue,0,{fieldName:"display_revenue",allowZero:!0}),_=j*12+y,L=de(j,y),O=c=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(c);return e.jsx(ce,{open:g,onOpenChange:f,children:e.jsxs(oe,{className:"bg-gray-900/95 backdrop-blur-xl border-gray-800/50 text-white p-6 rounded-xl max-w-md",children:[e.jsxs(ee,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5 text-emerald-500"}),"Edit Deal Revenue"]}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Configure revenue breakdown for: ",e.jsx("span",{className:"text-white font-medium",children:l})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-300 flex items-center gap-2",children:[e.jsx(Ve,{className:"w-4 h-4 text-emerald-500"}),"Monthly Recurring Revenue"]}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:p.monthly_mrr,onChange:c=>{const r=D(c.target.value,0,{fieldName:"input_mrr",allowZero:!0});m(i=>({...i,monthly_mrr:r}))},className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"0.00"})]}),j>0&&e.jsxs("p",{className:"text-xs text-gray-500",children:["Annual value: ",O(j*12)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-300 flex items-center gap-2",children:[e.jsx(ne,{className:"w-4 h-4 text-blue-500"}),"One-off Revenue"]}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:p.one_off_revenue,onChange:c=>{const r=D(c.target.value,0,{fieldName:"input_revenue",allowZero:!0});m(i=>({...i,one_off_revenue:r}))},className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"0.00"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-300 flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4 text-purple-500"}),"Lifetime Value (Auto-calculated)"]}),e.jsxs("div",{className:"bg-gray-800/30 border border-gray-700/50 rounded-lg px-3 py-2 text-gray-400",children:[O(L.value),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["(3 √ó Monthly Subscription) + One-off = (",O(j*3),") + ",O(y)]}),!L.isValid&&e.jsxs("div",{className:"text-xs text-red-400 mt-1",children:["‚ö†Ô∏è Calculation errors: ",L.errors.join(", ")]})]})]}),_>0&&e.jsxs("div",{className:"bg-emerald-500/10 border border-emerald-500/20 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-gray-300 mb-1",children:"Total Annual Value"}),e.jsx("div",{className:"text-2xl font-bold text-emerald-400",children:O(_)}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[j>0&&`ARR: ${O(j*12)}`,y>0&&` + One-off: ${O(y)}`]})]})]}),e.jsxs(Se,{children:[e.jsxs(B,{variant:"ghost",onClick:f,disabled:w,className:"bg-gray-800/50 text-gray-300 hover:bg-gray-800",children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsxs(B,{onClick:M,disabled:w||_===0,className:"bg-emerald-500 hover:bg-emerald-600 text-white",children:[w?e.jsx(U.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"}):e.jsx(Pe,{className:"w-4 h-4 mr-2"}),w?"Saving...":"Save Changes"]})]})]})})}function ta({isOpen:g,onClose:f,clientData:d,onSave:l}){const[V,T]=o.useState(!1),[k,I]=o.useState(""),[w,F]=o.useState({monthly_mrr:0,one_off_revenue:0}),[p,m]=o.useState({status:d?.currentStatus||"active",noticeDate:new Date().toISOString().split("T")[0],finalBillingDate:"",churnReason:""});o.useEffect(()=>{if(g&&d&&(m(n=>({...n,status:d.currentStatus})),d.deals&&d.deals.length>0)){const n=d.deals[0];I(n.id),F({monthly_mrr:D(n.monthly_mrr||0,0,{fieldName:"current_mrr",allowZero:!0}),one_off_revenue:D(n.one_off_revenue||0,0,{fieldName:"current_one_off",allowZero:!0})})}},[g,d]);const M=n=>{I(n);const h=d?.deals?.find(P=>P.id===n);h&&F({monthly_mrr:D(h.monthly_mrr||0,0,{fieldName:"selected_mrr",allowZero:!0}),one_off_revenue:D(h.one_off_revenue||0,0,{fieldName:"selected_one_off",allowZero:!0})})},j=[{value:"signed",label:"Signed",icon:be,color:"border-blue-500/50 bg-blue-500/10 text-blue-400",description:"Contract signed, awaiting setup"},{value:"deposit_paid",label:"Deposit Paid",icon:ue,color:"border-yellow-500/50 bg-yellow-500/10 text-yellow-400",description:"Initial payment received"},{value:"active",label:"Active",icon:Y,color:"border-emerald-500/50 bg-emerald-500/10 text-emerald-400",description:"One-off payment received, service active"},{value:"subscribed",label:"Subscribed",icon:Y,color:"border-green-500/50 bg-green-500/10 text-green-400",description:"Monthly subscription active and billing"},{value:"paused",label:"Paused",icon:je,color:"border-orange-500/50 bg-orange-500/10 text-orange-400",description:"Temporarily paused, not billing"},{value:"notice_given",label:"Notice Given",icon:le,color:"border-red-500/50 bg-red-500/10 text-red-400",description:"Client gave notice, awaiting final billing"},{value:"churned",label:"Churned",icon:Ne,color:"border-gray-500/50 bg-gray-500/10 text-gray-400",description:"Subscription ended, no longer billing"}],y=p.status==="notice_given"||p.status==="churned",_=n=>{if(!n)return"";const h=new Date(n);return h.setDate(h.getDate()+30),h.toISOString().split("T")[0]},L=n=>{m(h=>({...h,noticeDate:n,finalBillingDate:n&&!h.finalBillingDate?_(n):h.finalBillingDate}))},O=async()=>{if(!k){N.error("Please select a deal to update");return}T(!0);try{const n=Fe(w.monthly_mrr),h=Te(w.one_off_revenue);if(!n.isValid){N.error(`Invalid MRR: ${n.errors.join(", ")}`),K.log("high","Invalid MRR in client edit modal",{clientId:d.id,value:w.monthly_mrr,errors:n.errors});return}if(!h.isValid){N.error(`Invalid revenue: ${h.errors.join(", ")}`),K.log("high","Invalid revenue in client edit modal",{clientId:d.id,value:w.one_off_revenue,errors:h.errors});return}const P=de(n.value,h.value);if(!P.isValid){N.error(`Invalid calculated lifetime value: ${P.errors.join(", ")}`),K.log("high","Invalid lifetime value calculation in client edit modal",{clientId:d.id,mrr:n.value,revenue:h.value,errors:P.errors});return}const{error:C}=await re.from("deals").update({monthly_mrr:n.value>0?n.value:null,one_off_revenue:h.value>0?h.value:null,annual_value:P.value>0?P.value:null,updated_at:new Date().toISOString()}).eq("id",k);if(C)throw G.error("Error updating deal revenue:",C),C;let se=null;n.value>0?(d.currentStatus==="signed"||d.currentStatus==="active")&&(se="subscribed"):h.value>0&&d.currentStatus==="signed"&&(se="active");const z=p.status!==d.currentStatus?p.status:se;if(z&&z!==d.currentStatus){const Z={status:z,updated_at:new Date().toISOString()};(z==="notice_given"||z==="churned")&&(Z.notice_given_date=p.noticeDate,Z.final_billing_date=p.finalBillingDate,p.churnReason&&(Z.churn_reason=p.churnReason),z==="churned"&&(Z.churn_date=new Date().toISOString()));const{error:Q}=await re.from("clients").update(Z).eq("id",d.id);Q&&(G.error("Error updating client status:",Q),N.warning("Revenue updated successfully, but client status update failed"))}N.success("Client information updated successfully"),l?.(),f()}catch(n){N.error(n.message||"Failed to update client information")}finally{T(!1)}},c=D(w.monthly_mrr,0,{fieldName:"display_mrr",allowZero:!0}),r=D(w.one_off_revenue,0,{fieldName:"display_revenue",allowZero:!0}),i=c*12,E=de(c,r),b=n=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(n);return d?e.jsx(ce,{open:g,onOpenChange:f,children:e.jsxs(oe,{className:"bg-gray-900/95 backdrop-blur-xl border-gray-800/50 text-white p-6 rounded-xl max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ee,{children:[e.jsxs(ae,{className:"flex items-center gap-2",children:[e.jsx(De,{className:"w-5 h-5 text-emerald-500"}),"Edit Client Information"]}),e.jsxs("p",{className:"text-sm text-gray-400",children:["Manage revenue and status for: ",e.jsx("span",{className:"text-white font-medium",children:d.name})]})]}),e.jsxs("div",{className:"space-y-6",children:[d.deals&&d.deals.length>1&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Select Deal to Edit"}),e.jsx("div",{className:"grid grid-cols-1 gap-2",children:d.deals.map(n=>e.jsxs("button",{onClick:()=>M(n.id),className:q("p-3 rounded-lg border-2 text-left transition-colors",k===n.id?"border-emerald-500/50 bg-emerald-500/10 text-emerald-400":"border-gray-700/50 bg-gray-800/50 text-gray-300 hover:border-gray-600/50"),children:[e.jsx("div",{className:"font-medium",children:n.name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["MRR: ",b(n.monthly_mrr||0)," ‚Ä¢ One-off: ",b(n.one_off_revenue||0)]})]},n.id))})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white border-b border-gray-700 pb-2",children:"Revenue Information"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-300 flex items-center gap-2",children:[e.jsx(Ve,{className:"w-4 h-4 text-emerald-500"}),"Monthly Subscription Revenue"]}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:w.monthly_mrr,onChange:n=>{const h=D(n.target.value,0,{fieldName:"input_mrr",allowZero:!0});F(P=>({...P,monthly_mrr:h}))},className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",placeholder:"0.00"})]}),c>0&&e.jsxs("p",{className:"text-xs text-gray-500",children:["ARR: ",b(i)]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-300 flex items-center gap-2",children:[e.jsx(ne,{className:"w-4 h-4 text-blue-500"}),"One-off Revenue"]}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:w.one_off_revenue,onChange:n=>{const h=D(n.target.value,0,{fieldName:"input_revenue",allowZero:!0});F(P=>({...P,one_off_revenue:h}))},className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg pl-10 pr-4 py-2 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"0.00"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm font-medium text-gray-300 flex items-center gap-2",children:[e.jsx(we,{className:"w-4 h-4 text-purple-500"}),"Lifetime Value (Auto-calculated)"]}),e.jsxs("div",{className:"bg-gray-800/30 border border-gray-700/50 rounded-lg px-3 py-2 text-gray-400",children:[b(E.value),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["(3 √ó Monthly Subscription) + One-off = (",b(c*3),") + ",b(r)]}),!E.isValid&&e.jsxs("div",{className:"text-xs text-red-400 mt-1",children:["‚ö†Ô∏è Calculation errors: ",E.errors.join(", ")]})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white border-b border-gray-700 pb-2",children:"Client Status"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Current Status"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:j.map(n=>{const h=p.status===n.value,P=n.icon;return e.jsxs("button",{onClick:()=>m(C=>({...C,status:n.value})),className:q("p-3 rounded-lg border-2 transition-colors text-left",h?n.color:"border-gray-700/50 bg-gray-800/50 text-gray-400 hover:border-gray-600/50"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(P,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:n.label})]}),e.jsx("div",{className:"text-xs opacity-80",children:n.description})]},n.value)})})]}),y&&e.jsxs("div",{className:"space-y-4 bg-red-500/5 border border-red-500/20 rounded-lg p-4",children:[e.jsx("h4",{className:"text-sm font-medium text-red-300",children:"Churn Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Notice Date"}),e.jsx("input",{type:"date",value:p.noticeDate,onChange:n=>L(n.target.value),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Final Billing Date"}),e.jsx("input",{type:"date",value:p.finalBillingDate,onChange:n=>m(h=>({...h,finalBillingDate:n.target.value})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-red-500 focus:border-transparent"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm text-gray-300",children:"Churn Reason (Optional)"}),e.jsx("textarea",{value:p.churnReason,onChange:n=>m(h=>({...h,churnReason:n.target.value})),placeholder:"Reason for cancellation...",className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none",rows:3})]})]})]})]}),e.jsxs(Se,{children:[e.jsxs(B,{variant:"ghost",onClick:f,disabled:V,className:"bg-gray-800/50 text-gray-300 hover:bg-gray-800",children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"Cancel"]}),e.jsxs(B,{onClick:O,disabled:V||!k,className:"bg-emerald-500 hover:bg-emerald-600 text-white",children:[V?e.jsx(U.div,{animate:{rotate:360},transition:{duration:1,repeat:1/0,ease:"linear"},className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"}):e.jsx(Pe,{className:"w-4 h-4 mr-2"}),V?"Saving...":"Save Changes"]})]})]})}):null}function ra(g){return g.toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"")}function $e(g,f=!0){const d=ra(g),l=`/companies/${encodeURIComponent(d)}`;f?window.open(l,"_blank"):window.location.href=l}const la=({className:g})=>{const{userData:f}=Ie(),[d,l]=o.useState(f?.id),{aggregatedClients:V,isLoading:T,error:k,refreshAggregatedClients:I}=Ue(d);We();const[w,F]=o.useState(!1),[p,m]=o.useState(null),[M,j]=o.useState(null),[y,_]=o.useState(null),[L,O]=o.useState(null),[c,r]=o.useState(null),[i,E]=o.useState({searchQuery:"",status:void 0,minValue:void 0,maxValue:void 0,hasSubscriptions:void 0});o.useEffect(()=>{f?.id&&d===void 0&&l(f.id)},[f?.id,d]);const b=o.useMemo(()=>V.filter(s=>{const S=!i.searchQuery||s.client_name?.toLowerCase().includes(i.searchQuery.toLowerCase())||s.sales_rep?.toLowerCase().includes(i.searchQuery.toLowerCase())||s.contact_identifier?.toLowerCase().includes(i.searchQuery.toLowerCase()),H=!i.status||s.status===i.status,a=!i.minValue||s.total_lifetime_value>=i.minValue,u=!i.maxValue||s.total_lifetime_value<=i.maxValue,A=i.hasSubscriptions===void 0||(i.hasSubscriptions?s.active_subscriptions>0:s.active_subscriptions===0);return S&&H&&a&&u&&A}),[V,i]),n=o.useCallback(s=>{switch(s){case"active":return"text-emerald-400 bg-emerald-500/10 border-emerald-500/20";case"subscribed":return"text-green-400 bg-green-500/10 border-green-500/20";case"signed":return"text-blue-400 bg-blue-500/10 border-blue-500/20";case"deposit_paid":return"text-yellow-400 bg-yellow-500/10 border-yellow-500/20";case"paused":return"text-orange-400 bg-orange-500/10 border-orange-500/20";case"notice_given":return"text-red-400 bg-red-500/10 border-red-500/20";case"churned":return"text-gray-400 bg-gray-500/10 border-gray-500/20";default:return"text-gray-400 bg-gray-500/10 border-gray-500/20"}},[]),h=o.useCallback(s=>{switch(s){case"active":return Y;case"subscribed":return Y;case"signed":return be;case"deposit_paid":return ue;case"paused":return je;case"notice_given":return le;case"churned":return Ne;default:return le}},[]),P=o.useCallback(s=>{switch(s){case"active":return"Active";case"subscribed":return"Subscribed";case"signed":return"Signed";case"deposit_paid":return"Deposit Paid";case"paused":return"Paused";case"notice_given":return"Notice Given";case"churned":return"Churned";default:return s||"Unknown"}},[]),C=o.useCallback(s=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(s),[]),se=o.useCallback(()=>{E({searchQuery:"",status:void 0,minValue:void 0,maxValue:void 0,hasSubscriptions:void 0}),l(f?.id)},[f?.id]);o.useCallback(s=>{m({clientName:s.client_name,currentStatus:s.status,dealId:s.deals[0]?.id})},[]);const z=o.useCallback(s=>{s.deals&&s.deals.length>0?r({id:s.id,name:s.client_name,currentStatus:s.status,deals:s.deals.map(S=>({id:S.id,name:S.name,monthly_mrr:S.monthly_mrr,one_off_revenue:S.one_off_revenue,annual_value:S.annual_value}))}):N.error("No deals found for this client")},[]),Z=o.useCallback(s=>{_({id:s.id,name:s.name,monthly_mrr:s.monthly_mrr,one_off_revenue:s.one_off_revenue,annual_value:s.annual_value}),O(null)},[]),pe=async(s,S)=>{if(p)try{N.success("Client status updated successfully"),await I(),m(null)}catch{N.error("Failed to update client status")}},Q=o.useMemo(()=>{const s=b.length,S=b.reduce((x,R)=>x+R.total_lifetime_value,0),H=b.reduce((x,R)=>x+R.total_monthly_mrr,0),a=b.filter(x=>x.status==="active"||x.status==="subscribed").length,u=b.filter(x=>x.active_subscriptions>0).length,A=b.filter(x=>x.status==="churned").length,t=b.reduce((x,R)=>x+(R.total_churn_amount||0),0),v=b.reduce((x,R)=>x+(R.remaining_revenue_estimate||0),0);return{totalClients:s,totalValue:S,totalMRR:H,activeClients:a,subscriptionClients:u,churnedClients:A,totalChurnAmount:t,remainingRevenue:v}},[b]);return T?e.jsx("div",{className:q("bg-gray-900/50 backdrop-blur-xl rounded-xl p-6 border border-gray-800/50",g),children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-700 rounded w-1/4"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(s=>e.jsx("div",{className:"h-12 bg-gray-700 rounded"},s))})]})}):k?e.jsx("div",{className:q("bg-gray-900/50 backdrop-blur-xl rounded-xl p-6 border border-gray-800/50",g),children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"text-red-400 mb-2",children:"Error loading clients"}),e.jsx("div",{className:"text-gray-400",children:k}),e.jsx(B,{onClick:I,className:"mt-4",variant:"outline",children:"Retry"})]})}):e.jsxs("div",{className:q("space-y-6",g),children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-7 gap-4",children:[e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:Q.totalClients}),e.jsx("div",{className:"text-sm text-gray-400",children:"Total Clients"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:C(Q.totalValue)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Total Value"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-400",children:C(Q.totalMRR)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Monthly MRR"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:Q.activeClients}),e.jsx("div",{className:"text-sm text-gray-400",children:"Active"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-400",children:Q.subscriptionClients}),e.jsx("div",{className:"text-sm text-gray-400",children:"Subscriptions"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-red-400",children:Q.churnedClients}),e.jsx("div",{className:"text-sm text-gray-400",children:"Churned"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-red-400",children:C(Q.totalChurnAmount)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Churn Value"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Client Overview"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Aggregated view of all clients with totals and status"})]}),e.jsxs(B,{variant:"outline",onClick:()=>F(!w),className:"bg-gray-800/50 border-gray-700/50 text-white hover:bg-gray-700/50",children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Filters",(i.status||i.searchQuery||i.minValue||i.maxValue||i.salesRep||i.hasSubscriptions!==void 0)&&e.jsx("span",{className:"ml-2 bg-emerald-500 text-white text-xs rounded-full px-2 py-0.5",children:"Active"})]})]}),e.jsx(ye,{children:w&&e.jsx(U.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl p-6 border border-gray-800/50 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(Le,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search client name, sales rep, or contact...",value:i.searchQuery,onChange:s=>E(S=>({...S,searchQuery:s.target.value})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg pl-10 pr-4 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Status"}),e.jsxs("select",{value:i.status||"all",onChange:s=>E(S=>({...S,status:s.target.value==="all"?void 0:s.target.value})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"signed",children:"Signed"}),e.jsx("option",{value:"deposit_paid",children:"Deposit Paid"}),e.jsx("option",{value:"paused",children:"Paused"}),e.jsx("option",{value:"notice_given",children:"Notice Given"}),e.jsx("option",{value:"churned",children:"Churned"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Subscriptions"}),e.jsxs("select",{value:i.hasSubscriptions===void 0?"all":i.hasSubscriptions?"yes":"no",onChange:s=>E(S=>({...S,hasSubscriptions:s.target.value==="all"?void 0:s.target.value==="yes"})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Clients"}),e.jsx("option",{value:"yes",children:"Has Subscriptions"}),e.jsx("option",{value:"no",children:"No Subscriptions"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Sales Rep"}),e.jsx(Xe,{selectedOwnerId:d,onOwnerChange:l,className:"w-full"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Min Value (¬£)"}),e.jsx("input",{type:"number",placeholder:"0",value:i.minValue||"",onChange:s=>E(S=>({...S,minValue:s.target.value?D(s.target.value,0,{fieldName:"filter_min_value",allowZero:!0}):void 0})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Max Value (¬£)"}),e.jsx("input",{type:"number",placeholder:"100000",value:i.maxValue||"",onChange:s=>E(S=>({...S,maxValue:s.target.value?D(s.target.value,0,{fieldName:"filter_max_value",allowZero:!0}):void 0})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]})]}),(i.status||i.searchQuery||i.minValue||i.maxValue||i.hasSubscriptions!==void 0||d!==f?.id)&&e.jsxs(B,{variant:"ghost",size:"sm",onClick:se,className:"text-gray-400 hover:text-white",children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"Clear All Filters"]})]})})})]}),e.jsx("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl border border-gray-800/50 overflow-hidden",children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-800/50",children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Client"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Deals Count"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Deal Value"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"One-off Total"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Monthly MRR"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Subscriptions"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Last Payment"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Sales Rep"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Actions"})]})}),e.jsx("tbody",{children:b.map((s,S)=>{const H=h(s.status);return e.jsxs(U.tr,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2,delay:S*.02},className:"border-b border-gray-800/50 hover:bg-gray-800/20",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-gray-800/50 flex items-center justify-center",children:e.jsx(ge,{className:"w-4 h-4 text-gray-400"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-white flex items-center gap-2",children:[s.client_name,e.jsx("button",{onClick:a=>{a.stopPropagation(),$e(s.client_name)},className:"text-blue-400 hover:text-blue-300 transition-colors",title:"View company profile",children:e.jsx(ge,{className:"w-3 h-3"})})]}),e.jsx("div",{className:"text-xs text-gray-400",children:s.contact_identifier&&e.jsx("span",{children:s.contact_identifier})})]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:q("inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border",n(s.status)),children:[e.jsx(H,{className:"w-3 h-3"}),P(s.status)]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm font-medium text-white",children:s.total_payments_count})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm font-medium text-white",children:C(s.total_lifetime_value)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm font-medium text-blue-400",children:C(s.total_one_off)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"text-sm font-medium text-emerald-400",children:[C(s.total_monthly_mrr),s.total_monthly_mrr>0&&e.jsx("span",{className:"text-xs text-gray-400",children:"/mo"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm font-medium text-purple-400",children:s.active_subscriptions})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm text-white",children:s.last_payment_date?W(new Date(s.last_payment_date),"MMM d, yyyy"):"N/A"})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center",children:e.jsx("span",{className:"text-xs font-medium text-emerald-500",children:s.sales_rep?.split(" ").map(a=>a[0]).join("")||"??"})}),e.jsx("span",{className:"text-sm text-white",children:s.sales_rep})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>j(s),className:"p-2 hover:bg-blue-500/20 rounded-lg transition-colors text-gray-400 hover:text-blue-500",title:"View client details and payment history",children:e.jsx(Ye,{className:"w-4 h-4"})}),e.jsx(U.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>z(s),className:"p-2 hover:bg-[#37bd7e]/20 rounded-lg transition-colors text-gray-400 hover:text-[#37bd7e]",title:"Edit client revenue, status, and details",children:e.jsx(De,{className:"w-4 h-4"})})]})})]},s.id)})})]}),b.length===0&&e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"text-gray-400",children:V.length===0?"No clients found.":"No clients match your filters."})})]})}),e.jsx(Ee,{isOpen:!!p,onClose:()=>m(null),clientName:p?.clientName||"",currentStatus:p?.currentStatus||"active",onSave:pe}),e.jsx(ce,{open:!!M,onOpenChange:()=>j(null),children:e.jsxs(oe,{className:"max-w-4xl max-h-[80vh] overflow-y-auto bg-gray-900 border-gray-800",children:[e.jsx(ee,{children:e.jsxs(ae,{className:"text-white",children:[M?.client_name," - Payment History"]})}),M&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-gray-800/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-lg font-bold text-white",children:M.total_payments_count}),e.jsx("div",{className:"text-sm text-gray-400",children:"Total Deals"})]}),e.jsxs("div",{className:"bg-gray-800/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-lg font-bold text-white",children:C(M.total_lifetime_value)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Deal Value"})]}),e.jsxs("div",{className:"bg-gray-800/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-lg font-bold text-emerald-400",children:C(M.total_monthly_mrr)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Monthly MRR"})]}),e.jsxs("div",{className:"bg-gray-800/50 rounded-lg p-4",children:[e.jsx("div",{className:"text-lg font-bold text-purple-400",children:M.active_subscriptions}),e.jsx("div",{className:"text-sm text-gray-400",children:"Subscriptions"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-white",children:"Deal History"}),e.jsx("div",{className:"space-y-3",children:M.deals.map(s=>e.jsxs("div",{className:"bg-gray-800/50 rounded-lg p-4 border border-gray-700/50",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-400",children:[s.deal_type==="subscription"?"Subscription":"One-off"," ‚Ä¢ Signed: ",W(new Date(s.signed_date),"MMM d, yyyy")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-white",children:C(s.value)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Total Value"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-3 pt-3 border-t border-gray-700/50",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-blue-400",children:C(s.one_off_revenue||0)}),e.jsx("div",{className:"text-xs text-gray-400",children:"One-off"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm text-emerald-400",children:[C(s.monthly_mrr||0),(s.monthly_mrr||0)>0&&e.jsx("span",{className:"text-xs",children:"/mo"})]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Monthly MRR"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-purple-400",children:C(s.annual_value||0)}),e.jsx("div",{className:"text-xs text-gray-400",children:"Annual Value"})]})]})]},s.id))})]})]})]})}),e.jsx(Be,{isOpen:!!y,onClose:()=>_(null),dealId:y?.id||null,dealName:y?.name||"",currentMRR:y?.monthly_mrr,currentOneOff:y?.one_off_revenue,currentAnnualValue:y?.annual_value,onSave:async()=>{await I(),_(null),N.success("Deal revenue updated successfully")}}),e.jsx(ta,{isOpen:!!c,onClose:()=>r(null),clientData:c,onSave:async()=>{await I(),r(null),N.success("Client updated successfully")}}),e.jsx(ce,{open:!!L,onOpenChange:()=>O(null),children:e.jsxs(oe,{className:"max-w-2xl bg-gray-900 border-gray-800",children:[e.jsx(ee,{children:e.jsxs(ae,{className:"text-white",children:["Select Deal to Edit - ",L?.client_name]})}),L&&e.jsxs("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:[e.jsx("p",{className:"text-sm text-gray-400",children:"This client has multiple deals. Select which deal you'd like to edit:"}),e.jsx("div",{className:"space-y-3",children:L.deals.map(s=>e.jsxs("div",{className:"bg-gray-800/50 rounded-lg p-4 border border-gray-700/50 cursor-pointer hover:bg-gray-800/70 transition-colors",onClick:()=>Z(s),children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:s.name}),e.jsxs("div",{className:"text-sm text-gray-400",children:[s.deal_type==="subscription"?"Subscription":"One-off"," ‚Ä¢ Signed: ",W(new Date(s.signed_date),"MMM d, yyyy")]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-medium text-white",children:C(s.value)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Total Value"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mt-3 pt-3 border-t border-gray-700/50",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-blue-400",children:C(s.one_off_revenue||0)}),e.jsx("div",{className:"text-xs text-gray-400",children:"One-off"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm text-emerald-400",children:[C(s.monthly_mrr||0),(s.monthly_mrr||0)>0&&e.jsx("span",{className:"text-xs",children:"/mo"})]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Monthly MRR"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-purple-400",children:C(s.annual_value||0)}),e.jsx("div",{className:"text-xs text-gray-400",children:"Annual Value"})]})]})]},s.id))})]})]})})]})},na=ke.memo(la);function ia({isOpen:g,onClose:f,dealId:d}){const[l,V]=o.useState(null),[T,k]=o.useState(!1);o.useEffect(()=>{g&&d&&I()},[g,d]);const I=async()=>{if(d){k(!0);try{G.log("üîç Fetching deal details for ID:",d);const{data:m,error:M}=await re.from("deals").select("*").eq("id",d).single();if(M){G.error("Error fetching basic deal data:",M),G.error("Deal ID attempted:",d),M.code==="PGRST116"?N.error("Deal not found or you do not have access to it"):N.error(`Failed to load deal: ${M.message}`);return}G.log("‚úÖ Basic deal data found:",m);try{const{data:j,error:y}=await re.from("deals").select(`
            *,
            profiles:owner_id (
              first_name,
              last_name,
              email
            ),
            deal_stages!inner (
              name,
              color
            )
          `).eq("id",d).single();if(y){if(G.warn("Could not fetch enriched deal data, using basic data:",y),m.stage_id)try{const{data:_}=await re.from("deal_stages").select("name, color").eq("id",m.stage_id).single();_&&(m.deal_stages=_)}catch(_){G.warn("Could not fetch stage data:",_)}V(m)}else G.log("‚úÖ Enriched deal data found:",j),V(j)}catch(j){if(G.warn("Error with enriched query, using basic data:",j),m.stage_id)try{const{data:y}=await re.from("deal_stages").select("name, color").eq("id",m.stage_id).single();y&&(m.deal_stages=y)}catch(y){G.warn("Could not fetch stage data:",y)}V(m)}}catch(m){m.message&&m.message.includes("<!DOCTYPE")?N.error("Server error: Please try again later"):N.error("Failed to load deal details")}finally{k(!1)}}},w=m=>m?new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(m):"¬£0",F=m=>{switch(m?.toLowerCase()){case"high":return"text-red-400 bg-red-500/10 border-red-500/20";case"medium":return"text-orange-400 bg-orange-500/10 border-orange-500/20";case"low":return"text-green-400 bg-green-500/10 border-green-500/20";default:return"text-gray-400 bg-gray-500/10 border-gray-500/20"}},p=m=>{switch(m?.toLowerCase()){case"won":return"text-emerald-400 bg-emerald-500/10 border-emerald-500/20";case"lost":return"text-red-400 bg-red-500/10 border-red-500/20";case"active":case"in_progress":return"text-blue-400 bg-blue-500/10 border-blue-500/20";default:return"text-gray-400 bg-gray-500/10 border-gray-500/20"}};return g?e.jsx(ce,{open:g,onOpenChange:f,children:e.jsx(oe,{className:"bg-gray-900/95 backdrop-blur-xl border-gray-800/50 text-white p-0 rounded-xl max-w-4xl max-h-[90vh] overflow-hidden",children:T?e.jsxs(e.Fragment,{children:[e.jsxs(ee,{className:"p-6",children:[e.jsx(ae,{className:"text-xl font-bold text-white",children:"Loading Deal Details"}),e.jsx(fe,{className:"text-gray-400",children:"Please wait while we fetch the deal information..."})]}),e.jsx("div",{className:"p-8",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-gray-700 rounded w-1/2"}),e.jsx("div",{className:"h-4 bg-gray-700 rounded w-1/4"}),e.jsx("div",{className:"grid grid-cols-2 gap-4 mt-6",children:[1,2,3,4].map(m=>e.jsx("div",{className:"h-20 bg-gray-700 rounded"},m))})]})})]}):l?e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"p-6 pb-4 border-b border-gray-800/50",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx(ae,{className:"text-2xl font-bold text-white mb-2",children:l.name}),e.jsxs(fe,{className:"text-gray-400",children:["Deal details and financial information for ",l.company]}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-400",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(ge,{className:"w-4 h-4"}),e.jsx("span",{children:l.company})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(we,{className:"w-4 h-4"}),e.jsxs("span",{children:["Created ",W(new Date(l.created_at),"MMM d, yyyy")]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l.status&&e.jsx("div",{className:`px-3 py-1 rounded-full text-xs font-medium border ${p(l.status)}`,children:l.status.replace("_"," ").toUpperCase()}),l.priority&&e.jsx("div",{className:`px-3 py-1 rounded-full text-xs font-medium border ${F(l.priority)}`,children:l.priority.toUpperCase()})]})]})}),e.jsxs("div",{className:"p-6 max-h-[60vh] overflow-y-auto",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-8",children:[e.jsxs("div",{className:"bg-gray-800/50 rounded-xl p-4 border border-gray-700/50",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(ue,{className:"w-4 h-4 text-emerald-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-400",children:"Total Value"})]}),e.jsx("div",{className:"text-2xl font-bold text-white",children:w(l.value)})]}),l.monthly_mrr&&l.monthly_mrr>0&&e.jsxs("div",{className:"bg-gray-800/50 rounded-xl p-4 border border-gray-700/50",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ve,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-400",children:"Monthly MRR"})]}),e.jsx("div",{className:"text-2xl font-bold text-white",children:w(l.monthly_mrr)}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Annual: ",w(l.monthly_mrr*12)]})]}),l.one_off_revenue&&l.one_off_revenue>0&&e.jsxs("div",{className:"bg-gray-800/50 rounded-xl p-4 border border-gray-700/50",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Je,{className:"w-4 h-4 text-orange-500"}),e.jsx("span",{className:"text-sm font-medium text-gray-400",children:"One-off Revenue"})]}),e.jsx("div",{className:"text-2xl font-bold text-white",children:w(l.one_off_revenue)})]})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[e.jsx(Ke,{className:"w-5 h-5"}),"Contact Information"]}),e.jsx("div",{className:"bg-gray-800/50 rounded-xl p-4 border border-gray-700/50",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[l.contact_name&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Contact Name"}),e.jsx("div",{className:"text-white",children:l.contact_name})]}),l.contact_email&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm text-gray-400 mb-1 flex items-center gap-1",children:[e.jsx(ea,{className:"w-3 h-3"}),"Email"]}),e.jsx("div",{className:"text-white",children:e.jsx("a",{href:`mailto:${l.contact_email}`,className:"text-blue-400 hover:text-blue-300",children:l.contact_email})})]}),l.contact_phone&&e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm text-gray-400 mb-1 flex items-center gap-1",children:[e.jsx(aa,{className:"w-3 h-3"}),"Phone"]}),e.jsx("div",{className:"text-white",children:e.jsx("a",{href:`tel:${l.contact_phone}`,className:"text-blue-400 hover:text-blue-300",children:l.contact_phone})})]}),l.profiles&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Deal Owner"}),e.jsxs("div",{className:"text-white",children:[l.profiles.first_name," ",l.profiles.last_name]})]})]})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("h3",{className:"text-lg font-semibold text-white mb-4 flex items-center gap-2",children:[e.jsx(sa,{className:"w-5 h-5"}),"Deal Details"]}),e.jsxs("div",{className:"bg-gray-800/50 rounded-xl p-4 border border-gray-700/50",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[l.deal_size&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Deal Size"}),e.jsx("div",{className:"text-white capitalize",children:l.deal_size.replace("_"," ")})]}),l.expected_close_date&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Expected Close Date"}),e.jsx("div",{className:"text-white",children:W(new Date(l.expected_close_date),"MMM d, yyyy")})]}),l.first_billing_date&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"First Billing Date"}),e.jsx("div",{className:"text-white",children:W(new Date(l.first_billing_date),"MMM d, yyyy")})]}),l.deal_stages&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-1",children:"Current Stage"}),e.jsx("div",{className:"text-white",children:l.deal_stages.name})]})]}),l.description&&e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-gray-400 mb-2",children:"Description"}),e.jsx("div",{className:"text-white text-sm leading-relaxed",children:l.description})]})]})]}),e.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3"}),e.jsxs("span",{children:["Created: ",W(new Date(l.created_at),"MMM d, yyyy HH:mm")]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3"}),e.jsxs("span",{children:["Last Updated: ",W(new Date(l.updated_at),"MMM d, yyyy HH:mm")]})]}),l.stage_changed_at&&e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ce,{className:"w-3 h-3"}),e.jsxs("span",{children:["Stage Changed: ",W(new Date(l.stage_changed_at),"MMM d, yyyy HH:mm")]})]})]})]}),e.jsx(Se,{className:"p-6 pt-4 border-t border-gray-800/50",children:e.jsxs(B,{variant:"ghost",onClick:f,className:"bg-gray-800/50 text-gray-300 hover:bg-gray-800",children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"Close"]})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(ee,{className:"p-6",children:[e.jsx(ae,{className:"text-xl font-bold text-white",children:"Deal Not Found"}),e.jsx(fe,{className:"text-gray-400",children:"The requested deal could not be found or you don't have permission to view it."})]}),e.jsx("div",{className:"p-8 text-center",children:e.jsx("div",{className:"text-gray-400",children:"Deal not found"})})]})})}):null}const da=({className:g})=>{const{userData:f}=Ie(),{users:d}=Ze(),{activities:l}=Qe(),{deals:V,refreshDeals:T}=Ge(f?.id),{clients:k,updateClient:I,createClient:w,isLoading:F}=He(f?.id),{fetchMRRSummary:p}=qe(f?.id),[m,M]=o.useState(!1),[j,y]=o.useState(null),[_,L]=o.useState(null),[O,c]=o.useState(null),[r,i]=o.useState({searchQuery:"",dealType:void 0,minValue:void 0,maxValue:void 0,salesRep:void 0,status:void 0,dateFrom:void 0,dateTo:void 0,owner:void 0}),E=o.useCallback(a=>{if(!a||a==="Unknown")return"Unknown";const u=d.find(t=>t.id===a);return u?[u.first_name,u.last_name].filter(Boolean).join(" ")||u.email||`User ${a.slice(0,8)}`:/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(a)?`User ${a.slice(0,8)}`:a},[d]),b=o.useMemo(()=>{if(F||!k||!l)return[];const a=k.map(t=>{const v=t.deal_id?V?.find(ie=>ie.id===t.deal_id):null;let x="one-off";t.subscription_amount&&t.subscription_amount>0?x="subscription":x="one-off";const R=D(v?.one_off_revenue||0,0,{fieldName:"one_off_revenue",allowZero:!0}),$=D(v?.monthly_mrr||t.subscription_amount||0,0,{fieldName:"monthly_mrr",allowZero:!0}),me=D(v?.annual_value||0,0,{fieldName:"annual_value",allowZero:!0}),X=de($,R),xe=X.value;X.isValid||K.log("medium","Lifetime value calculation issues for payment record",{paymentRecord:t.company_name,errors:X.errors,monthlyMRR:$,oneOffRevenue:R,dealId:v?.id});let J="Unknown",te=new Date().toISOString();const ve=l.find(ie=>t.deal_id&&ie.deal_id===t.deal_id||ie.client_name?.toLowerCase()===t.company_name?.toLowerCase()&&ie.type==="sale"&&ie.status==="completed");ve?.sales_rep?(J=ve.sales_rep,te=ve.date):(v?.created_at?te=v.created_at:t.subscription_start_date?te=t.subscription_start_date:t.created_at&&(te=t.created_at),v?.assigned_to?J=v.assigned_to:v?.owner_id?J=v.owner_id:t.contact_name?J=t.contact_name:t.owner_id&&(J=t.owner_id));const _e=E(J);return{id:t.id,client_id:t.id,client_name:t.company_name,deal_name:v?.name||"No Deal Link",deal_value:xe,deal_type:x,signed_date:te,sales_rep:_e,contact_identifier:t.contact_email||t.contact_name,details:`Payment: ${t.company_name} | Type: ${x} | Status: ${t.status}`,deal_id:t.deal_id,status:t.status||"signed",lifetime_deal_value:xe,one_off_revenue:R,monthly_mrr:$,annual_value:me}}),u=l.filter(t=>t.type==="sale"&&t.status==="completed"&&t.client_name&&t.client_name.trim()!=="").filter(t=>!k.some(x=>t.deal_id&&x.deal_id===t.deal_id||x.company_name?.toLowerCase()===t.client_name?.toLowerCase())).map(t=>{const v=t.deal_id?V?.find(_e=>_e.id===t.deal_id):null;let x="one-off";(t.details?.toLowerCase().includes("subscription")||t.details?.toLowerCase().includes("recurring")||t.details?.toLowerCase().includes("monthly"))&&(x="subscription");const R=D(v?.one_off_revenue||x==="one-off"&&t.amount||0,0,{fieldName:"standalone_one_off_revenue",allowZero:!0}),$=D(v?.monthly_mrr||x==="subscription"&&t.amount||0,0,{fieldName:"standalone_monthly_mrr",allowZero:!0}),me=D(v?.annual_value||0,0,{fieldName:"standalone_annual_value",allowZero:!0}),X=de($,R),xe=X.value;X.isValid||K.log("medium","Lifetime value calculation issues for standalone activity",{activityId:t.id,clientName:t.client_name,errors:X.errors,monthlyMRR:$,oneOffRevenue:R,activityAmount:t.amount});let J=t.sales_rep||v?.assigned_to||v?.owner_id||"Unknown";const te=E(J);return{id:`activity-${t.id}`,client_id:t.id,client_name:t.client_name,deal_name:v?.name||"Standalone Activity",deal_value:xe,deal_type:x,signed_date:t.date,sales_rep:te,contact_identifier:t.contact_name||t.client_name,details:`Activity: ${t.details||"Sale"} | Type: ${x} | Amount: ¬£${t.amount||0}`,deal_id:t.deal_id,status:"signed",lifetime_deal_value:xe,one_off_revenue:R,monthly_mrr:$,annual_value:me}});return[...a,...u].sort((t,v)=>new Date(v.signed_date).getTime()-new Date(t.signed_date).getTime())},[k,V,l,F,E]),n=o.useMemo(()=>b.filter(a=>{const u=!r.searchQuery||a.client_name?.toLowerCase().includes(r.searchQuery.toLowerCase())||a.sales_rep?.toLowerCase().includes(r.searchQuery.toLowerCase())||a.deal_name?.toLowerCase().includes(r.searchQuery.toLowerCase()),A=!r.dealType||a.deal_type===r.dealType,t=!r.minValue||a.deal_value>=r.minValue,v=!r.maxValue||a.deal_value<=r.maxValue,x=!r.salesRep||a.sales_rep===r.salesRep,R=!r.status||a.status===r.status,$=!r.dateFrom||new Date(a.signed_date)>=new Date(r.dateFrom),me=!r.dateTo||new Date(a.signed_date)<=new Date(r.dateTo),X=!r.owner||a.sales_rep?.toLowerCase().includes(r.owner.toLowerCase());return u&&A&&t&&v&&x&&R&&$&&me&&X}),[b,r]),h=a=>{switch(a){case"subscription":return"text-emerald-400 bg-emerald-500/10 border-emerald-500/20";case"one-off":return"text-blue-400 bg-blue-500/10 border-blue-500/20";default:return"text-gray-400 bg-gray-500/10 border-gray-500/20"}},P=a=>{switch(a){case"subscription":return Y;case"one-off":return ue;default:return le}},C=a=>{switch(a){case"active":return"text-emerald-400 bg-emerald-500/10 border-emerald-500/20";case"subscribed":return"text-green-400 bg-green-500/10 border-green-500/20";case"signed":return"text-blue-400 bg-blue-500/10 border-blue-500/20";case"deposit_paid":return"text-yellow-400 bg-yellow-500/10 border-yellow-500/20";case"paused":return"text-orange-400 bg-orange-500/10 border-orange-500/20";case"notice_given":return"text-red-400 bg-red-500/10 border-red-500/20";case"churned":return"text-gray-400 bg-gray-500/10 border-gray-500/20";default:return"text-gray-400 bg-gray-500/10 border-gray-500/20"}},se=a=>{switch(a){case"active":return Y;case"subscribed":return Y;case"signed":return be;case"deposit_paid":return ue;case"paused":return je;case"notice_given":return le;case"churned":return Ne;default:return le}},z=a=>{switch(a){case"active":return"Active";case"subscribed":return"Subscribed";case"signed":return"Signed";case"deposit_paid":return"Deposit Paid";case"paused":return"Paused";case"notice_given":return"Notice Given";case"churned":return"Churned";default:return a||"Unknown"}},Z=o.useCallback(a=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(a),[]),pe=o.useCallback(()=>{i({searchQuery:"",dealType:void 0,minValue:void 0,maxValue:void 0,salesRep:void 0,status:void 0,dateFrom:void 0,dateTo:void 0,owner:void 0})},[]),Q=a=>{if(!a.deal_id||!a.deal_name){N.error("No deal linked to this payment");return}y({id:a.deal_id,name:a.deal_name,monthly_mrr:a.monthly_mrr,one_off_revenue:a.one_off_revenue,annual_value:a.annual_value})},s=a=>{const u=k.find(A=>A.company_name?.toLowerCase()===a.client_name?.toLowerCase()||A.deal_id===a.deal_id);L({clientName:a.client_name,currentStatus:u?.status||"active",dealId:a.deal_id})},S=async(a,u)=>{if(!_)return;const A=k.find(t=>t.company_name?.toLowerCase()===_.clientName?.toLowerCase()||t.deal_id===_.dealId);try{const t={status:a};a==="notice_given"?(t.notice_given_date=u?.noticeDate||new Date().toISOString().split("T")[0],t.final_billing_date=u?.finalBillingDate,t.churn_reason=u?.churnReason):a==="churned"?(t.churn_date=new Date().toISOString(),t.notice_given_date=u?.noticeDate,t.final_billing_date=u?.finalBillingDate,t.churn_reason=u?.churnReason):(t.churn_date=null,t.notice_given_date=null,t.final_billing_date=null,t.churn_reason=null),A?await I(A.id,t)&&N.success("Client status updated successfully"):await w({company_name:_.clientName,deal_id:_.dealId||null,owner_id:f?.id||"",subscription_amount:0,subscription_start_date:new Date().toISOString().split("T")[0],...t})&&N.success("Client status created successfully"),L(null)}catch{N.error("Failed to update client status")}},H=o.useMemo(()=>{const a=n.length,u=n.reduce((x,R)=>{const $=D(R.lifetime_deal_value||0,0,{fieldName:"summary_lifetime_value",allowZero:!0});return x+$},0),A=n.filter(x=>x.deal_type==="subscription").length,t=n.filter(x=>x.deal_type==="one-off").length,v=n.filter(x=>x.deal_type==="subscription").reduce((x,R)=>{const $=D(R.monthly_mrr||0,0,{fieldName:"summary_mrr",allowZero:!0});return x+$},0);return{totalClients:a,totalValue:u,subscriptionClients:A,oneOffClients:t,totalMRR:v}},[n]);return F?e.jsx("div",{className:q("bg-gray-900/50 backdrop-blur-xl rounded-xl p-6 border border-gray-800/50",g),children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-700 rounded w-1/4"}),e.jsx("div",{className:"space-y-3",children:[1,2,3,4,5].map(a=>e.jsx("div",{className:"h-12 bg-gray-700 rounded"},a))})]})}):e.jsxs("div",{className:q("space-y-6",g),children:[e.jsxs("div",{className:"grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:H.totalClients}),e.jsx("div",{className:"text-sm text-gray-400",children:"Total Clients"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:Z(H.totalValue)}),e.jsx("div",{className:"text-sm text-gray-400",children:"Total Value"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-emerald-400",children:H.subscriptionClients}),e.jsx("div",{className:"text-sm text-gray-400",children:"Subscriptions"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-lg p-4 border border-gray-800/50",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-400",children:H.oneOffClients}),e.jsx("div",{className:"text-sm text-gray-400",children:"One-off"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Payment Tracking"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Track both subscription payments and one-off invoices for all clients"})]}),e.jsxs(B,{variant:"outline",onClick:()=>M(!m),className:"bg-gray-800/50 border-gray-700/50 text-white hover:bg-gray-700/50",children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Filters",(r.dealType||r.searchQuery||r.minValue||r.maxValue||r.salesRep)&&e.jsx("span",{className:"ml-2 bg-emerald-500 text-white text-xs rounded-full px-2 py-0.5",children:"Active"})]})]}),e.jsx(ye,{children:m&&e.jsx(U.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl p-6 border border-gray-800/50 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Search"}),e.jsxs("div",{className:"relative",children:[e.jsx(Le,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search company name, sales rep, or payment...",value:r.searchQuery,onChange:a=>i(u=>({...u,searchQuery:a.target.value})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg pl-10 pr-4 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Deal Type"}),e.jsxs("select",{value:r.dealType||"all",onChange:a=>i(u=>({...u,dealType:a.target.value==="all"?void 0:a.target.value})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Types"}),e.jsx("option",{value:"subscription",children:"Subscription"}),e.jsx("option",{value:"one-off",children:"One-off"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Sales Rep"}),e.jsxs("select",{value:r.salesRep||"all",onChange:a=>i(u=>({...u,salesRep:a.target.value==="all"?void 0:a.target.value})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Sales Reps"}),Array.from(new Set(b.map(a=>a.sales_rep).filter(Boolean))).sort().map(a=>e.jsx("option",{value:a,children:a},a))]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Min Value (¬£)"}),e.jsx("input",{type:"number",placeholder:"0",value:r.minValue||"",onChange:a=>i(u=>({...u,minValue:a.target.value?parseFloat(a.target.value):void 0})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Max Value (¬£)"}),e.jsx("input",{type:"number",placeholder:"100000",value:r.maxValue||"",onChange:a=>i(u=>({...u,maxValue:a.target.value?parseFloat(a.target.value):void 0})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Client Status"}),e.jsxs("select",{value:r.status||"all",onChange:a=>i(u=>({...u,status:a.target.value==="all"?void 0:a.target.value})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent",children:[e.jsx("option",{value:"all",children:"All Statuses"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"signed",children:"Signed"}),e.jsx("option",{value:"deposit_paid",children:"Deposit Paid"}),e.jsx("option",{value:"paused",children:"Paused"}),e.jsx("option",{value:"notice_given",children:"Notice Given"}),e.jsx("option",{value:"churned",children:"Churned"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Date From"}),e.jsx("input",{type:"date",value:r.dateFrom||"",onChange:a=>i(u=>({...u,dateFrom:a.target.value||void 0})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Date To"}),e.jsx("input",{type:"date",value:r.dateTo||"",onChange:a=>i(u=>({...u,dateTo:a.target.value||void 0})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-300",children:"Owner Filter"}),e.jsx("input",{type:"text",placeholder:"Filter by owner/rep...",value:r.owner||"",onChange:a=>i(u=>({...u,owner:a.target.value||void 0})),className:"w-full bg-gray-800/50 border border-gray-700/50 rounded-lg px-3 py-2 text-white placeholder-gray-500 focus:ring-2 focus:ring-emerald-500 focus:border-transparent"})]})]}),(r.dealType||r.searchQuery||r.minValue||r.maxValue||r.salesRep||r.status||r.dateFrom||r.dateTo||r.owner)&&e.jsxs(B,{variant:"ghost",size:"sm",onClick:pe,className:"text-gray-400 hover:text-white",children:[e.jsx(he,{className:"w-4 h-4 mr-1"}),"Clear All Filters"]})]})})})]}),e.jsx("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl border border-gray-800/50 overflow-hidden",children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-800/50",children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Client"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Deal Value"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"One-off"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Subscription"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Type"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Sales Rep"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Signed Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Deal"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-400 whitespace-nowrap",children:"Actions"})]})}),e.jsx("tbody",{children:n.map((a,u)=>{const A=P(a.deal_type),t=se(a.status||"active");return e.jsxs(U.tr,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2,delay:u*.02},className:"border-b border-gray-800/50 hover:bg-gray-800/20",children:[e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-lg bg-gray-800/50 flex items-center justify-center",children:e.jsx(ge,{className:"w-4 h-4 text-gray-400"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-white flex items-center gap-2",children:[a.client_name,e.jsx("button",{onClick:v=>{v.stopPropagation(),$e(a.client_name)},className:"text-blue-400 hover:text-blue-300 transition-colors",title:"View company profile",children:e.jsx(ge,{className:"w-3 h-3"})})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:[a.deal_name&&e.jsxs("span",{className:"text-blue-400",children:["üîó ",a.deal_name]}),a.deal_name&&a.contact_identifier&&e.jsx("span",{className:"mx-1",children:"‚Ä¢"}),a.contact_identifier&&e.jsx("span",{children:a.contact_identifier})]})]})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:q("inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border",C(a.status||"active")),children:[e.jsx(t,{className:"w-3 h-3"}),z(a.status||"active")]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm font-medium text-white",children:Z(a.lifetime_deal_value||0)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm font-medium text-blue-400",children:Z(a.one_off_revenue||0)})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"text-sm font-medium text-emerald-400",children:[Z(a.monthly_mrr||0),a.monthly_mrr>0&&e.jsx("span",{className:"text-xs text-gray-400",children:"/mo"})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:q("inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium border",h(a.deal_type)),children:[e.jsx(A,{className:"w-3 h-3"}),a.deal_type]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center",children:e.jsx("span",{className:"text-xs font-medium text-emerald-500",children:a.sales_rep?.split(" ").map(v=>v[0]).join("")||"??"})}),e.jsx("span",{className:"text-sm text-white",children:a.sales_rep})]})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm text-white",children:W(new Date(a.signed_date),"MMM d, yyyy")})}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"text-sm text-white",children:a.deal_id?e.jsxs("button",{onClick:()=>{c(a.deal_id)},className:"text-left hover:bg-gray-700/50 rounded-lg p-2 -m-2 transition-colors group",children:[e.jsx("div",{className:"text-emerald-400 font-medium group-hover:text-emerald-300",children:"Linked üîó"}),e.jsxs("div",{className:"text-xs text-gray-400 group-hover:text-gray-300",children:["ID: ",a.deal_id.slice(-6)," ‚Ä¢ Click to view"]})]}):e.jsx("span",{className:"text-gray-400",children:"No deal linked"})})}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>Q(a),disabled:!a.deal_id,className:`p-2 rounded-lg transition-colors ${a.deal_id?"hover:bg-emerald-500/20 text-gray-400 hover:text-emerald-500":"text-gray-600 cursor-not-allowed"}`,title:a.deal_id?"Edit deal revenue splits":"No deal linked",children:e.jsx(ne,{className:"w-4 h-4"})}),e.jsx(U.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>s(a),className:"p-2 hover:bg-blue-500/20 rounded-lg transition-colors text-gray-400 hover:text-blue-500",title:"Manage client status",children:e.jsx(Oe,{className:"w-4 h-4"})})]})})]},a.id)})})]}),n.length===0&&e.jsx("div",{className:"text-center py-8",children:e.jsx("div",{className:"text-gray-400",children:b.length===0?"No payment records found.":"No payments match your filters."})})]})}),e.jsx(Be,{isOpen:!!j,onClose:()=>y(null),dealId:j?.id||null,dealName:j?.name||"",currentMRR:j?.monthly_mrr,currentOneOff:j?.one_off_revenue,currentAnnualValue:j?.annual_value,onSave:async()=>{await T(),await p()}}),e.jsx(Ee,{isOpen:!!_,onClose:()=>L(null),clientName:_?.clientName||"",currentStatus:_?.currentStatus||"active",onSave:S}),e.jsx(ia,{isOpen:!!O,onClose:()=>c(null),dealId:O})]})},ca=ke.memo(da);function wa(){const[g,f]=o.useState("aggregated"),d=l=>{};return e.jsx("div",{className:"min-h-screen text-gray-100 p-4 sm:p-6 lg:p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-8",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Client & Payment Management"}),e.jsx("p",{className:"text-gray-400",children:g==="aggregated"?"Aggregated view of unique clients with totals and metrics":"Detailed payment records with revenue tracking and individual deal management"})]}),e.jsxs("div",{className:"flex items-center gap-2 bg-gray-900/50 rounded-lg p-1 border border-gray-800/50",children:[e.jsxs(B,{variant:g==="aggregated"?"default":"ghost",size:"sm",onClick:()=>f("aggregated"),className:`${g==="aggregated"?"bg-emerald-500 text-white hover:bg-emerald-600":"text-gray-400 hover:text-white hover:bg-gray-800/50"}`,children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Client Overview"]}),e.jsxs(B,{variant:g==="detailed"?"default":"ghost",size:"sm",onClick:()=>f("detailed"),className:`${g==="detailed"?"bg-emerald-500 text-white hover:bg-emerald-600":"text-gray-400 hover:text-white hover:bg-gray-800/50"}`,children:[e.jsx(Re,{className:"w-4 h-4 mr-2"}),"Payment Records"]})]})]}),e.jsx(ye,{mode:"wait",children:e.jsx(U.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:"bg-gray-900/30 rounded-lg p-4 border border-gray-800/30",children:g==="aggregated"?e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Me,{className:"w-5 h-5 text-emerald-400 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-white mb-1",children:"Client Overview Mode"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Shows unique clients with aggregated data including total payments, lifetime value, monthly MRR, active subscriptions, churn tracking, and last payment date. Perfect for high-level client relationship management and performance tracking."})]})]}):e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Re,{className:"w-5 h-5 text-blue-400 mt-1 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-white mb-1",children:"Payment Records Mode"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Shows individual payment records and deals with comprehensive revenue tracking. Includes subscription management, one-off payments, deal values, and detailed financial analytics for precise transaction-level analysis."})]})]})},`description-${g}`)}),g==="detailed"&&e.jsxs(U.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},className:"space-y-4",children:[e.jsx("h2",{className:"text-xl font-semibold text-white",children:"Revenue Overview"}),e.jsx(ze,{onClick:d,className:"w-full"})]},"revenue-stats"),e.jsx(ye,{mode:"wait",children:e.jsx(U.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},transition:{duration:.4},children:g==="aggregated"?e.jsx(na,{className:"w-full"}):e.jsx(ca,{className:"w-full"})},`table-${g}`)})]})})}export{wa as default};
