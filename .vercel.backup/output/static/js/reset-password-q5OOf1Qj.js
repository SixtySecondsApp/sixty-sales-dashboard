import{j as e}from"./vendor-state-CpjwTZNq.js";import{r as m}from"./vendor-react-DoYyFkVR.js";import{e as D,l as s,s as j,a}from"./index.html-Cwo_Unfk.js";import{a as E,u as T}from"./vendor-router-CQXjpROx.js";import{motion as k}from"./ui-animation-Dzb4KUJ1.js";import{N as L}from"./vendor-icons-HRBKouGg.js";import"./vendor-supabase-BuXd-BBn.js";import"./vendor-utils-Cb9OXVhE.js";import"./ui-radix-core-CdvL28QE.js";import"./vendor-charts-D4YcUEy1.js";function G(){const[y,P]=m.useState(!1),[U,b]=m.useState(!1),[C,w]=m.useState(!0),[c,t]=m.useState(""),[o,S]=m.useState({password:"",confirmPassword:""}),u=E();T();const{updatePassword:V}=D();m.useEffect(()=>{(async()=>{try{const n=window.location.href,d=window.location.hash,l=window.location.search;s.log("=== RECOVERY SESSION DEBUG ==="),s.log("Current URL:",n),s.log("Hash params:",d),s.log("Search params:",l),t(`URL: ${n}
Hash: ${d}
Search: ${l}`);const h=new URLSearchParams(d.substring(1)),i=new URLSearchParams(l),p=h.get("access_token")||i.get("access_token"),f=h.get("refresh_token")||i.get("refresh_token"),v=h.get("type")||i.get("type"),_=i.get("token_hash"),R={accessToken:!!p,refreshToken:!!f,type:v,tokenHash:!!_};if(s.log("Parsed parameters:",R),t(r=>r+`
Parsed: `+JSON.stringify(R)),v==="recovery"&&_)s.log("✅ Modern recovery flow detected with token_hash"),t(r=>r+`
✅ Modern recovery flow detected`),s.log("✅ Valid recovery token detected, showing password reset form"),t(r=>r+`
✅ Valid recovery token, showing form`),b(!0);else if(v==="recovery"&&p){s.log("✅ Legacy recovery flow detected with access_token"),t(x=>x+`
✅ Legacy recovery flow detected`);const{data:{session:r},error:N}=await j.auth.setSession({access_token:p,refresh_token:f||""});if(s.log("Legacy recovery session:",{session:!!r,error:N}),N||!r){s.error("❌ Legacy recovery error:",N),t(x=>x+`
❌ Legacy session failed`),a.error("Your reset link has expired. Please request a new one."),w(!1);return}b(!0),t(x=>x+`
✅ Legacy session established`)}else s.log("❌ No valid recovery parameters found"),t(r=>r+`
❌ No valid parameters found`),a.error("Invalid password reset link");w(!1)}catch(n){t(d=>d+`
❌ Exception: `+n.message),a.error("Your reset link has expired. Please request a new one."),u("/auth/forgot-password"),w(!1)}})()},[u]);const I=async g=>{if(g.preventDefault(),o.password!==o.confirmPassword){a.error("Passwords do not match");return}if(o.password.length<6){a.error("Password must be at least 6 characters long");return}P(!0);try{const n=new URLSearchParams(window.location.search),d=new URLSearchParams(window.location.hash.substring(1)),l=n.get("token_hash"),h=d.get("access_token")||n.get("access_token");if(s.log("Password update attempt:",{tokenHash:!!l,accessToken:!!h}),l){s.log("Verifying recovery token before password update...");const{data:p,error:f}=await j.auth.verifyOtp({token_hash:l,type:"recovery"});if(f){s.error("Token verification failed:",f),a.error("Your reset link has expired. Please request a new one."),u("/auth/forgot-password");return}if(!p?.session){s.error("No session established during verification"),a.error("Failed to establish session. Please try again.");return}s.log("✅ Recovery session established, updating password...")}const{error:i}=await j.auth.updateUser({password:o.password});i?(s.error("Password update error:",i),a.error(i.message||"Failed to update password. Please try again.")):(a.success("Password updated successfully! Redirecting to dashboard..."),setTimeout(()=>{u("/dashboard")},1e3))}catch{a.error("An unexpected error occurred. Please try again.")}finally{P(!1)}};return C?e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950",children:[e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(74,74,117,0.25),transparent)] pointer-events-none"}),e.jsxs(k.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center w-full max-w-2xl",children:[e.jsx("div",{className:"w-8 h-8 border-2 border-[#37bd7e] border-t-transparent rounded-full animate-spin mx-auto mb-4"}),e.jsx("p",{className:"text-gray-400 mb-4",children:"Verifying password reset link..."}),c&&e.jsxs("div",{className:"bg-gray-900/80 border border-gray-700 rounded-xl p-4 mt-4 text-left",children:[e.jsx("h3",{className:"text-white font-medium mb-2",children:"Debug Information:"}),e.jsx("pre",{className:"text-xs text-gray-300 whitespace-pre-wrap font-mono bg-gray-800/50 p-3 rounded overflow-auto max-h-96",children:c})]})]})]}):U?e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950",children:[e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(74,74,117,0.25),transparent)] pointer-events-none"}),e.jsx(k.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"w-full max-w-md",children:e.jsxs("div",{className:"relative bg-gray-900/50 backdrop-blur-xl rounded-2xl border border-gray-800/50 p-6 sm:p-8 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-gray-900/90 via-gray-900/70 to-gray-900/30 rounded-2xl -z-10"}),e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(74,74,117,0.15),transparent)] rounded-2xl -z-10"}),e.jsx("div",{className:"absolute -right-20 -top-20 w-40 h-40 bg-[#37bd7e]/10 blur-3xl rounded-full"}),e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2 text-white",children:"Set New Password"}),e.jsx("p",{className:"text-gray-400",children:"Create a new password for your account"}),c&&e.jsxs("details",{className:"mt-4 text-left",children:[e.jsx("summary",{className:"text-sm text-gray-500 cursor-pointer hover:text-gray-400",children:"Show Debug Info"}),e.jsx("pre",{className:"text-xs text-gray-400 whitespace-pre-wrap font-mono bg-gray-800/30 p-3 rounded mt-2 max-h-40 overflow-auto",children:c})]})]}),e.jsxs("form",{onSubmit:I,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-400",children:"New Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"password",required:!0,minLength:6,value:o.password,onChange:g=>S({...o,password:g.target.value}),className:"w-full bg-gray-800/30 border border-gray-700/30 rounded-xl pl-10 pr-4 py-2.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#37bd7e] focus:border-transparent transition-colors hover:bg-gray-800/50",placeholder:"••••••••",disabled:y})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-400",children:"Confirm New Password"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"}),e.jsx("input",{type:"password",required:!0,minLength:6,value:o.confirmPassword,onChange:g=>S({...o,confirmPassword:g.target.value}),className:"w-full bg-gray-800/30 border border-gray-700/30 rounded-xl pl-10 pr-4 py-2.5 text-white placeholder-gray-500 focus:ring-2 focus:ring-[#37bd7e] focus:border-transparent transition-colors hover:bg-gray-800/50",placeholder:"••••••••",disabled:y})]})]}),e.jsx("button",{type:"submit",disabled:y,className:"w-full bg-[#37bd7e] text-white py-2.5 rounded-xl font-medium hover:bg-[#2da76c] focus:outline-none focus:ring-2 focus:ring-[#37bd7e] focus:ring-offset-2 focus:ring-offset-gray-900 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-[#37bd7e]/20",children:y?"Updating Password...":"Update Password"})]})]})})]}):e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-gray-950 via-gray-900 to-gray-950",children:[e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(74,74,117,0.25),transparent)] pointer-events-none"}),e.jsxs(k.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center w-full max-w-2xl",children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"Password Reset Debug"}),e.jsx("p",{className:"text-gray-400 mb-6",children:"Analyzing the password reset link..."}),c&&e.jsxs("div",{className:"bg-gray-900/80 border border-gray-700 rounded-xl p-4 mb-6 text-left",children:[e.jsx("h3",{className:"text-white font-medium mb-2",children:"Debug Information:"}),e.jsx("pre",{className:"text-xs text-gray-300 whitespace-pre-wrap font-mono bg-gray-800/50 p-3 rounded overflow-auto max-h-96",children:c})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("button",{onClick:()=>b(!0),className:"bg-[#37bd7e] text-white px-6 py-2 rounded-xl font-medium hover:bg-[#2da76c] transition-colors",children:"Force Show Password Reset Form"}),e.jsx("div",{children:e.jsx("button",{onClick:()=>u("/auth/forgot-password"),className:"bg-gray-700 text-white px-6 py-2 rounded-xl font-medium hover:bg-gray-600 transition-colors",children:"Request New Reset Link"})})]})]})]})}export{G as default};
