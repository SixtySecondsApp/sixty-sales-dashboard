import{j as e}from"./vendor-state-CpjwTZNq.js";import{r}from"./vendor-react-DoYyFkVR.js";import{c as G,s as T,l as d,a as m,B as w}from"./index.html-Cwo_Unfk.js";import{A as J,a as X,b as Y}from"./alert-DhiZyWgi.js";import{Table as Z,TableHeader as ee,TableRow as O,TableHead as j,TableBody as se,TableCell as y}from"./table-C4c75fDG.js";import{B as te}from"./badge-C6MYiXDB.js";import{A as ie,a as ae}from"./avatar-pcXzE_pF.js";import{T as re,a as ne,b as R}from"./tabs-C3YOVIlH.js";import{Dialog as le,DialogContent as ce,DialogHeader as oe,DialogTitle as de,DialogFooter as me}from"./dialog-BBMx1wit.js";import{I as ue}from"./input-CeE6qNqI.js";import{L as ge}from"./label-B9drN7Ag.js";import{L as E,W as pe}from"./vendor-icons-HRBKouGg.js";import{S as xe,a as he,b as fe,c as ye,d as P}from"./select-BFsZCfaH.js";import{p as be}from"./vendor-utils-Cb9OXVhE.js";import"./vendor-router-CQXjpROx.js";import"./vendor-supabase-BuXd-BBn.js";import"./ui-radix-core-CdvL28QE.js";import"./ui-animation-Dzb4KUJ1.js";import"./vendor-charts-D4YcUEy1.js";import"./ui-radix-extended-CHWFg20j.js";import"./ui-forms-D2VzSQqQ.js";const k=T;function ve(s){const[b,c]=r.useState([]),[N,p]=r.useState(!0),[f,x]=r.useState(null),{userData:u}=G(),h=r.useCallback(async()=>{if(!u?.id){p(!1),c([]);return}try{p(!0),x(null);let i=k.from("activities").select("*").order("date",{ascending:!1});s&&(s.contact_identifier==="IS_NULL"?(d.log("[useOriginalActivities] Applying filter: contact_identifier IS NULL"),i=i.is("contact_identifier",null)):s.contact_identifier==="IS_NOT_NULL"&&(d.log("[useOriginalActivities] Applying filter: contact_identifier IS NOT NULL"),i=i.not("contact_identifier","is",null)),s.is_processed!==void 0&&(d.log(`[useOriginalActivities] Applying filter: is_processed = ${s.is_processed}`),i=i.eq("is_processed",s.is_processed)),s.type_neq!==void 0&&(d.log(`[useOriginalActivities] Applying filter: type ILIKE not ${s.type_neq}`),i=i.not("type","ilike",s.type_neq)),s.user_id&&(d.log(`[useOriginalActivities] Applying filter: user_id = ${s.user_id}`),i=i.eq("user_id",s.user_id))),d.log("[useOriginalActivities] FINAL Query object before execution:",i);const{data:g,error:a}=await i;if(a)throw d.error("[useOriginalActivities] Query error:",a),a;d.log("[useOriginalActivities] Fetched data:",g?.length,"items"),c(g||[])}catch(i){x(i),c([])}finally{p(!1)}},[u?.id,s]);return r.useEffect(()=>{h();let i;return u?.id&&(i=k.channel("original_activity_changes").on("postgres_changes",{event:"*",schema:"public",table:"activities"},g=>{h()}).subscribe()),()=>{i&&k.removeChannel(i)}},[h,u?.id]),{activities:b,isLoading:N,error:f,refreshActivities:h,updateActivity:async(i,g)=>{if(!u?.id)return m.error("Authentication required to update activities."),!1;try{const{profiles:a,...A}=g;d.log(`[useOriginalActivities] Attempting to update activity ${i} with:`,A);const{error:_}=await k.from("activities").update(A).eq("id",i);if(_)throw d.error(`[useOriginalActivities] Error during supabase update for activity ${i}:`,_),_;return d.log(`[useOriginalActivities] Update command successful for activity ${i}.`),!0}catch(a){return a.code,x(a),m.error("Failed to update activity",{description:a.message}),!1}}}}function je({activity:s,isOpen:b,onClose:c,onSave:N}){const[p,f]=r.useState(""),[x,u]=r.useState(!1),[h,n]=r.useState(null);r.useEffect(()=>{s?(f(s.contact_identifier||""),n(null)):f("")},[s]);const i=async()=>{if(!s||!p){n("Please enter a valid email address.");return}if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(p)){n("Invalid email format.");return}u(!0);try{await N(s.id,p)?(m.success(`Email updated for ${s.client_name||"activity"}.`),c()):n("Failed to save email. See console for details.")}catch{n("An unexpected error occurred while saving."),m.error("An unexpected error occurred.")}finally{u(!1)}},g=a=>{a||c()};return s?e.jsx(le,{open:b,onOpenChange:g,children:e.jsxs(ce,{className:"bg-gray-900/95 backdrop-blur-xl border-gray-800/50 text-white p-6 rounded-xl sm:max-w-[425px]",children:[e.jsx(oe,{children:e.jsx(de,{className:"text-white",children:"Edit Contact Email"})}),e.jsxs("div",{className:"grid gap-4 py-4",children:[e.jsxs("p",{className:"text-sm text-gray-400",children:["Update the email address for activity related to client: ",e.jsx("span",{className:"font-medium text-gray-300",children:s.client_name})," (Type: ",s.type,")."]}),e.jsxs("div",{className:"grid grid-cols-4 items-center gap-4",children:[e.jsx(ge,{htmlFor:"email",className:"text-right text-gray-400",children:"Email"}),e.jsx(ue,{id:"email",value:p,onChange:a=>f(a.target.value),placeholder:"name@example.com",className:"col-span-3 bg-gray-800/50 border-gray-700/50 focus:ring-offset-0 focus:ring-1 focus:ring-cyan-500 text-white rounded-md"})]}),h&&e.jsx("p",{className:"text-red-500 text-sm text-center col-span-4",children:h})]}),e.jsxs(me,{children:[e.jsx(w,{variant:"ghost",onClick:c,className:"bg-gray-800/50 text-gray-300 hover:bg-gray-800",disabled:x,children:"Cancel"}),e.jsx(w,{onClick:i,disabled:x,className:"bg-cyan-600 hover:bg-cyan-700 text-white",children:x?e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}):"Save changes"})]})]})}):null}const we=s=>s?s.split(" ").map(b=>b?.[0]||"").join("").toUpperCase():"??";function Qe(){const[s,b]=r.useState("missing-email"),[c,N]=r.useState(void 0),[p,f]=r.useState([]),[x,u]=r.useState(!0);r.useEffect(()=>{(async()=>{u(!0);try{const{data:l,error:o}=await T.from("profiles").select("id, first_name, last_name").order("first_name",{ascending:!0});if(o)throw o;f(l||[])}catch{m.error("Failed to load user list for filtering."),f([])}finally{u(!1)}})()},[]);const h=r.useMemo(()=>{let t={};return s==="missing-email"?t={contact_identifier:"IS_NULL",type_neq:"Outbound"}:t={contact_identifier:"IS_NOT_NULL",is_processed:!1,type_neq:"Outbound Activity"},c&&(t.user_id=c),t},[s,c]),{activities:n,isLoading:i,error:g,refreshActivities:a,updateActivity:A}=ve(h),[_,I]=r.useState(!1),[U,$]=r.useState(null),[S,F]=r.useState(null),[D,q]=r.useState(!1),B=t=>{$(t),I(!0)},V=()=>{I(!1),$(null)},H=async(t,l)=>A&&await A(t,{contact_identifier:l})?(a(),!0):!1,M=async t=>{F(t);const l=m.loading(`Processing activity ${t}...`);try{const{data:o,error:v}=await T.functions.invoke("process-single-activity",{body:{activityId:t}});if(v)if(v.message.includes("already processed"))m.info(`Activity ${t} was already processed.`,{id:l}),a();else throw v;else d.log("[ActivityProcessingPage] Function response:",o),m.success(`Successfully processed activity ${t}.`,{id:l}),a()}catch(o){const v=o.context?` (${o.context.status||"unknown status"})`:"";m.error("Failed to process activity",{id:l,description:`${o.message||"Unknown error"}${v}`})}finally{F(null)}},z=async()=>{if(!n||n.length===0)return;q(!0);let t=0,l=0;const o=m.loading("Processing all ready activities...");for(const v of n)try{await M(v.id),t++}catch{l++}q(!1),l===0?m.success(`Successfully processed all (${t}) activities.`,{id:o}):m.error(`Processed ${t} activities, but ${l} failed.`,{id:o}),a()},C=i||S!==null&&s==="process-ready",L=i&&n.length===0?s==="missing-email"?"Loading activities missing email...":"Loading activities ready for processing...":i&&S===null?"Refreshing...":null;if(g)return e.jsx("div",{className:"container mx-auto py-8",children:e.jsxs(J,{variant:"destructive",children:[e.jsx(X,{children:"Error"}),e.jsxs(Y,{children:["Failed to load activities: ",g.message||"Unknown error"]})]})});const Q=s==="missing-email"?"Activities Missing Email":"Process Ready Activities",K=s==="missing-email"?"These activities (excluding 'Outbound') were logged without an email address. Please update the original activity logs with the correct email address to enable pipeline linking.":"These activities have a contact identifier (email) but have not yet been processed to create or link related deals/deal activities. Click 'Process' to handle them individually. (Excluding 'Outbound Activity' types).",W=s==="missing-email"?"No activities (excluding 'Outbound') found missing an email address.":"No activities found that are ready for processing.";return e.jsxs("div",{className:"container mx-auto py-8",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:Q}),e.jsx("p",{className:"text-muted-foreground mb-6",children:K}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6",children:[e.jsx(re,{value:s,onValueChange:t=>b(t),className:"w-full md:w-auto",children:e.jsxs(ne,{className:"grid w-full grid-cols-2 md:w-[400px]",children:[e.jsx(R,{value:"missing-email",children:"Missing Email"}),e.jsx(R,{value:"process-ready",children:"Process Ready"})]})}),e.jsxs(xe,{value:c||"all",onValueChange:t=>N(t==="all"?void 0:t),disabled:x||C,children:[e.jsx(he,{className:"w-full md:w-[280px] bg-gray-800/50 border-gray-700/50 ring-offset-gray-900 focus:ring-emerald-500",children:e.jsx(fe,{placeholder:"Filter by user..."})}),e.jsxs(ye,{className:"bg-gray-800/95 backdrop-blur-md border-gray-700/50 text-white",children:[e.jsx(P,{value:"all",className:"focus:bg-gray-700/50 focus:text-white",children:"All Users"}),x?e.jsx(P,{value:"loading",disabled:!0,children:"Loading users..."}):p.map(t=>e.jsxs(P,{value:t.id,className:"focus:bg-gray-700/50 focus:text-white",children:[t.first_name," ",t.last_name]},t.id))]})]})]}),s==="process-ready"&&n.length>0&&e.jsx("div",{className:"mb-4 flex justify-end",children:e.jsx(w,{variant:"default",onClick:z,disabled:D||i||n.length===0,className:"bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg shadow",children:D?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"})," Processing All..."]}):"Process All Ready"})}),i&&n.length===0&&!g?e.jsx("div",{className:"text-center p-6",children:L}):n.length===0&&!i?e.jsx("p",{className:"mt-6 text-center text-gray-400",children:W}):e.jsx("div",{className:"my-6 p-4 bg-gray-900/50 backdrop-blur-xl rounded-lg border border-gray-800/50 overflow-hidden",children:e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs(O,{className:"border-gray-800/50",children:[e.jsx(j,{className:"px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Date"}),e.jsx(j,{className:"px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Type"}),e.jsx(j,{className:"px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Client Name"}),s==="process-ready"&&e.jsx(j,{className:"px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Contact Email"}),e.jsx(j,{className:"px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Details"}),e.jsx(j,{className:"px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Logged By"}),e.jsx(j,{className:"px-3 py-3 text-right text-xs font-medium text-gray-400 uppercase tracking-wider whitespace-nowrap",children:"Actions"})]})}),e.jsxs(se,{children:[L&&L==="Refreshing..."&&e.jsx(O,{children:e.jsx(y,{colSpan:s==="process-ready"?7:6,className:"h-12 text-center text-muted-foreground",children:L})}),n.map(t=>{const l=S===t.id&&s==="process-ready";return e.jsxs(O,{className:`${l?"opacity-50 pointer-events-none":""} border-b border-gray-800/50 hover:bg-gray-800/20`,children:[e.jsx(y,{className:"px-3 py-3 text-sm text-white",children:be(new Date(t.date),"PP")}),e.jsx(y,{className:"px-3 py-3",children:e.jsx(te,{variant:"secondary",children:t.type})}),e.jsx(y,{className:"px-3 py-3 text-sm text-white",children:t.client_name||"-"}),s==="process-ready"&&e.jsx(y,{className:"px-3 py-3 text-sm text-white",children:t.contact_identifier||"-"}),e.jsx(y,{className:"px-3 py-3 text-sm text-gray-400 max-w-xs truncate",children:t.details||"-"}),e.jsx(y,{className:"px-3 py-3",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ie,{className:"h-7 w-7 sm:h-8 sm:w-8",children:e.jsx(ae,{className:"text-xs sm:text-sm font-medium text-[#37bd7e] bg-[#37bd7e]/10 border border-[#37bd7e]/20",children:we(t.sales_rep)})}),e.jsx("span",{className:"text-sm sm:text-base text-white",children:t.sales_rep||"(no name)"})]})}),e.jsx(y,{className:"px-3 py-3 text-right",children:s==="missing-email"?e.jsxs(w,{variant:"ghost",size:"icon",onClick:()=>B(t),className:"p-2 rounded-lg text-gray-400 hover:bg-[#37bd7e]/20 hover:text-[#37bd7e] transition-colors",disabled:C,children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Edit Email"})]}):e.jsx(w,{variant:"ghost",size:"sm",onClick:()=>M(t.id),disabled:l||i,className:"px-3 py-1.5 rounded-lg text-gray-400 hover:bg-blue-500/20 hover:text-blue-400 transition-colors disabled:opacity-50 disabled:pointer-events-none",children:l?e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"})," Processing..."]}):"Process"})})]},t.id)})]})]})}),e.jsxs(w,{variant:"secondary",onClick:a,disabled:C,className:"mt-4 dark:text-white",children:[i&&S===null?e.jsx(E,{className:"mr-2 h-4 w-4 animate-spin"}):null,i&&S===null?"Refreshing...":"Refresh List"]}),s==="missing-email"&&U&&e.jsx(je,{activity:U,isOpen:_,onClose:V,onSave:H})]})}export{Qe as ActivityProcessingPage,Qe as default};
