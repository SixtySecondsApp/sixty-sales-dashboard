import{j as e}from"./vendor-state-CpjwTZNq.js";import{r as i,a as $e}from"./vendor-react-DoYyFkVR.js";import{Dialog as Le,DialogContent as qe,DialogHeader as Ue,DialogTitle as Be,DialogFooter as ze,DialogDescription as nt}from"./dialog-BBMx1wit.js";import{s as M,a as Y,l as E,c as We,E as ot,u as ct,m as dt,B as G,p as ut,D as mt}from"./index.html-Cwo_Unfk.js";import{I as le}from"./input-CeE6qNqI.js";import{L as Ne}from"./label-B9drN7Ag.js";import{T as gt}from"./textarea-C78yVaZk.js";import{A as ht,a as xt}from"./avatar-pcXzE_pF.js";import{B as me}from"./badge-C6MYiXDB.js";import{C as ie,b as Se,c as _e,a as ne}from"./card-B2-KTHtJ.js";import{S as pe,a as ye,b as ve,c as je,d as J}from"./select-BFsZCfaH.js";import{aX as Ke,E as bt,U as ge,a3 as He,X as Ge,a8 as Qe,Y as Ye,c as Te,F as de,ay as ft,S as pt,a4 as yt,M as fe,P as vt,o as Xe,A as Ze,k as se,C as jt,a as wt,e as Nt,aE as St,b2 as Ve,b3 as _t,b4 as Ct,z as Dt,b5 as Fe,b6 as Ae}from"./vendor-icons-HRBKouGg.js";import{a as Pe,u as Et,F as kt}from"./ui-forms-D2VzSQqQ.js";import{P as Tt,a as At,b as $t}from"./popover-BxJ1Vfi_.js";import{p as re,j as he,C as Pt,n as Rt,d as Me,Q as Vt,R as Ft,W as Mt,Y as Ot}from"./vendor-utils-Cb9OXVhE.js";import{S as It}from"./slider-BMvrEO5E.js";import{a as Lt,b as qt,c as Ut}from"./date-filter-BIFPvFKu.js";function Bt(r={}){const[a,t]=i.useState([]),[d,o]=i.useState(!1),[g,u]=i.useState(null),v=i.useCallback(async()=>{if(!(!r.dealId&&!r.userId))try{o(!0),u(null);let l=M.from("deal_splits_with_users").select("*").order("created_at",{ascending:!1});r.dealId&&(l=l.eq("deal_id",r.dealId)),r.userId&&(l=l.eq("user_id",r.userId));const{data:p,error:S}=await l;if(S)throw S;t(p||[])}catch(l){u(l.message),Y.error("Failed to load deal splits")}finally{o(!1)}},[r.dealId,r.userId]),C=i.useCallback(async l=>{try{if(u(null),l.percentage<=0||l.percentage>100)throw new Error("Percentage must be between 0 and 100");const S=a.filter(D=>D.deal_id===l.deal_id).reduce((D,$)=>D+$.percentage,0);if(S+l.percentage>100)throw new Error(`Cannot add ${l.percentage}%. Would exceed 100% (current total: ${S}%)`);const{data:T,error:L}=await M.from("deal_splits").insert([l]).select().single();if(L)throw L;E.log(`Looking for activities for deal ${l.deal_id}`);const{data:V}=await M.from("activities").select("*").eq("deal_id",l.deal_id);E.log(`All activities for deal ${l.deal_id}:`,V),V&&V.length===1&&V[0].type==="sale"&&!V[0].is_split&&E.log("Found single sale activity, will use as original");let{data:h,error:R}=await M.from("activities").select("*").eq("deal_id",l.deal_id).eq("type","sale").neq("is_split",!0).single();if(R){const{data:D}=await M.from("activities").select("*").eq("deal_id",l.deal_id).eq("type","sale").is("is_split",null).single();D&&(h=D,R=null)}let y=!1;if(R){E.warn(`No sale activity found for deal ${l.deal_id}. This deal may not have been created as a sale yet.`,R),E.log("No original activity to split - creating split activity only");const{data:D}=await M.from("deals").select("*").eq("id",l.deal_id).single();if(D){const{data:$}=await M.from("profiles").select("first_name, last_name").eq("id",l.user_id).single();if($){const K=(D.value||0)*(l.percentage/100),z={user_id:l.user_id,type:"sale",client_name:D.company||D.name,details:`${D.name||"Sale"} (${l.percentage}% split)`,amount:K,priority:"high",sales_rep:`${$.first_name} ${$.last_name}`,date:D.created_at,status:"completed",quantity:1,contact_identifier:D.contact_email,contact_identifier_type:D.contact_email?"email":"unknown",deal_id:l.deal_id,is_split:!0,split_percentage:l.percentage},{error:f}=await M.from("activities").insert([z]);f?E.error("Failed to create split activity without original:",f):(E.log(`Created split activity for user ${l.user_id} (${l.percentage}%) without original activity`),E.log("Note: Deal owner needs to create their own sale activity for this deal if they want revenue tracking"))}}}else E.log(`Found original activity for deal ${l.deal_id}:`,h);if(h){const{data:D}=await M.from("deals").select("value").eq("id",l.deal_id).single(),$=D?.value||h.amount||0,{data:K}=await M.from("profiles").select("first_name, last_name").eq("id",l.user_id).single();if(K){const z=$*(l.percentage/100),f=h.details?.replace(/ \(\d+% retained after split\)/,"").replace(/ \(\d+% split\)/,"")||"Sale",B={user_id:l.user_id,type:"sale",client_name:h.client_name,details:`${f} (${l.percentage}% split)`,amount:z,priority:h.priority||"high",sales_rep:`${K.first_name} ${K.last_name}`,date:h.date,status:h.status||"completed",quantity:h.quantity||1,contact_identifier:h.contact_identifier,contact_identifier_type:h.contact_identifier_type,deal_id:l.deal_id,is_split:!0,original_activity_id:h.id,split_percentage:l.percentage},{error:X}=await M.from("activities").insert([B]);if(X)E.warn("Failed to create split activity:",X);else if(E.log(`Created split activity for user ${l.user_id} (${l.percentage}%)`),!y){const x=100-S-l.percentage,k=$*(x/100),Z=`${f} (${x}% retained after split)`;await M.from("activities").update({details:Z,amount:k,split_percentage:x}).eq("id",h.id),E.log(`Updated original activity to ${x}% (${k})`)}}}return Y.success("Deal split created successfully"),await v(),T}catch(p){throw u(p.message),Y.error(p.message||"Failed to create deal split"),p}},[a,v]),b=i.useCallback(async(l,p)=>{try{u(null);const S=a.find(V=>V.id===l);if(!S)throw new Error("Split not found");if(p.percentage!==void 0){if(p.percentage<=0||p.percentage>100)throw new Error("Percentage must be between 0 and 100");const h=a.filter(R=>R.deal_id===S.deal_id&&R.id!==l).reduce((R,y)=>R+y.percentage,0);if(h+p.percentage>100)throw new Error(`Cannot set to ${p.percentage}%. Would exceed 100% (other splits total: ${h}%)`)}const{data:T,error:L}=await M.from("deal_splits").update(p).eq("id",l).select().single();if(L)throw L;if(p.percentage!==void 0){const{data:V}=await M.from("activities").select("*").eq("deal_id",S.deal_id).eq("type","sale").or("is_split.is.null,is_split.eq.false").single(),{data:h}=await M.from("deals").select("value").eq("id",S.deal_id).single();if(h&&V){const R=h.value||0,y=V.details?.replace(/ \(\d+% retained after split\)/,"")||"Sale",D=R*(p.percentage/100),{error:$}=await M.from("activities").update({amount:D,details:`${y} (${p.percentage}% split)`,split_percentage:p.percentage}).eq("deal_id",S.deal_id).eq("user_id",S.user_id).eq("is_split",!0);$?E.warn("Failed to update split activity:",$):E.log(`Updated split activity for user ${S.user_id} to ${p.percentage}%`);const f=100-a.filter(x=>x.deal_id===S.deal_id).reduce((x,k)=>x+(k.id===l?p.percentage:k.percentage),0),B=R*(f/100),X=`${y} (${f}% retained after split)`;await M.from("activities").update({amount:B,details:X,split_percentage:f}).eq("id",V.id),E.log(`Updated original activity to ${f}% (${B})`)}}return Y.success("Deal split updated successfully"),await v(),T}catch(S){throw u(S.message),Y.error(S.message||"Failed to update deal split"),S}},[a,v]),m=i.useCallback(async l=>{try{u(null);const p=a.find(V=>V.id===l);if(!p)throw new Error("Split not found");const{error:S}=await M.from("deal_splits").delete().eq("id",l);if(S)throw S;const{error:T}=await M.from("activities").delete().eq("deal_id",p.deal_id).eq("user_id",p.user_id).eq("is_split",!0);T?E.warn("Failed to delete split activity:",T):E.log(`Deleted split activity for user ${p.user_id}`);const{data:L}=await M.from("activities").select("*").eq("deal_id",p.deal_id).eq("type","sale").or("is_split.is.null,is_split.eq.false").single();if(L){const h=a.filter(D=>D.deal_id===p.deal_id&&D.id!==l).reduce((D,$)=>D+$.percentage,0),R=100-h,{data:y}=await M.from("deals").select("value").eq("id",p.deal_id).single();if(y){const D=(y.value||0)*(R/100),$=h>0?`${L.details?.replace(/ \(\d+% retained after split\)/,"")||"Sale"} (${R}% retained after split)`:L.details?.replace(/ \(\d+% retained after split\)/,"")||"Sale";await M.from("activities").update({details:$,amount:D,split_percentage:h>0?R:null}).eq("id",L.id),E.log(`Restored original activity to ${R}% (${D})`)}}return Y.success("Deal split deleted successfully"),await v(),!0}catch(p){return u(p.message),Y.error(p.message||"Failed to delete deal split"),!1}},[a,v]),n=i.useCallback(l=>{const p=a.filter(V=>V.deal_id===l),S=p.reduce((V,h)=>V+h.percentage,0),T=p.reduce((V,h)=>V+h.amount,0),L=Math.max(0,100-S);return{totalPercentage:S,totalAmount:T,remainingPercentage:L,splitCount:p.length,splits:p}},[a]),A=i.useCallback((l,p)=>a.find(S=>S.deal_id===l&&S.user_id===p),[a]),j=i.useCallback(l=>n(l).remainingPercentage>0,[n]);return i.useEffect(()=>{v()},[v]),{splits:a,isLoading:d,error:g,createSplit:C,updateSplit:b,deleteSplit:m,fetchSplits:v,calculateSplitTotals:n,getUserSplit:A,canSplitDeal:j}}const Je=i.createContext(void 0);function Ta({children:r}){const{userData:a}=We(),[t,d]=i.useState(a?.id),[o,g]=i.useState(Date.now());i.useEffect(()=>{a?.id&&t===void 0&&d(a.id)},[a?.id,t]);const{stages:u,isLoading:v,error:C}=ot(),b=i.useMemo(()=>u.filter(N=>N.name!=="Signed & Paid"&&N.name!=="Signed and Paid"),[u]),{deals:m,isLoading:n,error:A,createDeal:j,updateDeal:l,deleteDeal:p,moveDealToStage:S,forceUpdateDealStage:T,refreshDeals:L}=ct(t),V=i.useCallback(async()=>{await L(),g(Date.now())},[L]),[h,R]=i.useState(""),[y,D]=i.useState({minValue:null,maxValue:null,probability:null,tags:[],dateRange:{field:null,from:null,to:null},stages:[],priorities:[],dealSizes:[],leadSources:{types:[],channels:[]},daysInStage:{min:null,max:null},timeStatus:[],quickFilter:null}),[$,K]=i.useState("all"),[z,f]=i.useState(null),B=i.useCallback((N,_)=>{const F=_.toLowerCase();return N.name?.toLowerCase().includes(F)||N.company?.toLowerCase().includes(F)||N.contact_name?.toLowerCase().includes(F)||N.value?.toString().includes(F)},[]),X=i.useCallback((N,_,F)=>{const w=new Date,P=new Date(w.getTime()-30*24*60*60*1e3),I=new Date(w.getTime()+30*24*60*60*1e3);switch(_){case"my_deals":return N.filter(q=>q.owner_id===F);case"hot_deals":return N.filter(q=>{const Q=q.probability||0,U=q.value||0;return Q>=50||U>=5e3});case"closing_soon":return N.filter(q=>{if(!q.expected_close_date&&!q.close_date)return!1;const Q=new Date(q.expected_close_date||q.close_date);return Q<=I&&Q>=w});case"stale_deals":return N.filter(q=>new Date(q.stage_changed_at||q.created_at)<=P);case"recent":return N.filter(q=>new Date(q.created_at)>=P);default:return N}},[]),x=i.useCallback((N,_)=>{if(!_.field)return!0;const F=N[_.field];if(!F)return!1;const w=new Date(F),P=_.from?new Date(_.from):null,I=_.to?new Date(_.to):null;return!(P&&w<P||I&&w>I)},[]);i.useCallback((N,_)=>{const F=N.lead_source_type||N.leadSource?.type||"unknown",w=N.lead_source_channel||N.leadSource?.channel||"unknown";let P=_.types.length===0||_.types.includes(F),I=_.channels.length===0||_.channels.includes(w);return P&&I},[]),i.useCallback(N=>{const _=N.daysInStage||0;return _>30?"danger":_>14?"warning":"normal"},[]);const k=i.useMemo(()=>{if(!b)return{};const N=$==="custom"&&z?z:Lt($);let _=m.filter(w=>{try{if(N){const Re=new Date(w.created_at);if(Re<N.start||Re>N.end)return!1}if(h&&!B(w,h))return!1;const P=(!y.minValue||w.value>=y.minValue)&&(!y.maxValue||w.value<=y.maxValue),I=!y.probability||w.probability>=y.probability,q=y.stages.length===0||y.stages.includes(w.stage_id),Q=y.priorities.length===0||w.priority&&y.priorities.includes(w.priority),U=y.dealSizes.length===0||w.deal_size&&y.dealSizes.includes(w.deal_size),we=(y.leadSources.types.length===0||w.lead_source_type&&y.leadSources.types.includes(w.lead_source_type))&&(y.leadSources.channels.length===0||w.lead_source_channel&&y.leadSources.channels.includes(w.lead_source_channel)),st=(!y.daysInStage.min||w.daysInStage>=y.daysInStage.min)&&(!y.daysInStage.max||w.daysInStage<=y.daysInStage.max),lt=y.timeStatus.length===0||w.timeStatus&&y.timeStatus.includes(w.timeStatus),it=x(w,y.dateRange);return P&&I&&q&&Q&&U&&we&&st&&lt&&it}catch{return!1}});y.quickFilter&&y.quickFilter!=="all"&&(_=X(_,y.quickFilter,a?.id));const F={};return b.forEach(w=>{F[w.id]=[]}),_.forEach(w=>{F[w.stage_id]&&F[w.stage_id].push(w)}),F},[m,b,h,y,a?.id,B,X,x,o,$,z]),Z=i.useMemo(()=>{let N=0;return Object.values(k).forEach(_=>{_.forEach(F=>{N+=Number(F.value||0)})}),N},[k,o]),W=i.useMemo(()=>{if(!b)return 0;let N=0;return Object.entries(k).forEach(([_,F])=>{const w=b.find(I=>I.id===_);if(!w)return;const P=F.reduce((I,q)=>I+Number(q.value||0),0);N+=P*(w.default_probability/100)}),N},[k,b,o]),s=i.useMemo(()=>{if(!b)return 0;const N=["sql","opportunity","verbal"],F=b.filter(P=>{const I=P?.name?.toLowerCase();return I&&N.includes(I)}).map(P=>P.id);let w=0;return Object.entries(k).forEach(([P,I])=>{if(!F.includes(P))return;const q=b.find(U=>U.id===P);if(!q)return;const Q=I.reduce((U,we)=>U+Number(we.value||0),0);w+=Q*(q.default_probability/100)}),w},[k,b,o]),c=i.useMemo(()=>b?b.map(_=>{const F=k[_.id]||[],w=F.length,P=F.reduce((q,Q)=>q+Number(Q.value||0),0),I=P*(_.default_probability/100);return{stageId:_.id,stageName:_.name,count:w,value:P,weightedValue:I}}):[],[k,b,o]),O=i.useCallback(async(N={})=>{try{const _=Object.values(k).flat();if(_.length===0)throw new Error("No deals to export with current filters");const I={filename:`pipeline-export-${re(new Date,"yyyy-MM-dd-HHmm")}${t?"-filtered":"-all-owners"}.csv`,...N};await qt(_,b,I),E.log(`Successfully exported ${_.length} deals to CSV`)}catch(_){throw _}},[k,b,t,o]),H=i.useCallback(()=>{const N=Object.values(k).flat();return Ut(N,b)},[k,b,o]),ee=i.useMemo(()=>({deals:m,stages:b,isLoading:n||v,error:A||C,createDeal:j,updateDeal:l,deleteDeal:p,moveDealToStage:S,forceUpdateDealStage:T,refreshDeals:V,searchTerm:h,setSearchTerm:R,filterOptions:y,setFilterOptions:D,dealsByStage:k,pipelineValue:Z,weightedPipelineValue:W,activePipelineValue:s,stageMetrics:c,selectedOwnerId:t,setSelectedOwnerId:d,dateFilterPreset:$,setDateFilterPreset:K,customDateRange:z,setCustomDateRange:f,exportPipeline:O,getExportSummary:H}),[m,b,n,v,A,C,j,l,p,S,T,V,h,R,y,D,k,Z,W,s,c,t,d,$,K,z,f,O,H,o]);return e.jsx(Je.Provider,{value:ee,children:r})}function et(){const r=i.useContext(Je);if(r===void 0)throw new Error("usePipeline must be used within a PipelineProvider");return r}function zt({open:r,onOpenChange:a,deal:t}){const[d,o]=i.useState({userId:"",percentage:0,notes:""}),[g,u]=i.useState(null),[v,C]=i.useState({percentage:0,notes:""}),{users:b}=dt(),{userData:m}=We(),{splits:n,createSplit:A,updateSplit:j,deleteSplit:l,calculateSplitTotals:p,canSplitDeal:S}=Bt({dealId:t.id}),T=i.useMemo(()=>p(t.id),[p,t.id]),L=i.useMemo(()=>{const f=n.map(B=>B.user_id);return b.filter(B=>!f.includes(B.id)&&B.id!==t.owner_id)},[b,n,t.owner_id]),V=async()=>{if(!d.userId||d.percentage<=0){Y.error("Please select a user and enter a valid percentage");return}try{await A({deal_id:t.id,user_id:d.userId,percentage:d.percentage,notes:d.notes||void 0}),o({userId:"",percentage:0,notes:""})}catch{}},h=f=>{u(f.id),C({percentage:f.percentage,notes:f.notes||""})},R=async()=>{if(g)try{await j(g,{percentage:v.percentage,notes:v.notes||void 0}),u(null)}catch{}},y=()=>{u(null),C({percentage:0,notes:""})},D=async f=>{if(!m?.is_admin){Y.error("Only administrators can remove deal splits");return}window.confirm("Are you sure you want to remove this split?")&&await l(f)},$=f=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0}).format(f),K=(f,B)=>`${f?.[0]||""}${B?.[0]||""}`.toUpperCase()||"?",z=Math.min(100-T.totalPercentage,100);return e.jsx(Le,{open:r,onOpenChange:a,children:e.jsxs(qe,{className:"max-w-4xl max-h-[90vh] overflow-y-auto bg-gray-950 border border-gray-800",children:[e.jsxs(Ue,{children:[e.jsxs(Be,{className:"flex items-center gap-2 text-xl text-white",children:[e.jsx(Ke,{className:"w-5 h-5 text-blue-500"}),"Split Deal: ",t.name]}),e.jsxs("div",{className:"text-sm text-gray-400",children:["Deal Value: ",$(t.value)," â€¢ Owner: You"]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(ie,{className:"bg-gray-900/50 border-gray-800",children:[e.jsx(Se,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-gray-200",children:[e.jsx(bt,{className:"w-4 h-4"}),"Split Summary"]})}),e.jsx(ne,{children:e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold text-blue-400",children:[T.totalPercentage,"%"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Allocated"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-green-400",children:$(T.totalAmount)}),e.jsx("div",{className:"text-xs text-gray-400",children:"Split Amount"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold text-orange-400",children:[T.remainingPercentage,"%"]}),e.jsx("div",{className:"text-xs text-gray-400",children:"Remaining"})]})]})})]}),n.length>0&&e.jsxs(ie,{className:"bg-gray-900/50 border-gray-800",children:[e.jsx(Se,{children:e.jsxs(_e,{className:"flex items-center justify-between text-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ge,{className:"w-4 h-4"}),"Current Splits (",n.length,")"]}),!m?.is_admin&&e.jsx("span",{className:"text-xs text-gray-500 font-normal",children:"Only admins can remove splits"})]})}),e.jsx(ne,{children:e.jsx("div",{className:"space-y-3",children:n.map(f=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-800/50 rounded-lg border border-gray-700",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ht,{className:"w-8 h-8",children:e.jsx(xt,{className:"bg-blue-600 text-white text-xs",children:K(f.first_name,f.last_name)})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-white",children:f.full_name||`${f.first_name} ${f.last_name}`.trim()}),e.jsx("div",{className:"text-xs text-gray-400",children:f.email})]})]}),g===f.id?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{type:"number",value:v.percentage,onChange:B=>C({...v,percentage:parseFloat(B.target.value)||0}),className:"w-20 h-8 text-xs",min:"0",max:"100",step:"0.1"}),e.jsx("span",{className:"text-xs text-gray-400",children:"%"}),e.jsx(G,{size:"sm",onClick:R,className:"h-8 w-8 p-0 bg-green-600 hover:bg-green-700",children:e.jsx(He,{className:"w-3 h-3"})}),e.jsx(G,{size:"sm",variant:"ghost",onClick:y,className:"h-8 w-8 p-0 hover:bg-gray-700",children:e.jsx(Ge,{className:"w-3 h-3"})})]}):e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-right",children:[e.jsxs(me,{variant:"outline",className:"text-blue-400 border-blue-400",children:[f.percentage,"%"]}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:$(f.amount)})]}),e.jsx(G,{size:"sm",variant:"ghost",onClick:()=>h(f),className:"h-8 w-8 p-0 hover:bg-gray-700",children:e.jsx(Qe,{className:"w-3 h-3"})}),m?.is_admin&&e.jsx(G,{size:"sm",variant:"ghost",onClick:()=>D(f.id),className:"h-8 w-8 p-0 hover:bg-red-900 text-red-400",title:"Admin only: Remove split",children:e.jsx(Ye,{className:"w-3 h-3"})})]})]},f.id))})})]}),S(t.id)&&L.length>0&&e.jsxs(ie,{className:"bg-gray-900/50 border-gray-800",children:[e.jsx(Se,{children:e.jsxs(_e,{className:"flex items-center gap-2 text-gray-200",children:[e.jsx(Te,{className:"w-4 h-4"}),"Add Split"]})}),e.jsxs(ne,{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(Ne,{htmlFor:"user",className:"text-gray-300",children:"Team Member"}),e.jsxs(pe,{value:d.userId,onValueChange:f=>o({...d,userId:f}),children:[e.jsx(ye,{className:"bg-gray-800 border-gray-700 text-white",children:e.jsx(ve,{placeholder:"Select team member"})}),e.jsx(je,{className:"bg-gray-800 border-gray-700",children:L.map(f=>e.jsxs(J,{value:f.id,className:"text-white",children:[f.first_name," ",f.last_name]},f.id))})]})]}),e.jsxs("div",{children:[e.jsxs(Ne,{htmlFor:"percentage",className:"text-gray-300",children:["Percentage (Max: ",z,"%)"]}),e.jsx(le,{id:"percentage",type:"number",value:d.percentage||"",onChange:f=>o({...d,percentage:parseFloat(f.target.value)||0}),className:"bg-gray-800 border-gray-700 text-white",placeholder:"Enter percentage",min:"0",max:z,step:"0.1"})]})]}),e.jsxs("div",{children:[e.jsx(Ne,{htmlFor:"notes",className:"text-gray-300",children:"Notes (Optional)"}),e.jsx(gt,{id:"notes",value:d.notes,onChange:f=>o({...d,notes:f.target.value}),className:"bg-gray-800 border-gray-700 text-white",placeholder:"Add any notes about this split...",rows:2})]}),d.percentage>0&&e.jsx("div",{className:"p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg",children:e.jsxs("div",{className:"text-sm text-blue-400",children:["Split Amount: ",$(t.value*(d.percentage/100))]})}),e.jsxs(G,{onClick:V,disabled:!d.userId||d.percentage<=0||d.percentage>z,className:"w-full bg-blue-600 hover:bg-blue-700",children:[e.jsx(Te,{className:"w-4 h-4 mr-2"}),"Add Split"]})]})]}),!S(t.id)&&e.jsx(ie,{className:"bg-amber-500/10 border-amber-500/20",children:e.jsx(ne,{className:"p-4",children:e.jsx("div",{className:"text-amber-400 text-sm",children:"This deal is fully allocated (100%). Remove existing splits to add new ones."})})}),S(t.id)&&L.length===0&&e.jsx(ie,{className:"bg-gray-500/10 border-gray-500/20",children:e.jsx(ne,{className:"p-4",children:e.jsx("div",{className:"text-gray-400 text-sm",children:"All available team members already have splits on this deal."})})})]}),e.jsx(ze,{children:e.jsx(G,{variant:"outline",onClick:()=>a(!1),className:"border-gray-700 text-gray-300 hover:bg-gray-800",children:"Close"})})]})})}const tt=i.createContext(void 0),at={dealName:"",company:"",contactName:"",closeDate:"",dealValue:"",stage:"lead",probability:20,priority:"medium",dealSize:"medium",leadSource:{type:"inbound",channel:""},nextAction:"",description:"",errors:{}};function Wt(r,a){switch(a.type){case"INITIALIZE_FORM":return{...at,...a.payload};case"UPDATE_FIELD":return{...r,[a.field]:a.value,errors:{...r.errors,[a.field]:void 0}};case"UPDATE_LEAD_SOURCE":return{...r,leadSource:{...r.leadSource,[a.field]:a.value}};case"SET_ERROR":return{...r,errors:{...r.errors,[a.field]:a.message}};case"CLEAR_ERROR":const t={...r.errors};return delete t[a.field],{...r,errors:t};default:return r}}const Kt=({children:r,deal:a})=>{const[t,d]=i.useReducer(Wt,at);i.useEffect(()=>{a&&d({type:"INITIALIZE_FORM",payload:{dealName:a.dealName||a.name||"",company:a.company||"",contactName:a.contactName||a.contact_name||"",closeDate:a.closeDate||a.expected_close_date||"",dealValue:a.dealValue||a.value||"",stage:a.stage||"lead",probability:a.probability||20,priority:a.priority||"medium",dealSize:a.dealSize||a.size||"medium",leadSource:a.leadSource||{type:"inbound",channel:""},nextAction:a.nextAction||"",description:a.description||""}})},[a]);const o=(m,n)=>{d({type:"UPDATE_FIELD",field:m,value:n})},g=(m,n)=>{d({type:"UPDATE_LEAD_SOURCE",field:m,value:n})},u=(m,n)=>{d({type:"SET_ERROR",field:m,message:n})},v=m=>{d({type:"CLEAR_ERROR",field:m})},C=()=>{let m=!0;t.dealName||(u("dealName","Deal name is required"),m=!1),t.company||(u("company","Company is required"),m=!1);const n=parseFloat(t.dealValue);return(!t.dealValue||isNaN(n)||n<=0)&&(u("dealValue","Deal value must be greater than 0"),m=!1),m},b=()=>{const{errors:m,...n}=t;return{...n,dealValue:parseFloat(t.dealValue)||0,probability:parseInt(t.probability.toString())}};return e.jsx(tt.Provider,{value:{state:t,updateField:o,updateLeadSource:g,setError:u,clearError:v,validateForm:C,getFormData:b},children:r})},Ht=()=>{const r=i.useContext(tt);if(r===void 0)throw new Error("useEditDeal must be used within an EditDealProvider");return r},Gt=({activeTab:r,onTabChange:a})=>{const t=i.useRef(new Map),d=[{id:"details",label:"Deal Details"},{id:"stage",label:"Pipeline Stage"},{id:"source",label:"Lead Source"},{id:"activity",label:"Activity"}];i.useEffect(()=>{r&&setTimeout(()=>{const g=t.current.get(r);g&&g.focus()},0)},[r]);const o=(g,u)=>{switch(Array.from(t.current.values()),g.key){case"ArrowRight":if(g.preventDefault(),u<d.length-1){const b=d[u+1];a(b.id),t.current.get(b.id)?.focus()}break;case"ArrowLeft":if(g.preventDefault(),u>0){const b=d[u-1];a(b.id),t.current.get(b.id)?.focus()}break;case"Home":g.preventDefault();const v=d[0];a(v.id),t.current.get(v.id)?.focus();break;case"End":g.preventDefault();const C=d[d.length-1];a(C.id),t.current.get(C.id)?.focus();break}};return e.jsx("div",{role:"tablist","aria-label":"Deal sections",className:"flex px-6",children:d.map((g,u)=>e.jsx("button",{id:`tab-${g.id}`,role:"tab","aria-selected":r===g.id,"aria-controls":`${g.id}-section`,tabIndex:r===g.id?0:-1,className:`py-4 px-6 text-sm font-medium border-b-2 transition-colors focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-inset ${r===g.id?"text-white border-violet-500":"text-gray-400 hover:text-gray-300 border-transparent hover:border-gray-700"}`,onClick:()=>a(g.id),onKeyDown:v=>o(v,u),ref:v=>{v&&t.current.set(g.id,v)},children:g.label},g.id))})},Qt=({initialFocusRef:r})=>{const{register:a,watch:t,getValues:d,formState:{errors:o},setValue:g}=Pe(),[u,v]=i.useState(!1),[C,b]=i.useState(t("closeDate")?new Date(t("closeDate")):void 0),[m,n]=i.useState(t("contactName")||""),[A,j]=i.useState([]),[l,p]=i.useState(null),[S,T]=i.useState(!1),{searchContacts:L}=ut(),V=[{value:"low",label:"Low",icon:"ðŸŸ¢",color:"bg-green-500/20 text-green-400 border-green-500/30",ringColor:"ring-green-500/30"},{value:"medium",label:"Medium",icon:"ðŸŸ¡",color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30",ringColor:"ring-yellow-500/30"},{value:"high",label:"High",icon:"ðŸŸ ",color:"bg-orange-500/20 text-orange-400 border-orange-500/30",ringColor:"ring-orange-500/30"},{value:"critical",label:"Critical",icon:"ðŸ”´",color:"bg-red-500/20 text-red-400 border-red-500/30",ringColor:"ring-red-500/30"}],h=[{id:"inbound",label:"Inbound"},{id:"outbound",label:"Outbound"},{id:"event",label:"Event"},{id:"referral",label:"Referral"}],R={inbound:[{id:"website",label:"Website"},{id:"facebook",label:"Facebook"},{id:"linkedin",label:"LinkedIn"},{id:"twitter",label:"Twitter"},{id:"email",label:"Email"},{id:"organic-search",label:"Organic Search"}],outbound:[{id:"cold-call",label:"Cold Call"},{id:"linkedin",label:"LinkedIn"},{id:"email",label:"Email Campaign"},{id:"other",label:"Other"}],event:[{id:"webinar",label:"Webinar"},{id:"conference",label:"Conference"},{id:"trade-show",label:"Trade Show"},{id:"in-person",label:"In Person"}],referral:[{id:"client",label:"Client"},{id:"partner",label:"Partner"},{id:"employee",label:"Employee"},{id:"other",label:"Other"}]},y=t("leadSourceType")||"inbound",D=t("leadSourceChannel"),$=s=>{g("leadSourceType",s,{shouldValidate:!0}),g("leadSourceChannel","",{shouldValidate:!0})},K=s=>{g("leadSourceChannel",s,{shouldValidate:!0})},z=()=>{const s=new Date;return[{label:"End of Week",value:re(he(Pt(s,{weekStartsOn:1}),4),"yyyy-MM-dd"),icon:"ðŸ“…",description:"This Friday"},{label:"This time next week",value:re(Rt(s,1),"yyyy-MM-dd"),icon:"ðŸ—“ï¸",description:"Same day next week"},{label:"End of Month",value:re(he(Me(s,1),-1),"yyyy-MM-dd"),icon:"ðŸ“Š",description:"Month end"},{label:"Next Month",value:re(he(Me(s,1),15),"yyyy-MM-dd"),icon:"ðŸ“ˆ",description:"Mid next month"}]},f=s=>{if(b(s),v(!1),s){const O={target:{name:"closeDate",value:re(s,"yyyy-MM-dd")}};a("closeDate").onChange(O)}},B=s=>{const c=new Date(s);b(c);const O={target:{name:"closeDate",value:s}};a("closeDate").onChange(O)},X=s=>{if(!s)return"Select expected close date...";const c=re(s,"MMM dd, yyyy");return Vt(s)?`${c} (Today)`:Ft(s)?`${c} (Tomorrow)`:Mt(s)?`${c} (This Week)`:Ot(s)?`${c} (This Month)`:c},x=async s=>{if(n(s),s.length<2){j([]),T(!1);return}try{const c=await L(s);j(c.slice(0,10)),T(c.length===0)}catch{j([]),T(!0)}},k=s=>{p(s);const c=s.full_name||`${s.first_name||""} ${s.last_name||""}`.trim();n(c),j([]),T(!1),g("contactName",c),g("contactEmail",s.email||""),g("contactPhone",s.phone||"")},Z=()=>{const s=m.trim();s&&(p({full_name:s,isNew:!0}),g("contactName",s),j([]),T(!1))},W=()=>{p(null),n(""),j([]),T(!1),g("contactName",""),g("contactEmail",""),g("contactPhone","")};return e.jsxs("div",{id:"details-section",role:"tabpanel","aria-labelledby":"tab-details",children:[e.jsx(oe,{icon:e.jsx(de,{className:"w-4 h-4"}),title:"Basic Information"}),e.jsxs(te,{id:"dealName",label:"Deal Name",required:!0,error:o?.name?.message,className:"mb-4",children:[e.jsx(ce,{id:"name",icon:e.jsx(de,{className:"w-4 h-4"}),placeholder:"Enter deal name","aria-required":"true","aria-invalid":!!o?.name,"aria-describedby":o?.name?"name-error":void 0,...a("name",{required:"Deal name is required."})}),o?.name&&e.jsx(ae,{id:"name-error",children:o.name.message})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs(te,{id:"company",label:"Company",required:!0,error:o?.company?.message,children:[e.jsx(ce,{id:"company",icon:e.jsx(ft,{className:"w-4 h-4"}),placeholder:"Enter company name","aria-required":"true","aria-invalid":!!o?.company,"aria-describedby":o?.company?"company-error":void 0,...a("company",{required:"Company name is required."})}),o?.company&&e.jsx(ae,{id:"company-error",children:o.company.message})]}),e.jsx(te,{id:"contactName",label:"Contact",children:e.jsxs("div",{className:"relative",children:[l?e.jsxs("div",{className:"bg-gray-900/80 border border-gray-700 rounded-lg py-3 px-4 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold",children:l.full_name?.[0]||l.first_name?.[0]||"?"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-white font-medium",children:l.full_name||`${l.first_name||""} ${l.last_name||""}`.trim()}),l.email&&e.jsx("div",{className:"text-gray-400 text-sm",children:l.email}),l.isNew&&e.jsx(me,{variant:"outline",className:"text-xs bg-green-500/20 text-green-400 border-green-500/30 mt-1",children:"New Contact"})]})]}),e.jsx("button",{type:"button",onClick:W,className:"text-gray-400 hover:text-white transition-colors",children:"Ã—"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(pt,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx("input",{type:"text",value:m,onChange:s=>x(s.target.value),placeholder:"Search contacts by name, email, or company...",className:`w-full bg-gray-900/80 border border-gray-700 rounded-lg py-3 pl-10 pr-3 
                      text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-violet-500 
                      focus:border-violet-500 transition-colors`})]}),(A.length>0||S)&&e.jsxs("div",{className:"absolute top-full left-0 right-0 mt-1 bg-gray-800/95 border border-gray-600/50 rounded-xl shadow-lg z-50 max-h-64 overflow-y-auto",children:[A.map(s=>e.jsxs("div",{onClick:()=>k(s),className:"flex items-center gap-3 p-3 hover:bg-gray-700/50 cursor-pointer border-b border-gray-700/30 last:border-b-0",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white text-sm font-bold",children:s.first_name?.[0]||s.full_name?.[0]||"?"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-white font-medium",children:s.full_name||`${s.first_name||""} ${s.last_name||""}`.trim()}),s.email&&e.jsx("div",{className:"text-gray-400 text-sm",children:s.email}),s.company&&e.jsx("div",{className:"text-gray-500 text-xs",children:s.company})]}),e.jsx(me,{variant:"outline",className:"text-xs bg-blue-500/20 text-blue-400 border-blue-500/30",children:"Select"})]},s.id)),S&&m.trim()&&e.jsxs("div",{onClick:Z,className:"flex items-center gap-3 p-3 hover:bg-gray-700/50 cursor-pointer border-t border-gray-700/30",children:[e.jsx("div",{className:"w-8 h-8 bg-gradient-to-br from-green-500 to-emerald-500 rounded-full flex items-center justify-center text-white",children:e.jsx(Te,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"text-white font-medium",children:['Create "',m.trim(),'"']}),e.jsx("div",{className:"text-gray-400 text-sm",children:"Add as new contact"})]}),e.jsx(me,{variant:"outline",className:"text-xs bg-green-500/20 text-green-400 border-green-500/30",children:"Create"})]})]})]}),e.jsx("input",{type:"hidden",...a("contactName")})]})})]}),t("contactName")&&e.jsxs(e.Fragment,{children:[e.jsx(oe,{icon:e.jsx(yt,{className:"w-4 h-4"}),title:"Contact Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsx(te,{id:"contactEmail",label:"Email Address",children:e.jsx(ce,{id:"contactEmail",icon:e.jsx(fe,{className:"w-4 h-4"}),type:"email",placeholder:"contact@company.com",...a("contactEmail")})}),e.jsx(te,{id:"contactPhone",label:"Phone Number",children:e.jsx(ce,{id:"contactPhone",icon:e.jsx(vt,{className:"w-4 h-4"}),type:"tel",placeholder:"+44 20 1234 5678",...a("contactPhone")})})]})]}),e.jsx(oe,{icon:e.jsx(Xe,{className:"w-4 h-4"}),title:"Lead Source"}),e.jsx("input",{type:"hidden",...a("leadSourceType")}),e.jsx("input",{type:"hidden",...a("leadSourceChannel")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:h.map(s=>e.jsx("button",{type:"button",className:`px-3 py-1.5 text-xs font-medium rounded border transition-all
              ${y===s.id?"bg-violet-500/10 border-violet-500/30 text-violet-400":"bg-gray-900/80 border-gray-700 text-gray-400 hover:bg-gray-800 hover:border-gray-600"}`,onClick:()=>$(s.id),"aria-pressed":y===s.id,children:s.label},s.id))}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 mb-4",children:R[y]?.map(s=>e.jsxs("button",{type:"button",onClick:()=>K(s.id),className:`flex items-center gap-1.5 p-2 border rounded transition-all text-xs font-medium
              ${D===s.id?"border-emerald-500/30 bg-emerald-500/10 text-emerald-400":"border-gray-700 bg-gray-900/80 text-gray-400 hover:bg-gray-800 hover:border-gray-600"}`,"aria-pressed":D===s.id,children:[e.jsx("div",{className:`w-3 h-3 rounded-full border flex items-center justify-center 
                ${D===s.id?"border-emerald-400":"border-gray-600"}`,children:D===s.id&&e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-emerald-400","aria-hidden":"true"})}),e.jsx("span",{children:s.label})]},s.id))}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-violet-500/10 border border-violet-500/20 rounded-lg text-violet-400 text-sm mb-6",children:[e.jsx(Ze,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Changing the lead source will update attribution reporting for this deal."})]}),e.jsx(oe,{icon:e.jsx(se,{className:"w-4 h-4"}),title:"Deal Timeline & Value"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs(te,{id:"closeDate",label:"Expected Close Date",error:o?.closeDate?.message,children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:z().map(s=>e.jsx("button",{type:"button",onClick:()=>B(s.value),className:`p-3 rounded-lg border transition-all duration-200 group text-left hover:scale-[1.02] ${t("closeDate")===s.value?"bg-violet-500/20 border-violet-500/50 text-violet-300 shadow-lg shadow-violet-500/10":"bg-gray-800/30 border-gray-600/30 text-gray-300 hover:bg-gray-700/50 hover:border-gray-500/50 hover:shadow-md"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm group-hover:scale-110 transition-transform duration-200",children:s.icon}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-xs font-medium truncate",children:s.label}),e.jsx("div",{className:"text-xs opacity-70 truncate",children:s.description})]})]})},s.label))}),e.jsxs(Tt,{open:u,onOpenChange:v,children:[e.jsx(At,{asChild:!0,children:e.jsxs("button",{type:"button",className:`w-full bg-gray-900/80 border border-gray-700 rounded-lg py-3 px-4 
                      text-white hover:bg-gray-800/80 hover:border-gray-600 focus:outline-none 
                      focus:ring-1 focus:ring-violet-500 focus:border-violet-500 transition-all duration-200
                      flex items-center gap-3 text-left hover:shadow-lg hover:scale-[1.01] group`,children:[e.jsx(se,{className:"w-4 h-4 text-gray-400 group-hover:text-violet-400 transition-colors duration-200 flex-shrink-0"}),e.jsx("span",{className:`transition-colors duration-200 ${C?"text-white":"text-gray-500 group-hover:text-gray-400"}`,children:X(C)})]})}),e.jsx($t,{className:"w-auto p-0 bg-gray-900/95 backdrop-blur-xl border border-gray-800/50 rounded-xl shadow-2xl shadow-black/20",align:"start",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(se,{className:"w-5 h-5 text-violet-400"}),e.jsx("span",{className:"font-medium text-white",children:"Expected Close Date"})]}),e.jsx("button",{type:"button",onClick:()=>{b(void 0);const s={target:{name:"closeDate",value:""}};a("closeDate").onChange(s)},className:"text-xs text-gray-400 hover:text-white transition-colors",children:"Clear"})]}),e.jsx(mt,{mode:"single",selected:C,onSelect:f,disabled:s=>s<new Date,className:"rounded-md",classNames:{months:"text-white",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center text-white",caption_label:"text-sm font-medium text-white",nav:"space-x-1 flex items-center",nav_button:"h-7 w-7 bg-transparent p-0 text-gray-400 hover:text-white hover:bg-gray-800/50 rounded-md transition-colors",nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-gray-400 rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"text-center text-sm p-0 relative focus-within:relative focus-within:z-20",day:"h-9 w-9 p-0 font-normal text-white hover:bg-violet-500/20 rounded-md transition-colors",day_selected:"bg-violet-500 text-white hover:bg-violet-600 focus:bg-violet-500 focus:text-white",day_today:"bg-gray-800/70 text-white font-medium",day_outside:"text-gray-500 opacity-50",day_disabled:"text-gray-500 opacity-30 cursor-not-allowed",day_hidden:"invisible"},components:{IconLeft:()=>e.jsx(wt,{className:"h-4 w-4"}),IconRight:()=>e.jsx(jt,{className:"h-4 w-4"})}})]})})]}),e.jsx("input",{type:"hidden",...a("closeDate"),"aria-invalid":!!o?.closeDate,"aria-describedby":o?.closeDate?"closeDate-error":void 0})]}),o?.closeDate&&e.jsx(ae,{id:"closeDate-error",children:o.closeDate.message})]}),e.jsxs(te,{id:"firstBillingDate",label:"First Billing Date",error:o?.firstBillingDate?.message,children:[e.jsx(ce,{id:"firstBillingDate",type:"date",icon:e.jsx(se,{className:"w-4 h-4"}),placeholder:"Select first billing date...",...a("firstBillingDate"),"aria-invalid":!!o?.firstBillingDate,"aria-describedby":o?.firstBillingDate?"firstBillingDate-error":void 0}),o?.firstBillingDate&&e.jsx(ae,{id:"firstBillingDate-error",children:o.firstBillingDate.message}),e.jsx("div",{className:"mt-1 text-xs text-gray-500",children:"When should billing/invoicing begin for this deal? (Optional)"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-800/20 border border-gray-700/30 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Nt,{className:"w-4 h-4 text-emerald-400"}),e.jsx("h4",{className:"text-sm font-medium text-gray-300",children:"Deal Revenue"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs(te,{id:"oneOffRevenue",label:"One-off Revenue (Â£)",error:o?.oneOffRevenue?.message,children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none",children:"Â£"}),e.jsx("input",{id:"oneOffRevenue",type:"number",placeholder:"0",min:"0",step:"0.01","aria-invalid":!!o?.oneOffRevenue,"aria-describedby":o?.oneOffRevenue?"oneOffRevenue-error":void 0,className:`w-full bg-gray-900/80 border border-gray-700 rounded-lg py-3 pl-8 pr-3 
                      text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-violet-500 
                      focus:border-violet-500 transition-colors`,...a("oneOffRevenue",{valueAsNumber:!0,min:{value:0,message:"Value must be non-negative."}})})]}),o?.oneOffRevenue&&e.jsx(ae,{id:"oneOffRevenue-error",children:o.oneOffRevenue.message})]}),e.jsxs(te,{id:"monthlyMrr",label:"Monthly Recurring Revenue (Â£)",error:o?.monthlyMrr?.message,children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none",children:"Â£"}),e.jsx("input",{id:"monthlyMrr",type:"number",placeholder:"0",min:"0",step:"0.01","aria-invalid":!!o?.monthlyMrr,"aria-describedby":o?.monthlyMrr?"monthlyMrr-error":void 0,className:`w-full bg-gray-900/80 border border-gray-700 rounded-lg py-3 pl-8 pr-3 
                      text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-violet-500 
                      focus:border-violet-500 transition-colors`,...a("monthlyMrr",{valueAsNumber:!0,min:{value:0,message:"Value must be non-negative."}})})]}),o?.monthlyMrr&&e.jsx(ae,{id:"monthlyMrr-error",children:o.monthlyMrr.message})]}),(t("oneOffRevenue")||t("monthlyMrr"))&&e.jsxs("div",{className:"p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-lg",children:[e.jsxs("div",{className:"text-sm text-emerald-400",children:[e.jsx("span",{className:"font-medium",children:"Total Deal Value: "}),"Â£",((parseFloat(t("oneOffRevenue"))||0)+(parseFloat(t("monthlyMrr"))||0)*3).toLocaleString("en-GB",{minimumFractionDigits:0,maximumFractionDigits:0})]}),t("monthlyMrr")&&parseFloat(t("monthlyMrr"))>0&&e.jsxs("div",{className:"text-xs text-gray-400 mt-1",children:["Annual Value: Â£",((parseFloat(t("oneOffRevenue"))||0)+(parseFloat(t("monthlyMrr"))||0)*12).toLocaleString("en-GB",{minimumFractionDigits:0,maximumFractionDigits:0})]})]})]})]}),e.jsxs("div",{className:"bg-gray-800/20 border border-gray-700/30 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(St,{className:"w-4 h-4 text-yellow-400"}),e.jsx("h4",{className:"text-sm font-medium text-gray-300",children:"Deal Priority"})]}),e.jsx("input",{type:"hidden",...a("priority")}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:V.map(s=>e.jsx("button",{type:"button",onClick:()=>g("priority",s.value,{shouldValidate:!0}),className:`p-3 rounded-xl border transition-all ${t("priority")===s.value?`${s.color} ${s.ringColor} ring-2`:"bg-gray-800/30 border-gray-600/30 text-gray-400 hover:bg-gray-700/50"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-base",children:s.icon}),e.jsx("span",{className:"text-xs font-medium",children:s.label})]})},s.value))}),o?.priority&&e.jsx(ae,{id:"priority-error",children:o.priority.message})]})]})]}),e.jsx(oe,{icon:e.jsx(Ve,{className:"w-4 h-4"}),title:"Additional Details"}),e.jsxs(te,{id:"notes",label:"Description & Notes",className:"mb-4",error:o?.notes?.message,children:[e.jsx(Yt,{id:"notes",icon:e.jsx(Ve,{className:"w-4 h-4"}),placeholder:"Add description or notes about this deal...",rows:4,defaultValue:d("notes"),...a("notes")}),o?.notes&&e.jsx(ae,{id:"notes-error",children:o.notes.message})]})]})},oe=({icon:r,title:a})=>e.jsxs("div",{className:"flex items-center gap-2 mb-4 text-gray-400 text-sm font-medium",children:[e.jsx("div",{className:"flex items-center justify-center",children:r}),e.jsx("span",{children:a})]}),te=({id:r,label:a,children:t,required:d,error:o,className:g})=>e.jsxs("div",{className:g,children:[e.jsxs("label",{htmlFor:r,className:"block text-sm font-medium text-gray-400 mb-1.5",children:[a,d&&e.jsx("span",{className:"text-red-500 ml-1",children:"*"})]}),t]}),ce=$e.forwardRef(({icon:r,className:a,...t},d)=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500",children:r}),e.jsx("input",{ref:d,className:`w-full bg-gray-900/80 border border-gray-700 rounded-lg py-2.5 pl-10 pr-3 
          text-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-violet-500 
          focus:border-violet-500 transition-colors ${a||""}`,...t})]}));$e.forwardRef(({icon:r,children:a,...t},d)=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500",children:r}),e.jsx("select",{ref:d,className:`w-full appearance-none bg-gray-900/80 border border-gray-700 rounded-lg py-2.5 pl-10 pr-9
          text-white focus:outline-none focus:ring-1 focus:ring-violet-500 focus:border-violet-500 transition-colors`,...t,children:a}),e.jsx("div",{className:"absolute right-3 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-500",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"6 9 12 15 18 9"})})})]}));const Yt=$e.forwardRef(({icon:r,...a},t)=>e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-3 top-3 text-gray-500",children:r}),e.jsx("textarea",{ref:t,className:`w-full bg-gray-900/80 border border-gray-700 rounded-lg py-2.5 pl-10 pr-3
          text-white placeholder-gray-500 focus:outline-none focus:ring-1 
          focus:ring-violet-500 focus:border-violet-500 transition-colors resize-none`,...a})]})),ae=({id:r,children:a})=>e.jsx("p",{id:r,className:"mt-1.5 text-sm text-red-400",children:a}),rt=i.forwardRef(({id:r,name:a,probability:t,color:d,isSelected:o,onClick:g,onKeyDown:u,"aria-checked":v,"data-stage-option":C,tabIndex:b=0,...m},n)=>{const A=()=>{if(!o)return"border-gray-700 bg-gray-900/80 hover:border-gray-600 hover:bg-gray-900";switch(r){case"lead":return"border-blue-500/30 bg-blue-500/10 shadow-blue-500/10";case"discovery":return"border-violet-500/30 bg-violet-500/10 shadow-violet-500/10";case"proposal":return"border-orange-500/30 bg-orange-500/10 shadow-orange-500/10";case"negotiation":return"border-yellow-500/30 bg-yellow-500/10 shadow-yellow-500/10";case"closed":case"signed":case"lost":return"border-emerald-500/30 bg-emerald-500/10 shadow-emerald-500/10";default:return"border-violet-500/30 bg-violet-500/10 shadow-violet-500/10"}},j=l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),g()),u&&u(l)};return e.jsxs("div",{ref:n,role:"radio","aria-checked":v||o,tabIndex:b,onClick:g,onKeyDown:j,"data-stage-option":C,className:`relative flex flex-col items-center justify-center gap-1.5 py-3 border rounded-lg transition-all shadow-sm ${A()} cursor-pointer focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-opacity-50`,...m,children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${d} mb-1`,"aria-hidden":"true"}),e.jsx("div",{className:"text-sm font-medium text-white",children:a}),e.jsxs("div",{className:"text-xs text-gray-400",children:[t,"%"]})]})});rt.displayName="StageOption";const Xt=({onStageChange:r,currentStage:a})=>{const{state:t,updateField:d}=Ht(),{stages:o}=et(),g=i.useRef(null);i.useEffect(()=>{g.current&&g.current.focus()},[]);const u=o&&o.length>0?o.map(n=>({id:n.id,name:n.name,probability:n.default_probability||0,color:`bg-${n.color||"blue"}-500`})):[{id:"lead",name:"Lead",probability:20,color:"bg-blue-500"},{id:"discovery",name:"Discovery",probability:40,color:"bg-violet-500"},{id:"proposal",name:"Proposal",probability:60,color:"bg-orange-500"},{id:"negotiation",name:"Negotiation",probability:80,color:"bg-yellow-500"},{id:"closed",name:"Closed/Won",probability:100,color:"bg-emerald-500"}],v=[{value:"demo",label:"Schedule Demo",icon:"ðŸŽ¯",color:"bg-blue-500/20 text-blue-400 border-blue-500/30"},{value:"proposal",label:"Send Proposal",icon:"ðŸ“‹",color:"bg-purple-500/20 text-purple-400 border-purple-500/30"},{value:"follow-up",label:"Follow-up Call",icon:"ðŸ“ž",color:"bg-green-500/20 text-green-400 border-green-500/30"},{value:"quote",label:"Send Quote",icon:"ðŸ’°",color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30"},{value:"contract",label:"Send Contract",icon:"ðŸ“„",color:"bg-indigo-500/20 text-indigo-400 border-indigo-500/30"},{value:"meeting",label:"Schedule Meeting",icon:"ðŸ¤",color:"bg-orange-500/20 text-orange-400 border-orange-500/30"},{value:"none",label:"No Action",icon:"âœ…",color:"bg-gray-500/20 text-gray-400 border-gray-500/30"}],C=n=>{d("stage",n);const A=u.find(j=>j.id===n);A&&d("probability",A.probability),r&&r(n)},b=(n,A)=>{if(n.key==="ArrowRight"||n.key==="ArrowDown"){n.preventDefault();const j=(A+1)%u.length,l=document.querySelectorAll("[data-stage-option]");l[j]&&l[j].focus()}else if(n.key==="ArrowLeft"||n.key==="ArrowUp"){n.preventDefault();const j=(A-1+u.length)%u.length,l=document.querySelectorAll("[data-stage-option]");l[j]&&l[j].focus()}},m=n=>a?n===a:t.stage===n;return e.jsxs("div",{id:"stage-section",role:"tabpanel","aria-labelledby":"tab-stage",className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx(Ce,{icon:e.jsx(_t,{className:"w-4 h-4"}),title:"Current Pipeline Stage"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-5 gap-2 mt-3",role:"radiogroup","aria-label":"Pipeline stages",children:u.map((n,A)=>e.jsx(rt,{id:n.id,name:n.name,probability:n.probability,color:n.color,isSelected:m(n.id),onClick:()=>C(n.id),ref:A===0?g:void 0,onKeyDown:j=>b(j,A),"aria-checked":m(n.id),"data-stage-option":!0,tabIndex:m(n.id)||A===0&&!a&&!t.stage?0:-1},n.id))})]}),e.jsxs("div",{children:[e.jsx(Ce,{icon:e.jsx(Ct,{className:"w-4 h-4"}),title:"Next Action"}),e.jsxs("div",{className:"mt-3",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2 mb-3",children:v.slice(0,4).map(n=>e.jsx("button",{type:"button",onClick:()=>d("nextAction",n.value),className:`p-3 rounded-xl border transition-all ${t.nextAction===n.value?`${n.color} ring-2 ring-opacity-50`:"bg-gray-800/30 border-gray-600/30 text-gray-400 hover:bg-gray-700/50"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-base",children:n.icon}),e.jsx("span",{className:"text-xs font-medium",children:n.label})]})},n.value))}),e.jsx("div",{className:"grid grid-cols-3 gap-2",children:v.slice(4).map(n=>e.jsx("button",{type:"button",onClick:()=>d("nextAction",n.value),className:`p-3 rounded-xl border transition-all ${t.nextAction===n.value?`${n.color} ring-2 ring-opacity-50`:"bg-gray-800/30 border-gray-600/30 text-gray-400 hover:bg-gray-700/50"}`,children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-base",children:n.icon}),e.jsx("span",{className:"text-xs font-medium",children:n.label})]})},n.value))}),t.nextAction&&e.jsx("button",{type:"button",onClick:()=>d("nextAction",""),className:"mt-2 w-full p-2 text-xs text-gray-400 hover:text-white transition-colors",children:"Clear Selection"})]})]}),e.jsxs("div",{children:[e.jsx(Ce,{icon:e.jsx(Dt,{className:"w-4 h-4"}),title:"Win Probability"}),e.jsxs("div",{className:"mt-3",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("input",{type:"text",value:`${t.probability}%`,readOnly:!0,"aria-label":"Current probability percentage",className:`w-14 text-center bg-gray-900/80 border border-gray-700 rounded-lg py-2 
                text-white focus:outline-none focus:ring-1 focus:ring-violet-500 focus:border-violet-500`}),e.jsx(It,{value:[Number(t.probability)],onValueChange:n=>d("probability",n[0]),min:0,max:100,step:5,className:"w-full","aria-label":"Adjust win probability"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"0%"}),e.jsx("p",{className:"text-xs text-gray-500",children:"100%"})]})]})]})]})},Ce=({icon:r,title:a})=>e.jsxs("div",{className:"flex items-center gap-2 text-gray-400 text-sm font-medium",children:[e.jsx("div",{className:"flex items-center justify-center",children:r}),e.jsx("span",{children:a})]}),Zt=({id:r,label:a,isSelected:t,onClick:d})=>e.jsxs("button",{type:"button",id:`channel-${r}`,onClick:d,className:`flex items-center gap-1.5 p-2 border rounded transition-all
        ${t?"border-emerald-500/30 bg-emerald-500/10 text-emerald-400":"border-gray-700 bg-gray-900/80 text-gray-400 hover:bg-gray-800 hover:border-gray-600"}`,"aria-pressed":t,children:[e.jsx("div",{className:`w-3.5 h-3.5 rounded-full border flex items-center justify-center 
          ${t?"border-emerald-400":"border-gray-600"}`,children:t&&e.jsx("div",{className:"w-1.5 h-1.5 rounded-full bg-emerald-400","aria-hidden":"true"})}),e.jsx("span",{className:"text-xs font-medium",children:a})]}),Jt=()=>{const{register:r,watch:a,setValue:t,formState:{errors:d}}=Pe(),o=a("leadSourceType"),g=a("leadSourceChannel"),u=[{id:"inbound",label:"Inbound"},{id:"outbound",label:"Outbound"},{id:"event",label:"Event"},{id:"referral",label:"Referral"}],v={inbound:[{id:"website",label:"Website"},{id:"facebook",label:"Facebook"},{id:"linkedin",label:"LinkedIn"},{id:"twitter",label:"Twitter"},{id:"email",label:"Email"},{id:"organic-search",label:"Organic Search"}],outbound:[{id:"cold-call",label:"Cold Call"},{id:"linkedin",label:"LinkedIn"},{id:"email",label:"Email Campaign"},{id:"other",label:"Other"}],event:[{id:"webinar",label:"Webinar"},{id:"conference",label:"Conference"},{id:"trade-show",label:"Trade Show"},{id:"in-person",label:"In Person"}],referral:[{id:"client",label:"Client"},{id:"partner",label:"Partner"},{id:"employee",label:"Employee"},{id:"other",label:"Other"}]},C=m=>{t("leadSourceType",m,{shouldValidate:!0}),t("leadSourceChannel","",{shouldValidate:!0})},b=m=>{t("leadSourceChannel",m,{shouldValidate:!0})};return e.jsxs("div",{id:"source-section",role:"tabpanel","aria-labelledby":"tab-source",children:[e.jsx(ea,{icon:e.jsx(Xe,{className:"w-4 h-4"}),title:"Lead Source"}),e.jsx("input",{type:"hidden",...r("leadSourceType")}),e.jsx("input",{type:"hidden",...r("leadSourceChannel")}),e.jsx("div",{className:"flex flex-wrap gap-2 mb-4",children:u.map(m=>e.jsx("button",{type:"button",className:`px-3 py-1.5 text-xs font-medium rounded border transition-all
              ${o===m.id?"bg-violet-500/10 border-violet-500/30 text-violet-400":"bg-gray-900/80 border-gray-700 text-gray-400 hover:bg-gray-800 hover:border-gray-600"}`,onClick:()=>C(m.id),"aria-pressed":o===m.id,children:m.label},m.id))}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 mb-6",children:v[o]?.map(m=>e.jsx(Zt,{id:m.id,label:m.label,isSelected:g===m.id,onClick:()=>b(m.id)},m.id))}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-violet-500/10 border border-violet-500/20 rounded-lg text-violet-400 text-sm mb-2",children:[e.jsx(Ze,{className:"w-4 h-4 mt-0.5 flex-shrink-0"}),e.jsx("span",{children:"Changing the lead source will update attribution reporting for this deal."})]})]})},ea=({icon:r,title:a})=>e.jsxs("div",{className:"flex items-center gap-2 mb-4 text-gray-400 text-sm font-medium",children:[e.jsx("div",{className:"flex items-center justify-center",children:r}),e.jsx("span",{children:a})]}),ta=({dealId:r})=>{const[a,t]=i.useState(""),[d,o]=i.useState(!1),[g,u]=i.useState(!1),[v,C]=i.useState(!1),b=i.useRef(null),{watch:m}=Pe(),n=m("name"),A=m("contactName"),j=m("contactEmail"),l=m("company"),[p,S]=i.useState([]),[T,L]=i.useState(!1),[V,h]=i.useState(null),[R,y]=i.useState([]),D=x=>x?x.split(`
`).filter(W=>W.trim()).filter(W=>W.match(/^\d{1,2}\/\d{1,2}\/\d{4}:/)).slice(0,3):[];i.useEffect(()=>{(async()=>{if(r)try{const{data:k}=await M.from("deals").select("notes").eq("id",r).single();k?.notes&&y(D(k.notes))}catch{}})()},[r]);const $=async x=>{if(!r){Y.error("No deal ID available");return}try{E.log("Creating activity:",{activityData:x,dealId:r});const{data:k}=await M.auth.getUser();if(!k.user)throw new Error("User not authenticated");E.log("User authenticated:",k.user.email);const Z=k.user.email||"Unknown Rep";if(x.activity_type==="note"){E.log("Adding note to deal...");const{data:W,error:s}=await M.from("deals").select("notes").eq("id",r).single();if(s)throw E.error("Error fetching current deal:",s),s;E.log("Current deal notes:",W?.notes);const c=W?.notes||"",O=`${new Date().toLocaleDateString()}: ${x.notes}

${c}`,{error:H}=await M.from("deals").update({notes:O}).eq("id",r);if(H)throw E.error("Error updating deal notes:",H),H;E.log("Note added successfully"),Y.success("Note added to deal"),y(D(O));return}else if(x.activity_type==="task"){E.log("Creating task in tasks table...");const{error:W}=await M.from("tasks").insert({title:x.notes,description:`Task created from deal: ${n||"Untitled Deal"}
Company: ${l||"Unknown"}
Contact: ${A||j||"Unknown"}`,due_date:x.due_date,priority:"medium",task_type:"follow_up",status:"pending",assigned_to:k.user.id,created_by:k.user.id,deal_id:r,contact_email:j,contact_name:A,company:l,completed:!1});if(W)throw E.error("Error creating task:",W),W;const{error:s}=await M.from("activities").insert({user_id:k.user.id,type:"outbound",status:"pending",priority:"medium",client_name:l||"Unknown Company",sales_rep:Z,details:`Task scheduled: ${x.notes}${x.due_date?` (Due: ${new Date(x.due_date).toLocaleDateString()})`:""}`,date:new Date().toISOString()});s&&E.warn("Activity record creation failed, but task was created successfully:",s),E.log("Task created successfully"),Y.success("Task scheduled and added to task list");return}else if(x.activity_type==="call"||x.activity_type==="email"){E.log(`Creating ${x.activity_type} activity...`);const W={user_id:k.user.id,type:"outbound",status:"completed",priority:"medium",client_name:l||"Unknown Company",sales_rep:Z,details:`${x.activity_type==="call"?"Call":"Email"}: ${x.notes||"No details provided"}`,date:new Date().toISOString()},s={...W,deal_id:r,contact_identifier:j,contact_identifier_type:"email",quantity:1};let{error:c}=await M.from("activities").insert(s);if(c&&c.message?.includes("column")){E.log("Enhanced columns not available, trying basic insert...");const{error:O}=await M.from("activities").insert(W);c=O}if(c)throw E.error(`Error creating ${x.activity_type} activity:`,c),c;E.log(`${x.activity_type} activity created successfully`),Y.success(`${x.activity_type==="call"?"Call":"Email"} logged successfully and added to activity tracking`);return}}catch(k){Y.error(`Failed to add activity: ${k?.message||"Unknown error"}`)}};if(T)return e.jsxs("div",{id:"activity-section",role:"tabpanel","aria-labelledby":"tab-activity",children:[e.jsx(De,{icon:e.jsx(ge,{className:"w-4 h-4"}),title:"Deal Activity"}),e.jsx("div",{className:"py-8 text-center text-gray-500",children:"Loading activities..."})]});if(V)return e.jsxs("div",{id:"activity-section",role:"tabpanel","aria-labelledby":"tab-activity",children:[e.jsx(De,{icon:e.jsx(ge,{className:"w-4 h-4"}),title:"Deal Activity"}),e.jsx("div",{className:"py-8 text-center text-red-500",children:"Error loading activities. Please try again."})]});const K=async x=>{x&&(x.preventDefault(),x.stopPropagation()),a.trim()&&r?(await $({activity_type:"note",notes:a.trim()}),t(""),b.current&&b.current.focus()):E.log("Note not added - missing note or dealId:",{note:a.trim(),dealId:r})},z=x=>{x&&(x.preventDefault(),x.stopPropagation()),o(!0)},f=x=>{x&&(x.preventDefault(),x.stopPropagation()),u(!0)},B=x=>{x&&(x.preventDefault(),x.stopPropagation()),C(!0)},X=x=>{(x.ctrlKey||x.metaKey)&&x.key==="Enter"&&(x.preventDefault(),K())};return e.jsxs("div",{id:"activity-section",role:"tabpanel","aria-labelledby":"tab-activity",children:[e.jsx(De,{icon:e.jsx(ge,{className:"w-4 h-4"}),title:"Deal Activity"}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{htmlFor:"activityNote",className:"block text-sm font-medium text-gray-300 mb-3",children:"Add Activity Note"}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx("div",{className:"absolute left-3 top-3 text-gray-400",children:e.jsx(Fe,{className:"w-4 h-4"})}),e.jsx("textarea",{id:"activityNote",ref:b,className:`w-full p-3 pl-10 bg-gray-800/50 border border-gray-700/50 
              rounded-xl focus:border-violet-500/50 focus:ring-2 focus:ring-violet-500/20 focus:outline-none transition-all duration-200
              text-gray-100 placeholder-gray-500 resize-vertical backdrop-blur-sm`,value:a,onChange:x=>t(x.target.value),onKeyDown:X,placeholder:"Add a note about this deal...",rows:3,"aria-label":"Add a note about this deal"}),e.jsx("div",{className:"absolute bottom-2 right-2 text-xs text-gray-500",children:"Ctrl+Enter to save"})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(G,{type:"button",size:"sm",onClick:K,disabled:!a.trim()||!r,className:`gap-2 bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-700 hover:to-purple-700 
              text-white border-0 shadow-lg hover:shadow-xl transition-all duration-200 transform hover:scale-105`,children:[e.jsx(Fe,{className:"w-4 h-4"}),"Add Note"]}),e.jsxs(G,{type:"button",variant:"outline",size:"sm",className:`gap-2 bg-gray-800/50 border-gray-700/50 text-gray-300 hover:bg-gray-700/50 hover:text-white
              hover:border-blue-500/50 transition-all duration-200 backdrop-blur-sm`,onClick:z,children:[e.jsx(se,{className:"w-4 h-4"}),"Schedule Task"]}),e.jsxs(G,{type:"button",variant:"outline",size:"sm",className:`gap-2 bg-gray-800/50 border-gray-700/50 text-gray-300 hover:bg-gray-700/50 hover:text-white
              hover:border-green-500/50 transition-all duration-200 backdrop-blur-sm`,onClick:f,children:[e.jsx(Ae,{className:"w-4 h-4"}),"Log Call"]}),e.jsxs(G,{type:"button",variant:"outline",size:"sm",className:`gap-2 bg-gray-800/50 border-gray-700/50 text-gray-300 hover:bg-gray-700/50 hover:text-white
              hover:border-orange-500/50 transition-all duration-200 backdrop-blur-sm`,onClick:B,children:[e.jsx(fe,{className:"w-4 h-4"}),"Log Email"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h4",{className:"text-lg font-semibold text-gray-200",children:"Recent Activity"})}),R.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h5",{className:"text-sm font-medium text-gray-400 uppercase tracking-wider flex items-center gap-2",children:[e.jsx(de,{className:"w-4 h-4"}),"Recent Notes"]}),e.jsx("div",{className:"space-y-2",children:R.map((x,k)=>e.jsx("div",{className:"group relative",children:e.jsx("div",{className:`bg-gradient-to-r from-gray-800/40 to-gray-900/40 border border-gray-700/30 rounded-xl p-4 
                    backdrop-blur-sm hover:border-gray-600/50 transition-all duration-200 hover:shadow-lg`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-violet-500/10 rounded-lg flex items-center justify-center",children:e.jsx(de,{className:"w-4 h-4 text-violet-400"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-gray-200 leading-relaxed",children:x})})]})})},k))})]}),e.jsx("div",{className:"bg-gradient-to-r from-blue-900/20 to-indigo-900/20 border border-blue-500/20 rounded-xl p-4 backdrop-blur-sm",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-blue-500/10 rounded-lg flex items-center justify-center",children:e.jsx(de,{className:"w-4 h-4 text-blue-400"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-blue-200 mb-2",children:"Activity Logging Active"}),e.jsxs("div",{className:"space-y-1 text-sm text-blue-300/80",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-violet-400 rounded-full"}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-violet-300",children:"Notes"})," appear above and are saved to this deal"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-blue-400 rounded-full"}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-blue-300",children:"Tasks"})," are added to your Task List"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-green-400 rounded-full"}),e.jsxs("span",{children:[e.jsx("strong",{className:"text-green-300",children:"Calls & Emails"})," are logged to your Activity Dashboard"]})]})]})]})]})})]}),d&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsx(aa,{dealId:r,contactName:A,contactEmail:j,company:l,onClose:()=>o(!1),onSubmit:$})}),g&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsx(ra,{dealId:r,contactName:A,contactEmail:j,company:l,onClose:()=>u(!1),onSubmit:$})}),v&&e.jsx("div",{className:"fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50",children:e.jsx(sa,{dealId:r,contactName:A,contactEmail:j,company:l,onClose:()=>C(!1),onSubmit:$})})]})},aa=({dealId:r,contactName:a,contactEmail:t,company:d,onClose:o,onSubmit:g})=>{const[u,v]=i.useState(""),[C,b]=i.useState(""),[m,n]=i.useState(re(he(new Date,1),"yyyy-MM-dd")),[A,j]=i.useState("09:00"),[l,p]=i.useState("medium"),S=async T=>{if(T.preventDefault(),!u.trim())return;const L=`${m}T${A}:00`;await g({activity_type:"task",notes:`Task: ${u}

Notes: ${C}

Priority: ${l}`,due_date:L,contact_email:t}),o()};return e.jsxs("div",{className:"bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-700/50 shadow-2xl backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-10 h-10 bg-blue-500/10 rounded-lg flex items-center justify-center",children:e.jsx(se,{className:"w-5 h-5 text-blue-400"})}),e.jsx("h3",{className:"text-xl font-semibold text-white",children:"Schedule Task"})]}),e.jsxs("form",{onSubmit:S,className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Task Title"}),e.jsx(le,{value:u,onChange:T=>v(T.target.value),placeholder:"Enter task title...",className:`bg-gray-800/50 border-gray-700/50 text-white placeholder-gray-400 
              focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 rounded-lg`,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Notes"}),e.jsx("textarea",{value:C,onChange:T=>b(T.target.value),placeholder:"Additional notes...",className:`w-full p-3 bg-gray-800/50 border border-gray-700/50 rounded-lg text-white placeholder-gray-400
              focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 transition-all duration-200`,rows:3})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Due Date"}),e.jsx(le,{type:"date",value:m,onChange:T=>n(T.target.value),className:`bg-gray-800/50 border-gray-700/50 text-white
                focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 rounded-lg`})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Due Time"}),e.jsx(le,{type:"time",value:A,onChange:T=>j(T.target.value),className:`bg-gray-800/50 border-gray-700/50 text-white
                focus:border-blue-500/50 focus:ring-2 focus:ring-blue-500/20 rounded-lg`})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Priority"}),e.jsxs(pe,{value:l,onValueChange:p,children:[e.jsx(ye,{className:"bg-gray-800/50 border-gray-700/50 text-white hover:bg-gray-700/50",children:e.jsx(ve,{})}),e.jsxs(je,{className:"bg-gray-800 border-gray-700",children:[e.jsx(J,{value:"low",className:"text-gray-300 hover:bg-gray-700",children:"Low"}),e.jsx(J,{value:"medium",className:"text-gray-300 hover:bg-gray-700",children:"Medium"}),e.jsx(J,{value:"high",className:"text-gray-300 hover:bg-gray-700",children:"High"})]})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsxs(G,{type:"submit",className:`flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700
              text-white border-0 shadow-lg hover:shadow-xl transition-all duration-200`,children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Schedule Task"]}),e.jsx(G,{type:"button",variant:"outline",onClick:o,className:"bg-gray-800/50 border-gray-700/50 text-gray-300 hover:bg-gray-700/50 hover:text-white",children:"Cancel"})]})]})]})},ra=({dealId:r,contactName:a,contactEmail:t,company:d,onClose:o,onSubmit:g})=>{const[u,v]=i.useState(""),[C,b]=i.useState(""),[m,n]=i.useState(""),A=async j=>{j.preventDefault(),u.trim()&&(await g({activity_type:"call",notes:`Call with ${a||t}

Outcome: ${C}
Duration: ${m} minutes

Notes: ${u}`,contact_email:t}),o())};return e.jsxs("div",{className:"bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-700/50 shadow-2xl backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-10 h-10 bg-green-500/10 rounded-lg flex items-center justify-center",children:e.jsx(Ae,{className:"w-5 h-5 text-green-400"})}),e.jsx("h3",{className:"text-xl font-semibold text-white",children:"Log Call"})]}),e.jsxs("form",{onSubmit:A,className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Call Outcome"}),e.jsxs(pe,{value:C,onValueChange:b,children:[e.jsx(ye,{className:"bg-gray-800/50 border-gray-700/50 text-white hover:bg-gray-700/50",children:e.jsx(ve,{placeholder:"Select outcome..."})}),e.jsxs(je,{className:"bg-gray-800 border-gray-700",children:[e.jsx(J,{value:"connected",className:"text-gray-300 hover:bg-gray-700",children:"Connected"}),e.jsx(J,{value:"voicemail",className:"text-gray-300 hover:bg-gray-700",children:"Left Voicemail"}),e.jsx(J,{value:"no-answer",className:"text-gray-300 hover:bg-gray-700",children:"No Answer"}),e.jsx(J,{value:"busy",className:"text-gray-300 hover:bg-gray-700",children:"Busy"}),e.jsx(J,{value:"meeting-scheduled",className:"text-gray-300 hover:bg-gray-700",children:"Meeting Scheduled"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Duration (minutes)"}),e.jsx(le,{type:"number",value:m,onChange:j=>n(j.target.value),placeholder:"5",className:`bg-gray-800/50 border-gray-700/50 text-white placeholder-gray-400
              focus:border-green-500/50 focus:ring-2 focus:ring-green-500/20 rounded-lg`,min:"1"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Call Notes"}),e.jsx("textarea",{value:u,onChange:j=>v(j.target.value),placeholder:"What was discussed during the call...",className:`w-full p-3 bg-gray-800/50 border border-gray-700/50 rounded-lg text-white placeholder-gray-400
              focus:border-green-500/50 focus:ring-2 focus:ring-green-500/20 transition-all duration-200`,rows:4,required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsxs(G,{type:"submit",className:`flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700
              text-white border-0 shadow-lg hover:shadow-xl transition-all duration-200`,children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Log Call"]}),e.jsx(G,{type:"button",variant:"outline",onClick:o,className:"bg-gray-800/50 border-gray-700/50 text-gray-300 hover:bg-gray-700/50 hover:text-white",children:"Cancel"})]})]})]})},sa=({dealId:r,contactName:a,contactEmail:t,company:d,onClose:o,onSubmit:g})=>{const[u,v]=i.useState(""),[C,b]=i.useState("outbound"),[m,n]=i.useState(""),A=async j=>{j.preventDefault(),!(!u.trim()||!m.trim())&&(await g({activity_type:"email",notes:`Email ${C} - ${a||t}

Subject: ${u}

Notes: ${m}`,contact_email:t}),o())};return e.jsxs("div",{className:"bg-gradient-to-br from-gray-900 to-gray-800 rounded-xl p-6 w-full max-w-md mx-4 border border-gray-700/50 shadow-2xl backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-10 h-10 bg-orange-500/10 rounded-lg flex items-center justify-center",children:e.jsx(fe,{className:"w-5 h-5 text-orange-400"})}),e.jsx("h3",{className:"text-xl font-semibold text-white",children:"Log Email"})]}),e.jsxs("form",{onSubmit:A,className:"space-y-5",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Direction"}),e.jsxs(pe,{value:C,onValueChange:b,children:[e.jsx(ye,{className:"bg-gray-800/50 border-gray-700/50 text-white hover:bg-gray-700/50",children:e.jsx(ve,{})}),e.jsxs(je,{className:"bg-gray-800 border-gray-700",children:[e.jsx(J,{value:"outbound",className:"text-gray-300 hover:bg-gray-700",children:"Sent Email"}),e.jsx(J,{value:"inbound",className:"text-gray-300 hover:bg-gray-700",children:"Received Email"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Subject"}),e.jsx(le,{value:u,onChange:j=>v(j.target.value),placeholder:"Email subject...",className:`bg-gray-800/50 border-gray-700/50 text-white placeholder-gray-400
              focus:border-orange-500/50 focus:ring-2 focus:ring-orange-500/20 rounded-lg`,required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-300 mb-2",children:"Email Summary"}),e.jsx("textarea",{value:m,onChange:j=>n(j.target.value),placeholder:"Summary of the email content and any follow-up actions...",className:`w-full p-3 bg-gray-800/50 border border-gray-700/50 rounded-lg text-white placeholder-gray-400
              focus:border-orange-500/50 focus:ring-2 focus:ring-orange-500/20 transition-all duration-200`,rows:4,required:!0})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsxs(G,{type:"submit",className:`flex-1 bg-gradient-to-r from-orange-600 to-amber-600 hover:from-orange-700 hover:to-amber-700
              text-white border-0 shadow-lg hover:shadow-xl transition-all duration-200`,children:[e.jsx(fe,{className:"w-4 h-4 mr-2"}),"Log Email"]}),e.jsx(G,{type:"button",variant:"outline",onClick:o,className:"bg-gray-800/50 border-gray-700/50 text-gray-300 hover:bg-gray-700/50 hover:text-white",children:"Cancel"})]})]})]})},De=({icon:r,title:a})=>e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-8 h-8 bg-violet-500/10 rounded-lg flex items-center justify-center",children:r}),e.jsx("h2",{className:"text-xl font-semibold text-gray-200",children:a})]}),la=(r,a,t)=>{i.useEffect(()=>{if(!a||!r.current)return;const d=document.activeElement;(()=>{if(t?.current)t.current.focus();else{const u=Oe(r.current);u.length>0&&u[0].focus()}})();const g=u=>{if(u.key!=="Tab")return;const v=Oe(r.current);if(v.length===0)return;const C=v[0],b=v[v.length-1],m=document.activeElement;u.shiftKey&&m===C?(u.preventDefault(),b.focus()):!u.shiftKey&&m===b&&(u.preventDefault(),C.focus())};return document.addEventListener("keydown",g),()=>{document.removeEventListener("keydown",g),d&&"focus"in d&&d.focus()}},[a,r,t])},Oe=r=>{if(!r)return[];const a=["a[href]","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])','[contenteditable="true"]'].join(",");return Array.from(r.querySelectorAll(a))},ia=1,na=1e6;let Ee=0;function oa(){return Ee=(Ee+1)%Number.MAX_SAFE_INTEGER,Ee.toString()}const ke=new Map,Ie=r=>{if(ke.has(r))return;const a=setTimeout(()=>{ke.delete(r),ue({type:"REMOVE_TOAST",toastId:r})},na);ke.set(r,a)},ca=(r,a)=>{switch(a.type){case"ADD_TOAST":return{...r,toasts:[a.toast,...r.toasts].slice(0,ia)};case"UPDATE_TOAST":return{...r,toasts:r.toasts.map(t=>t.id===a.toast.id?{...t,...a.toast}:t)};case"DISMISS_TOAST":{const{toastId:t}=a;return t?Ie(t):r.toasts.forEach(d=>{Ie(d.id)}),{...r,toasts:r.toasts.map(d=>d.id===t||t===void 0?{...d,open:!1}:d)}}case"REMOVE_TOAST":return a.toastId===void 0?{...r,toasts:[]}:{...r,toasts:r.toasts.filter(t=>t.id!==a.toastId)}}},xe=[];let be={toasts:[]};function ue(r){be=ca(be,r),xe.forEach(a=>{a(be)})}function da({...r}){const a=oa(),t=o=>ue({type:"UPDATE_TOAST",toast:{...o,id:a}}),d=()=>ue({type:"DISMISS_TOAST",toastId:a});return ue({type:"ADD_TOAST",toast:{...r,id:a,open:!0,onOpenChange:o=>{o||d()}}}),{id:a,dismiss:d,update:t}}function ua(){const[r,a]=i.useState(be);return i.useEffect(()=>(xe.push(a),()=>{const t=xe.indexOf(a);t>-1&&xe.splice(t,1)}),[r]),{...r,toast:da,dismiss:t=>ue({type:"DISMISS_TOAST",toastId:t})}}const ma=(r,a)=>({sql:"bg-blue-500/15 text-blue-400 border border-blue-500/20",opportunity:"bg-yellow-500/15 text-yellow-400 border border-yellow-500/20",verbal:"bg-orange-500/15 text-orange-400 border border-orange-500/20",signed:"bg-emerald-500/15 text-emerald-400 border border-emerald-500/20",lost:"bg-red-500/15 text-red-400 border border-red-500/20","closed won":"bg-emerald-500/15 text-emerald-400 border border-emerald-500/20","closed lost":"bg-red-500/15 text-red-400 border border-red-500/20"})[r.toLowerCase()]||"bg-gray-500/15 text-gray-400 border border-gray-500/20",Aa=({open:r,setOpen:a,deal:t,onSave:d,onDelete:o})=>{const{toast:g}=ua(),[u,v]=i.useState("details"),[C,b]=i.useState(""),[m,n]=i.useState(""),[A,j]=i.useState(""),[l,p]=i.useState(!1),[S,T]=i.useState(!1),[L,V]=i.useState(!1),h=Et({defaultValues:{name:t?.name||"",company:t?.company||"",contactName:t?.contact_name||"",contactEmail:t?.contact_email||"",contactPhone:t?.contact_phone||"",amount:t?.value||"",oneOffRevenue:t?.one_off_revenue||"",monthlyMrr:t?.monthly_mrr||"",closeDate:t?.expected_close_date||"",firstBillingDate:t?.first_billing_date||"",notes:t?.notes||t?.description||"",probability:t?.probability||20,nextAction:t?.next_steps||"",dealSize:t?.deal_size||"",priority:t?.priority||"",leadSourceType:t?.lead_source_type||"",leadSourceChannel:t?.lead_source_channel||""}}),{stages:R}=et(),y=i.useRef(null),D=i.useRef(null),$=i.useRef(null),K=i.useRef(null),z=i.useRef(null),f=i.useRef(null);la(y,r,$),i.useEffect(()=>{if(t&&R&&R.length>0){const s=t.stage_id||t.stage||"";b(s);const c=R.find(O=>O.id===s);if(c)n(c.name),j(c.color||"");else{const O=R.find(H=>H.name.toLowerCase()===s.toLowerCase());O?(b(O.id),n(O.name),j(O.color||"")):(n("Unknown"),j(""))}}},[t,R]);const B=s=>{b(s);const c=R.find(O=>O.id===s);c?(n(c.name),j(c.color||"")):(n("Unknown"),j(""))},X=s=>{s.key==="Escape"&&a(!1)},x=s=>{if(!s)return"";try{const c=new Date(s);if(isNaN(c.getTime()))return"";const O=c.getFullYear(),H=(c.getMonth()+1).toString().padStart(2,"0"),ee=c.getDate().toString().padStart(2,"0");return`${O}-${H}-${ee}`}catch{return""}},k=async()=>{try{if(T(!0),!await h.trigger()){const P=h.formState.errors;E.error("Form validation errors:",P),g({title:"Form Error",description:"Please fix the highlighted fields.",variant:"destructive"}),T(!1);return}const c=h.getValues();E.log(">>> DEBUG: Form data in handleSave:",c),E.log(">>> DEBUG: Expected close date value:",c.closeDate);let O=C,H=null;if(c.closeDate&&c.closeDate.trim()!=="")try{const P=new Date(c.closeDate);if(isNaN(P.getTime()))throw new Error("Invalid date format");H=c.closeDate,E.log(">>> DEBUG: Processed close date:",H)}catch(P){E.error("Date validation error:",P),g({title:"Invalid Date",description:"Please enter a valid expected close date.",variant:"destructive"}),T(!1);return}const ee=c.oneOffRevenue?parseFloat(c.oneOffRevenue):0,N=c.monthlyMrr?parseFloat(c.monthlyMrr):0,_=N*3+ee,F={name:c.name,company:c.company||null,value:_>0?_:c.amount?parseFloat(c.amount):null,one_off_revenue:ee>0?ee:null,monthly_mrr:N>0?N:null,expected_close_date:H,close_date:H,first_billing_date:c.firstBillingDate||null,description:c.notes||null,stage_id:O,probability:c.probability?parseInt(c.probability.toString()):null,priority:c.priority===""?null:c.priority,next_steps:c.nextAction,contact_name:c.contactName||null,contact_email:c.contactEmail||null,contact_phone:c.contactPhone||null,deal_size:c.dealSize===""?null:c.dealSize,lead_source_type:c.leadSourceType===""?null:c.leadSourceType,lead_source_channel:c.leadSourceChannel===""?null:c.leadSourceChannel};E.log(">>> DEBUG: dataToSave expected_close_date value:",F.expected_close_date);const w=Object.fromEntries(Object.entries(F).filter(([P,I])=>P==="expected_close_date"||P==="close_date"?!0:I!=null));E.log("Saving deal with data:",w),await d(w),g({title:"Deal Saved",description:"Deal has been successfully updated.",variant:"default"}),a(!1)}catch{g({title:"Error Saving Deal",description:"There was a problem saving your changes.",variant:"destructive"})}finally{T(!1)}},Z=async()=>{if(window.confirm("Are you sure you want to delete this deal? This action cannot be undone."))try{p(!0),await o(t.id||""),g({title:"Deal Deleted",description:"Deal has been successfully deleted.",variant:"default"}),a(!1)}catch{g({title:"Error Deleting Deal",description:"There was a problem deleting this deal.",variant:"destructive"})}finally{p(!1)}};i.useEffect(()=>{if(r&&t){const s=t.name||"",c=t.company||"",O=t.contact_name||"",H=t.value??"",ee=x(t.expected_close_date),N=t.notes||t.description||"",_=t.probability??0,F=t.next_steps||"",w=t?.deal_size||"",P=t?.lead_source_type||"",I=t?.lead_source_channel||"",q=t?.priority||"",Q={name:s,company:c,contactName:O,contactEmail:t.contact_email||"",contactPhone:t.contact_phone||"",amount:H,oneOffRevenue:t.one_off_revenue??"",monthlyMrr:t.monthly_mrr??"",closeDate:ee,firstBillingDate:x(t.first_billing_date),notes:N,probability:_,nextAction:F,dealSize:w,leadSourceType:P,leadSourceChannel:I,priority:q};h.reset(Q);const U={shouldValidate:!1,shouldDirty:!1};h.setValue("name",s,U),h.setValue("company",c,U),h.setValue("contactName",O,U),h.setValue("contactEmail",t.contact_email||"",U),h.setValue("contactPhone",t.contact_phone||"",U),h.setValue("amount",H,U),h.setValue("oneOffRevenue",t.one_off_revenue??"",U),h.setValue("monthlyMrr",t.monthly_mrr??"",U),h.setValue("closeDate",ee,U),h.setValue("firstBillingDate",x(t.first_billing_date),U),h.setValue("notes",N,U),h.setValue("probability",_,U),h.setValue("nextAction",F,U),h.setValue("dealSize",w,U),h.setValue("leadSourceType",P,U),h.setValue("leadSourceChannel",I,U),h.setValue("priority",q,U),h.getValues(),setTimeout(()=>{$.current&&$.current.focus()},100)}},[r,t,h]),i.useEffect(()=>{if(r&&y.current&&u){const s=y.current.querySelector(`#${u}-section`);if(s){const c=s.querySelector('input, button, select, textarea, [tabindex]:not([tabindex="-1"])');c&&c.focus()}}},[u,r]);const W=s=>{s.key==="Tab"&&s.shiftKey&&document.activeElement===$.current&&(s.preventDefault(),f.current&&f.current.focus())};return t?e.jsx(Kt,{deal:t,children:e.jsxs(kt,{...h,children:[e.jsx(Le,{open:r,onOpenChange:a,children:e.jsxs(qe,{ref:y,className:"max-w-[700px] p-0 overflow-hidden bg-gray-950 border border-gray-800 rounded-xl",onKeyDown:s=>{X(s),W(s)},id:"edit-deal-modal-content",children:[e.jsxs(Ue,{className:"p-4 border-b border-gray-800 relative flex flex-row items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex items-center justify-center w-7 h-7 rounded-md bg-green-500/10 text-green-400 border border-green-500/20",children:e.jsx(Qe,{className:"w-4 h-4"})}),e.jsx(Be,{className:"text-xl font-semibold text-white",children:t.name||t?.dealName||"Edit Deal"}),C&&e.jsx("div",{className:`px-3 py-1 text-sm font-medium rounded-md ml-2 ${ma(m)}`,style:A?{backgroundColor:`${A}20`,color:A,borderColor:`${A}40`,border:"1px solid"}:{},children:m})]}),e.jsx("button",{ref:K,onClick:()=>a(!1),className:"text-gray-400 hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-violet-600 focus:ring-opacity-50 rounded-md","aria-label":"Close modal",children:e.jsx(Ge,{className:"w-5 h-5"})})]}),e.jsx(nt,{className:"sr-only",children:"Edit the details, pipeline stage, lead source and activities for this deal."}),e.jsx("div",{ref:D,className:"border-b border-gray-800",role:"tablist","aria-label":"Deal sections",children:e.jsx(Gt,{activeTab:u,onTabChange:v})}),e.jsxs("div",{className:"max-h-[60vh] overflow-y-auto p-6",role:"region","aria-live":"polite",id:`${u}-section`,children:[u==="details"&&e.jsx(Qt,{initialFocusRef:$}),u==="stage"&&e.jsx(Xt,{onStageChange:B,currentStage:C}),u==="source"&&e.jsx(Jt,{}),u==="activity"&&e.jsx(ta,{dealId:t.id})]}),e.jsxs(ze,{className:"p-4 border-t border-gray-800 bg-gray-950 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{ref:f,onClick:Z,className:`flex items-center gap-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 
                    py-2 px-4 rounded-lg text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-red-600 focus:ring-opacity-50`,disabled:l,"aria-label":"Delete deal",children:[e.jsx(Ye,{className:"w-4 h-4"}),l?"Deleting...":"Delete Deal"]}),e.jsxs("button",{onClick:()=>V(!0),className:`flex items-center gap-2 bg-blue-500/10 hover:bg-blue-500/20 text-blue-400 border border-blue-500/20 
                    py-2 px-4 rounded-lg text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-600 focus:ring-opacity-50`,"aria-label":"Split deal",children:[e.jsx(Ke,{className:"w-4 h-4"}),"Split Deal"]})]}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{onClick:()=>a(!1),className:`py-2 px-4 rounded-lg text-gray-300 bg-gray-800 hover:bg-gray-700
                    transition-colors text-sm font-medium focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-opacity-50`,"aria-label":"Cancel",children:"Cancel"}),e.jsx("button",{ref:z,onClick:k,disabled:S,className:`flex items-center gap-2 bg-violet-600 hover:bg-violet-700 
                    text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors
                    focus:outline-none focus:ring-2 focus:ring-violet-500 focus:ring-opacity-50
                    disabled:bg-violet-600/70 disabled:cursor-not-allowed`,"aria-label":"Save deal",children:S?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin mr-1",children:e.jsxs("svg",{className:"w-4 h-4",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]})}),"Saving..."]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-4 h-4 mr-1"}),"Save"]})})]})]})]})}),t&&t.id&&e.jsx(zt,{open:L,onOpenChange:V,deal:t})]})}):null};export{Aa as E,Ta as P,et as a,Bt as u};
