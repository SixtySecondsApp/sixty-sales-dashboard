import{j as e}from"./vendor-state-CpjwTZNq.js";import{r as n}from"./vendor-react-DoYyFkVR.js";import{t as d,a as t,B as l}from"./index.html-Cwo_Unfk.js";import{I as c}from"./input-CeE6qNqI.js";import{C as _,b as N,c as v,d as C,a as w}from"./card-B2-KTHtJ.js";import{Table as D,TableHeader as q,TableRow as S,TableHead as m,TableBody as H,TableCell as p}from"./table-C4c75fDG.js";import{S as P}from"./slider-BMvrEO5E.js";import{c as k,Q as L,a3 as O,a8 as z,Y as M}from"./vendor-icons-HRBKouGg.js";import"./vendor-router-CQXjpROx.js";import"./vendor-supabase-BuXd-BBn.js";import"./vendor-utils-Cb9OXVhE.js";import"./ui-radix-core-CdvL28QE.js";import"./ui-animation-Dzb4KUJ1.js";import"./vendor-charts-D4YcUEy1.js";function ie(){const[o,f]=n.useState([]),[E,j]=n.useState(!0),[g,u]=n.useState(!1),[i,r]=n.useState({id:null,name:"",description:"",color:"#3B82F6",order_position:10,default_probability:50});n.useEffect(()=>{h()},[]);const h=async()=>{try{j(!0);const{data:s,error:a}=await d.from("deal_stages").select("*").order("order_position");if(a)throw a;f(s||[])}catch{t.error("Failed to load pipeline stages")}finally{j(!1)}},F=s=>{r({id:s.id,name:s.name,description:s.description||"",color:s.color,order_position:s.order_position,default_probability:s.default_probability}),u(!0)},y=()=>{const s=o.length>0?Math.max(...o.map(a=>a.order_position)):0;r({id:null,name:"",description:"",color:"#3B82F6",order_position:s+10,default_probability:50}),u(!0)},T=()=>{u(!1),r({id:null,name:"",description:"",color:"#3B82F6",order_position:10,default_probability:50})},I=async()=>{if(!i.name){t.error("Stage name is required");return}try{if(i.id){const{error:s}=await d.from("deal_stages").update({name:i.name,description:i.description||null,color:i.color,order_position:i.order_position,default_probability:i.default_probability,updated_at:new Date().toISOString()}).eq("id",i.id);if(s)throw s;t.success("Pipeline stage updated successfully")}else{const{error:s}=await d.from("deal_stages").insert({name:i.name,description:i.description||null,color:i.color,order_position:i.order_position,default_probability:i.default_probability});if(s)throw s;t.success("Pipeline stage created successfully")}h(),u(!1),r({id:null,name:"",description:"",color:"#3B82F6",order_position:10,default_probability:50})}catch{t.error("Failed to save pipeline stage")}},A=async s=>{if(confirm("Are you sure you want to delete this pipeline stage? This cannot be undone."))try{const{error:a}=await d.from("deal_stages").delete().eq("id",s);if(a)throw a;t.success("Pipeline stage deleted successfully"),h()}catch{t.error("Failed to delete pipeline stage. It may be in use by existing deals.")}},B=async(s,a)=>{try{const{error:x}=await d.from("deal_stages").update({default_probability:a,updated_at:new Date().toISOString()}).eq("id",s);if(x)throw x;f(o.map(b=>b.id===s?{...b,default_probability:a}:b)),t.success("Probability updated")}catch{t.error("Failed to update probability")}};return e.jsxs("div",{className:"container mx-auto py-6 space-y-8",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Pipeline Settings"}),!g&&e.jsxs(l,{onClick:y,children:[e.jsx(k,{className:"mr-2 h-4 w-4"}),"Add Stage"]})]}),g?e.jsxs(_,{children:[e.jsxs(N,{children:[e.jsxs(v,{children:[i.id?"Edit":"Add"," Pipeline Stage"]}),e.jsx(C,{children:"Configure stage details and win probability"})]}),e.jsx(w,{children:e.jsxs("div",{className:"grid gap-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Name *"}),e.jsx(c,{value:i.name,onChange:s=>r({...i,name:s.target.value}),placeholder:"e.g., Qualified Lead",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Color"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(c,{type:"color",value:i.color,onChange:s=>r({...i,color:s.target.value}),className:"w-12 h-10 p-1"}),e.jsx(c,{value:i.color,onChange:s=>r({...i,color:s.target.value}),placeholder:"#HEX",className:"flex-1"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Description"}),e.jsx(c,{value:i.description,onChange:s=>r({...i,description:s.target.value}),placeholder:"Describe this pipeline stage"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Position (Order)"}),e.jsx(c,{type:"number",value:i.order_position,onChange:s=>r({...i,order_position:parseInt(s.target.value)||0}),min:0,step:10})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Default Win Probability: ",i.default_probability,"%"]}),e.jsx(P,{value:[i.default_probability],min:0,max:100,step:5,onValueChange:s=>r({...i,default_probability:s[0]})})]})]}),e.jsxs("div",{className:"flex justify-end gap-2 mt-4",children:[e.jsxs(l,{variant:"outline",onClick:T,children:[e.jsx(L,{className:"mr-2 h-4 w-4"}),"Cancel"]}),e.jsxs(l,{onClick:I,children:[e.jsx(O,{className:"mr-2 h-4 w-4"}),"Save"]})]})]})})]}):e.jsxs(_,{children:[e.jsxs(N,{children:[e.jsx(v,{children:"Pipeline Stages"}),e.jsx(C,{children:"Manage your sales pipeline stages and configure win probability for each stage"})]}),e.jsx(w,{children:E?e.jsx("div",{className:"text-center py-4",children:"Loading stages..."}):o.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-muted-foreground mb-4",children:"No pipeline stages defined yet"}),e.jsxs(l,{onClick:y,children:[e.jsx(k,{className:"mr-2 h-4 w-4"}),"Add Your First Stage"]})]}):e.jsxs(D,{children:[e.jsx(q,{children:e.jsxs(S,{children:[e.jsx(m,{children:"Name"}),e.jsx(m,{children:"Color"}),e.jsx(m,{children:"Order"}),e.jsx(m,{children:"Win Probability"}),e.jsx(m,{className:"text-right",children:"Actions"})]})}),e.jsx(H,{children:o.map(s=>e.jsxs(S,{children:[e.jsx(p,{className:"font-medium",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:s.color}}),s.name]})}),e.jsx(p,{children:s.color}),e.jsx(p,{children:s.order_position}),e.jsx(p,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{value:[s.default_probability],min:0,max:100,step:5,onValueChange:a=>B(s.id,a[0]),className:"w-32"}),e.jsxs("span",{className:"text-sm",children:[s.default_probability,"%"]})]})}),e.jsx(p,{className:"text-right",children:e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{size:"sm",variant:"ghost",onClick:()=>F(s),children:e.jsx(z,{className:"h-4 w-4"})}),e.jsx(l,{size:"sm",variant:"ghost",onClick:()=>A(s.id),children:e.jsx(M,{className:"h-4 w-4"})})]})})]},s.id))})]})})]})]})}export{ie as default};
