import{l as g,B as C}from"./index.html-Cwo_Unfk.js";import{p as x,O as $,a as M,k as L,e as U,s as P,A as z,C as W}from"./vendor-utils-Cb9OXVhE.js";import{j as t}from"./vendor-state-CpjwTZNq.js";import{r as D}from"./vendor-react-DoYyFkVR.js";import{I as k}from"./input-CeE6qNqI.js";import{L as S}from"./label-B9drN7Ag.js";import{P as B,a as F,b as H}from"./popover-BxJ1Vfi_.js";import{S as E,a as T,b as A,c as O,d as I}from"./select-BFsZCfaH.js";import{k as R,X as q,x as Q}from"./vendor-icons-HRBKouGg.js";const r=d=>{if(d==null)return"";const a=String(d);return/[,"\n\r]/.test(a)||a.startsWith(" ")||a.endsWith(" ")?`"${a.replace(/"/g,'""')}"`:a},re=(d,a={})=>{if(d.length===0)throw new Error("No data to export");const{filename:s=`sales-activities-${x(new Date,"yyyy-MM-dd")}.csv`,includeColumns:l,excludeColumns:p=[]}=a,b={date:"Date",type:"Activity Type",sales_rep:"Sales Rep",client_name:"Client Name",amount:"Amount (£)",status:"Status",priority:"Priority",details:"Details",quantity:"Quantity"},v=Object.keys(b);let h;if(l){h=l.filter(e=>v.includes(e));const u=l.filter(e=>!v.includes(e));u.length>0&&g.warn(`Invalid column names filtered out from CSV export: ${u.join(", ")}`)}else h=v;h=h.filter(u=>!p.includes(u));const y=h.map(u=>b[u]),f=d.map(u=>h.map(e=>{let n=u[e];switch(e){case"date":if(!n)return r("");try{const c=new Date(n);if(isNaN(c.getTime()))return g.warn(`Invalid date value in activity: ${n}`),r("");const i=x(c,"yyyy-MM-dd HH:mm");return r(i)}catch{return r("")}case"type":const w=n?.charAt(0).toUpperCase()+n?.slice(1)||"";return r(w);case"status":let N="";return n==="no_show"?N="No Show":N=n?.charAt(0).toUpperCase()+n?.slice(1)||"",r(N);case"priority":const j=n?.charAt(0).toUpperCase()+n?.slice(1)||"";return r(j);case"amount":if(!n)return r("");try{const c=Number(n);if(isNaN(c))return g.warn(`Invalid amount value in activity: ${n}`),r("");const i=`£${c.toLocaleString()}`;return r(i)}catch{return r("")}case"quantity":if(!n)return r("1");try{const c=n.toString();return r(c)}catch{return r("1")}default:return r(n)}})),m=[y.join(","),...f.map(u=>u.join(","))].join(`
`);try{const u=new Blob([m],{type:"text/csv;charset=utf-8;"}),e=document.createElement("a");if(e.download!==void 0){const n=URL.createObjectURL(u);e.setAttribute("href",n),e.setAttribute("download",s),e.style.visibility="hidden",document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(n)}else throw new Error("File download not supported in this browser")}catch(u){throw alert("Failed to download CSV file. Please try again or contact support if the problem persists."),u}},se=d=>{const a={totalActivities:d.length,activityTypes:{},dateRange:{start:null,end:null},totalRevenue:0,salesReps:new Set,clients:new Set};return d.forEach(s=>{a.activityTypes[s.type]=(a.activityTypes[s.type]||0)+1;try{const l=new Date(s.date);isNaN(l.getTime())?g.warn(`Invalid date value in activity for summary: ${s.date} (Activity ID: ${s.id||"unknown"})`):((!a.dateRange.start||l<a.dateRange.start)&&(a.dateRange.start=l),(!a.dateRange.end||l>a.dateRange.end)&&(a.dateRange.end=l))}catch(l){g.warn(`Error parsing date for export summary: ${s.date} (Activity ID: ${s.id||"unknown"})`,l)}s.type==="sale"&&s.amount&&(a.totalRevenue+=s.amount),s.sales_rep&&a.salesReps.add(s.sales_rep),s.client_name&&a.clients.add(s.client_name)}),{...a,salesReps:Array.from(a.salesReps),clients:Array.from(a.clients)}},ne=(d,a,s={})=>{if(d.length===0)throw new Error("No pipeline data to export");const{filename:l=`pipeline-export-${x(new Date,"yyyy-MM-dd")}.csv`,includeColumns:p,excludeColumns:b=[]}=s,v={name:"Deal Name",company:"Company",contact_name:"Primary Contact",contact_email:"Contact Email",contact_phone:"Contact Phone",contact_title:"Contact Title",stage_name:"Stage",stage_probability:"Stage Probability (%)",value:"Deal Value (£)",weighted_value:"Weighted Value (£)",probability:"Deal Probability (%)",days_in_stage:"Days in Stage",time_status:"Time Status",owner:"Owner",created_date:"Created Date",close_date:"Expected Close Date",stage_changed_date:"Stage Changed Date",one_off_revenue:"One-Off Revenue (£)",monthly_mrr:"Monthly MRR (£)",annual_value:"Annual Value (£)",company_size:"Company Size",company_industry:"Industry",notes:"Notes",status:"Status"},h=Object.keys(v);let y;if(p){y=p.filter(n=>h.includes(n));const e=p.filter(n=>!h.includes(n));e.length>0&&g.warn(`Invalid column names filtered out from pipeline export: ${e.join(", ")}`)}else y=h;y=y.filter(e=>!b.includes(e));const f=y.map(e=>v[e]),m=d.map(e=>{const n=a.find(j=>j.id===e.stage_id),w=e.probability||n?.default_probability||0,N=Number(e.value||0)*(Number(w)/100);return y.map(j=>{let c;switch(j){case"name":c=e.name||"";break;case"company":c=e.companies?.name||e.company||"";break;case"contact_name":c=e.contacts?.full_name||e.contact_name||"";break;case"contact_email":c=e.contacts?.email||"";break;case"contact_phone":c=e.contacts?.phone||"";break;case"contact_title":c=e.contacts?.title||"";break;case"stage_name":c=n?.name||"Unknown Stage";break;case"stage_probability":c=n?.default_probability||0;break;case"value":if(!e.value)return r("");try{const o=Number(e.value);return isNaN(o)?(g.warn(`Invalid deal value: ${e.value} for deal ${e.id}`),r("")):r(`£${o.toLocaleString()}`)}catch(o){return g.warn(`Error formatting deal value: ${e.value} for deal ${e.id}`,o),r("")}case"weighted_value":try{const o=`£${N.toLocaleString()}`;return r(o)}catch(o){return g.warn(`Error formatting weighted value for deal ${e.id}`,o),r("")}case"probability":c=w;break;case"days_in_stage":c=e.daysInStage||0;break;case"time_status":const i=e.timeStatus||"normal";c=i.charAt(0).toUpperCase()+i.slice(1);break;case"owner":c=e.owner_id||"Unassigned";break;case"created_date":if(!e.created_at)return r("");try{const o=new Date(e.created_at);return isNaN(o.getTime())?(g.warn(`Invalid created date for deal ${e.id}: ${e.created_at}`),r("")):r(x(o,"yyyy-MM-dd HH:mm"))}catch(o){return g.warn(`Error parsing created date for deal ${e.id}:`,o),r("")}case"close_date":if(!e.close_date)return r("");try{const o=new Date(e.close_date);return isNaN(o.getTime())?(g.warn(`Invalid close date for deal ${e.id}: ${e.close_date}`),r("")):r(x(o,"yyyy-MM-dd"))}catch(o){return g.warn(`Error parsing close date for deal ${e.id}:`,o),r("")}case"stage_changed_date":if(!e.stage_changed_at)return r("");try{const o=new Date(e.stage_changed_at);return isNaN(o.getTime())?(g.warn(`Invalid stage changed date for deal ${e.id}: ${e.stage_changed_at}`),r("")):r(x(o,"yyyy-MM-dd HH:mm"))}catch(o){return g.warn(`Error parsing stage changed date for deal ${e.id}:`,o),r("")}case"one_off_revenue":if(!e.one_off_revenue)return r("");try{const o=Number(e.one_off_revenue);return isNaN(o)?r(""):r(`£${o.toLocaleString()}`)}catch(o){return g.warn(`Error formatting one-off revenue for deal ${e.id}`,o),r("")}case"monthly_mrr":if(!e.monthly_mrr)return r("");try{const o=Number(e.monthly_mrr);return isNaN(o)?r(""):r(`£${o.toLocaleString()}`)}catch(o){return g.warn(`Error formatting monthly MRR for deal ${e.id}`,o),r("")}case"annual_value":if(!e.annual_value)return r("");try{const o=Number(e.annual_value);return isNaN(o)?r(""):r(`£${o.toLocaleString()}`)}catch(o){return g.warn(`Error formatting annual value for deal ${e.id}`,o),r("")}case"company_size":c=e.companies?.size||"";break;case"company_industry":c=e.companies?.industry||"";break;case"notes":c=e.notes||"";break;case"status":const _=e.status||"active";c=_.charAt(0).toUpperCase()+_.slice(1);break;default:c=""}return r(c)})}),u=[f.join(","),...m.map(e=>e.join(","))].join(`
`);try{const e=new Blob([u],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a");if(n.download!==void 0){const w=URL.createObjectURL(e);n.setAttribute("href",w),n.setAttribute("download",l),n.style.visibility="hidden",document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(w)}else throw new Error("File download not supported in this browser")}catch(e){throw alert("Failed to download pipeline CSV file. Please try again or contact support if the problem persists."),e}},oe=(d,a)=>{const s={totalDeals:d.length,totalValue:0,totalWeightedValue:0,stageBreakdown:{},averageDealSize:0,averageTimeInStage:0,owners:new Set,companies:new Set,dateRange:{start:null,end:null}};if(d.forEach(l=>{const p=Number(l.value||0),b=a.find(m=>m.id===l.stage_id),v=l.probability||b?.default_probability||0,h=p*(v/100);s.totalValue+=p,s.totalWeightedValue+=h;const y=b?.name||"Unknown Stage";s.stageBreakdown[y]||(s.stageBreakdown[y]={count:0,value:0,weightedValue:0}),s.stageBreakdown[y].count++,s.stageBreakdown[y].value+=p,s.stageBreakdown[y].weightedValue+=h,l.owner_id&&s.owners.add(l.owner_id);const f=l.companies?.name||l.company;if(f&&s.companies.add(f),l.created_at)try{const m=new Date(l.created_at);isNaN(m.getTime())||((!s.dateRange.start||m<s.dateRange.start)&&(s.dateRange.start=m),(!s.dateRange.end||m>s.dateRange.end)&&(s.dateRange.end=m))}catch(m){g.warn(`Error parsing date for pipeline summary: ${l.created_at} (Deal ID: ${l.id})`,m)}}),d.length>0){s.averageDealSize=s.totalValue/d.length;const l=d.reduce((p,b)=>p+(b.daysInStage||0),0);s.averageTimeInStage=l/d.length}return{...s,owners:Array.from(s.owners),companies:Array.from(s.companies)}},V=[{value:"all",label:"All Time"},{value:"today",label:"Today"},{value:"thisWeek",label:"This Week"},{value:"thisMonth",label:"This Month"},{value:"last30Days",label:"Last 30 Days"},{value:"custom",label:"Custom Range"}];function ie(d){if(d==="all"||d==="custom")return null;const a=new Date;switch(d){case"today":return{start:M(a),end:$(a)};case"thisWeek":return{start:W(a,{weekStartsOn:1}),end:z(a,{weekStartsOn:1})};case"thisMonth":return{start:P(a),end:U(a)};case"last30Days":return{start:M(L(a,29)),end:$(a)};default:return null}}function le({value:d,customRange:a,onPresetChange:s,onCustomRangeChange:l,label:p="Date Filter",className:b="",compact:v=!1}){const[h,y]=D.useState(!1),[f,m]=D.useState(a?.start?x(a.start,"yyyy-MM-dd"):""),[u,e]=D.useState(a?.end?x(a.end,"yyyy-MM-dd"):"");D.useEffect(()=>{a&&(m(x(a.start,"yyyy-MM-dd")),e(x(a.end,"yyyy-MM-dd")))},[a]);const n=i=>{s(i),i!=="custom"&&(l(null),m(""),e("")),i!=="custom"&&y(!1)},w=()=>{if(!f||!u)return;const i=new Date(f),_=new Date(u);i>_?l({start:M(_),end:$(i)}):l({start:M(i),end:$(_)}),y(!1)},N=()=>{m(""),e(""),l(null),s("all")},j=()=>d==="custom"&&a?`${x(a.start,"MMM d")} - ${x(a.end,"MMM d")}`:V.find(_=>_.value===d)?.label||"All Time",c=d!=="all";return v?t.jsxs(B,{open:h,onOpenChange:y,children:[t.jsx(F,{asChild:!0,children:t.jsxs(C,{variant:"outline",size:"sm",className:`
              h-9 px-3 min-w-[140px] justify-between font-medium transition-all
              ${c?"border-emerald-500/50 bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500/20 hover:border-emerald-500/70":"border-gray-700 bg-gray-800/50 text-gray-300 hover:bg-gray-700/50 hover:border-gray-600"} ${b}
            `,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(R,{className:"w-4 h-4 flex-shrink-0"}),t.jsx("span",{className:"truncate",children:j()})]}),t.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[c&&t.jsx(q,{className:"w-3 h-3 text-gray-400 hover:text-gray-200 hover:bg-gray-600 rounded-sm p-0.5 transition-colors",onClick:i=>{i.stopPropagation(),N()}}),t.jsx(Q,{className:"w-3 h-3 text-gray-400 flex-shrink-0"})]})]})}),t.jsx(H,{className:"w-80 p-0 bg-gray-900 border-gray-700 shadow-xl",align:"start",children:t.jsxs("div",{className:"p-4 space-y-4",children:[t.jsxs("div",{className:"flex items-center gap-2 pb-2 border-b border-gray-700",children:[t.jsx(R,{className:"w-4 h-4 text-emerald-400"}),t.jsx(S,{className:"text-sm font-medium text-gray-200",children:p})]}),t.jsxs(E,{value:d,onValueChange:n,children:[t.jsx(T,{className:"bg-gray-800 border-gray-700 text-white hover:bg-gray-750 focus:border-emerald-500",children:t.jsx(A,{})}),t.jsx(O,{className:"bg-gray-800 border-gray-700",children:V.map(i=>t.jsx(I,{value:i.value,className:"text-white hover:bg-gray-700 focus:bg-gray-700 cursor-pointer",children:i.label},i.value))})]}),d==="custom"&&t.jsxs("div",{className:"space-y-4 pt-2 border-t border-gray-700",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(S,{className:"text-xs font-medium text-gray-400",children:"Start Date"}),t.jsx(k,{type:"date",value:f,onChange:i=>m(i.target.value),className:"bg-gray-800 border-gray-700 text-white focus:border-emerald-500 focus:ring-emerald-500/20"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(S,{className:"text-xs font-medium text-gray-400",children:"End Date"}),t.jsx(k,{type:"date",value:u,onChange:i=>e(i.target.value),className:"bg-gray-800 border-gray-700 text-white focus:border-emerald-500 focus:ring-emerald-500/20"})]})]}),t.jsxs("div",{className:"flex gap-2 pt-2",children:[t.jsx(C,{size:"sm",onClick:w,disabled:!f||!u,className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-50 disabled:cursor-not-allowed",children:"Apply Range"}),t.jsx(C,{size:"sm",variant:"outline",onClick:N,className:"border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white",children:"Clear"})]})]})]})})]}):t.jsxs("div",{className:`space-y-3 ${b}`,children:[t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx(R,{className:"w-4 h-4 text-emerald-400"}),t.jsx(S,{className:"text-sm font-medium text-gray-200",children:p})]}),t.jsxs(E,{value:d,onValueChange:n,children:[t.jsx(T,{className:"bg-gray-800 border-gray-700 text-white hover:bg-gray-750 focus:border-emerald-500 transition-colors",children:t.jsx(A,{})}),t.jsx(O,{className:"bg-gray-800 border-gray-700",children:V.map(i=>t.jsx(I,{value:i.value,className:"text-white hover:bg-gray-700 focus:bg-gray-700 cursor-pointer",children:i.label},i.value))})]}),d==="custom"&&t.jsxs("div",{className:"space-y-4 pt-3 border-t border-gray-700",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(S,{className:"text-xs font-medium text-gray-400",children:"Start Date"}),t.jsx(k,{type:"date",value:f,onChange:i=>m(i.target.value),className:"bg-gray-800 border-gray-700 text-white focus:border-emerald-500 focus:ring-emerald-500/20 transition-colors"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(S,{className:"text-xs font-medium text-gray-400",children:"End Date"}),t.jsx(k,{type:"date",value:u,onChange:i=>e(i.target.value),className:"bg-gray-800 border-gray-700 text-white focus:border-emerald-500 focus:ring-emerald-500/20 transition-colors"})]})]}),t.jsxs("div",{className:"flex gap-3 pt-2",children:[t.jsx(C,{size:"sm",onClick:w,disabled:!f||!u,className:"flex-1 bg-emerald-600 hover:bg-emerald-700 text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:"Apply Range"}),t.jsx(C,{size:"sm",variant:"outline",onClick:N,className:"border-gray-700 text-gray-300 hover:bg-gray-800 hover:text-white hover:border-gray-600 transition-colors",children:"Clear"})]})]})]})}export{le as D,ie as a,ne as b,oe as c,re as e,se as g};
