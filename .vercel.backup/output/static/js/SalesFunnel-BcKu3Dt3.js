import{a as $,j as e}from"./vendor-state-CpjwTZNq.js";import{r as y}from"./vendor-react-DoYyFkVR.js";import{c as T,s as D,d as A,b as B,x as P}from"./index.html-Cwo_Unfk.js";import{p as f,M as k,s as R}from"./vendor-utils-Cb9OXVhE.js";import{a as q}from"./vendor-router-CQXjpROx.js";import{P as F,U as C,F as L,e as V}from"./vendor-icons-HRBKouGg.js";import{motion as M}from"./ui-animation-Dzb4KUJ1.js";import"./vendor-supabase-BuXd-BBn.js";import"./ui-radix-core-CdvL28QE.js";import"./vendor-charts-D4YcUEy1.js";async function _(o,d){const{data:{user:a}}=await D.auth.getUser();if(!a)return null;const{data:b,error:m}=await D.from("activities").select("*").eq("user_id",a.id).gte("date",f(o,"yyyy-MM-dd")).lte("date",f(d,"yyyy-MM-dd")).order("date",{ascending:!1});if(m)throw m;const h=k(o,1),p=k(d,1),{data:u,error:g}=await D.from("activities").select("*").eq("user_id",a.id).gte("date",f(h,"yyyy-MM-dd")).lte("date",f(p,"yyyy-MM-dd"));if(g)throw g;return{current:b,previous:u}}function E(o,d){const{userData:a}=T();return $({queryKey:["salesData",a?.id,o,d],queryFn:()=>_(o,d),enabled:!!a?.id})}function z(){return e.jsx("div",{className:"p-4 sm:p-6 lg:p-8 mt-12 lg:mt-0 animate-pulse",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-6 sm:mb-8 lg:mb-12",children:[e.jsx("div",{className:"h-8 w-48 bg-gray-800 rounded-lg mb-2"}),e.jsx("div",{className:"h-4 w-64 bg-gray-800 rounded-lg"})]}),e.jsx("div",{className:"relative max-w-4xl mx-auto space-y-4",children:[100,80,60,40].map((o,d)=>e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-800 rounded-lg"}),e.jsxs("div",{children:[e.jsx("div",{className:"h-6 w-32 bg-gray-800 rounded-lg mb-1"}),e.jsx("div",{className:"h-8 w-16 bg-gray-800 rounded-lg"})]})]}),e.jsx("div",{className:"h-16 bg-gray-800 rounded-xl",style:{width:`${o}%`}})]},d))}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mt-8",children:[1,2,3].map(o=>e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl p-6 border border-gray-800/50",children:[e.jsx("div",{className:"h-6 w-32 bg-gray-800 rounded-lg mb-2"}),e.jsx("div",{className:"h-10 w-24 bg-gray-800 rounded-lg mb-1"}),e.jsx("div",{className:"h-4 w-40 bg-gray-800 rounded-lg"})]},o))})]})})}function U(o){return y.useMemo(()=>{if(!o)return{outbound:0,meetings:0,meetingsBooked:0,proposals:0,closed:0,meetingToProposalRate:0,proposalWinRate:0,avgDealSize:0,avgSalesVelocity:0};const d=R(new Date),a=o.filter(s=>{const t=new Date(s.date);return t>=d&&t<=new Date}),b=a.filter(s=>s.type==="outbound").reduce((s,t)=>s+(t.quantity||1),0),m=a.filter(s=>s.type==="meeting"&&s.status==="completed").reduce((s,t)=>s+(t.quantity||1),0),h=a.filter(s=>s.type==="meeting").reduce((s,t)=>s+(t.quantity||1),0),p=a.filter(s=>s.type==="proposal").reduce((s,t)=>s+(t.quantity||1),0),u=a.filter(s=>s.type==="sale").reduce((s,t)=>s+(t.quantity||1),0),g=m>0?Math.round(p/m*100):0,j=p>0?Math.round(u/p*100):0,v=a.filter(s=>s.type==="sale").reduce((s,t)=>s+(t.amount||0),0),w=u>0?Math.round(v/u):0,i=(()=>{const s=a.filter(c=>c.type==="sale"&&c.deal_id);if(s.length===0)return 0;const t=[];for(const c of s){const r=o.filter(l=>l.deal_id===c.deal_id&&(l.type==="meeting"||l.type==="outbound"||l.type==="proposal")).sort((l,n)=>new Date(l.date).getTime()-new Date(n.date).getTime())[0];if(r){const l=new Date(r.date),n=new Date(c.date),x=Math.ceil((n.getTime()-l.getTime())/(1e3*60*60*24));x>=0&&t.push(x)}}if(t.length===0){const c=a.filter(r=>r.type==="sale"&&!r.deal_id);for(const r of c){const l=o.filter(n=>n.type==="meeting"&&n.client_name===r.client_name).sort((n,x)=>new Date(n.date).getTime()-new Date(x.date).getTime())[0];if(l){const n=new Date(l.date),x=new Date(r.date),S=Math.ceil((x.getTime()-n.getTime())/(1e3*60*60*24));S>=0&&t.push(S)}}}return t.length>0?Math.round(t.reduce((c,r)=>c+r,0)/t.length):0})();return{outbound:b,meetings:m,meetingsBooked:h,proposals:p,closed:u,meetingToProposalRate:g,proposalWinRate:j,avgDealSize:w,avgSalesVelocity:i}},[o])}function Z(){const{userData:o}=T(),d=q(),[a]=y.useState({start:new Date(new Date().setDate(1)),end:new Date}),{setFilters:b}=A(),{activities:m,isLoading:h}=B(),{data:p,isLoading:u}=E(a.start,a.end),{data:g,isLoading:j}=P(o?.id),[v,w]=y.useState(!1),N=h||u||j||!o;y.useEffect(()=>{let t;return!N&&!v&&(t=window.setTimeout(()=>{w(!0)},500)),()=>{t&&window.clearTimeout(t)}},[N]);const i=U(m),s=y.useMemo(()=>[{id:"outbound",label:"Outbound",value:i.outbound,icon:F,color:"blue",description:"Initial outreach attempts"},{id:"meetings",label:"Meetings",value:i.meetings,totalBooked:i.meetingsBooked,icon:C,color:"violet",description:"Meetings held vs booked"},{id:"proposals",label:"Proposals",value:i.proposals,icon:L,color:"orange",description:"Proposals sent"},{id:"closed",label:"Signed",value:i.closed,icon:V,color:"emerald",description:"Deals signed"}],[i]);return v?g?e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:.2},className:"p-4 sm:p-6 lg:p-8 mt-12 lg:mt-0",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-6 sm:mb-8 lg:mb-12",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Sales Funnel"}),e.jsx("p",{className:"text-gray-400 mt-1",children:"Visualise your sales pipeline conversion rates"})]}),e.jsx("div",{className:"relative max-w-4xl mx-auto",children:s.map((t,c)=>{const r=Math.max(...s.map(x=>x.value)),l=r>0?t.value/r*100:0,n=t.totalBooked&&r>0?t.totalBooked/r*100:l;return e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center gap-4 mb-2",children:[e.jsx("div",{className:`p-2 rounded-lg ${t.color==="blue"?"bg-blue-400/5":`bg-${t.color}-500/10`} border ${t.color==="blue"?"border-blue-500/10":`border-${t.color}-500/20`}`,children:e.jsx(t.icon,{className:`w-5 h-5 ${t.color==="blue"?"text-blue-400":`text-${t.color}-500`}`})}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("span",{className:"font-medium text-white",children:t.label}),e.jsx("span",{className:"text-sm text-gray-400",children:t.description})]}),e.jsxs("div",{className:"flex items-baseline gap-2",children:[e.jsx("div",{className:"text-2xl font-bold text-white",children:t.value}),t.totalBooked&&t.totalBooked!==t.value&&e.jsxs("div",{className:"text-lg text-gray-400",children:["/ ",t.totalBooked]})]})]})]}),e.jsxs("div",{className:"relative",children:[t.id==="meetings"&&t.totalBooked&&t.totalBooked>t.value&&e.jsx(M.div,{initial:{width:0},animate:{width:`${n}%`},transition:{duration:.4,ease:"easeOut"},className:"h-16 bg-gray-600/20 border border-gray-600/30 backdrop-blur-xl rounded-xl absolute inset-0"}),e.jsxs(M.div,{initial:{width:0},animate:{width:`${l}%`},transition:{duration:.4,ease:"easeOut",delay:.1},onClick:()=>{b({type:t.id==="closed"?"sale":t.id,dateRange:a}),d("/activity")},className:`h-16 ${t.color==="blue"?"bg-blue-400/5 border-blue-500/10 hover:bg-blue-400/10 hover:border-blue-500/20 hover:shadow-blue-400/10":`bg-${t.color}-500/10 border-${t.color}-500/20 hover:bg-${t.color}-500/20 hover:border-${t.color}-500/40 hover:shadow-${t.color}-500/20`} backdrop-blur-xl border rounded-xl relative overflow-hidden group transition-all duration-300 hover:shadow-lg cursor-pointer z-10`,children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-all duration-500"}),c<s.length-1&&e.jsx("div",{className:"absolute -bottom-4 left-1/2 w-0 h-0 border-l-[12px] border-l-transparent border-r-[12px] border-r-transparent border-t-[16px] border-gray-800/50",style:{transform:"translateX(-50%)"}})]})]})]},t.id)})}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mt-8 lg:mt-12",children:[e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl p-4 sm:p-6 border border-gray-800/50",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-1",children:"Meeting Conversion"}),e.jsxs("p",{className:"text-3xl font-bold text-white",children:[i.meetingToProposalRate,"%"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Meetings to Proposals"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl p-4 sm:p-6 border border-gray-800/50",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-1",children:"Proposal Win Rate"}),e.jsxs("p",{className:"text-3xl font-bold text-white",children:[i.proposalWinRate,"%"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Proposals to Signed"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl p-4 sm:p-6 border border-gray-800/50",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-1",children:"Avg. Deal Size"}),e.jsxs("p",{className:"text-3xl font-bold text-white",children:["Â£",i.avgDealSize?.toLocaleString()||0]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Average value of signed deals"})]}),e.jsxs("div",{className:"bg-gray-900/50 backdrop-blur-xl rounded-xl p-4 sm:p-6 border border-gray-800/50",children:[e.jsx("p",{className:"text-sm text-gray-400 mb-1",children:"Sales Velocity"}),e.jsxs("p",{className:"text-3xl font-bold text-white",children:[i.avgSalesVelocity||"-"," Days"]}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Average time to close deal"})]})]})]})}):e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[calc(100vh-4rem)] gap-4",children:[e.jsx("p",{className:"text-lg text-gray-400",children:"Unable to load sales funnel data"}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 text-sm font-medium text-white bg-[#37bd7e] rounded-lg hover:bg-[#2da76c] transition-colors",children:"Retry"})]}):e.jsx(z,{})}export{Z as default};
