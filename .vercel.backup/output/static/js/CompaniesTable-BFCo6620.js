import{j as e}from"./vendor-state-CpjwTZNq.js";import{r as l}from"./vendor-react-DoYyFkVR.js";import{B as G}from"./badge-C6MYiXDB.js";import{l as k,s as O,a as I,B as m,c as he,q as ue}from"./index.html-Cwo_Unfk.js";import{I as ge}from"./input-CeE6qNqI.js";import{S as H,a as W,b as Z,c as Q,d as E}from"./select-BFsZCfaH.js";import{Table as je,TableHeader as pe,TableRow as X,TableHead as p,TableBody as fe,TableCell as f}from"./table-C4c75fDG.js";import{O as ye}from"./OwnerFilter-bkhDp6eP.js";import{Dialog as M,DialogContent as L,DialogHeader as R,DialogTitle as q,DialogFooter as P,DialogDescription as Y}from"./dialog-BBMx1wit.js";import{B as $,k as be,at as Ne,X as ve,z as we,Z as Ce,E as Se,S as De,$ as _e,c as ke,aQ as Fe,a7 as Te,U as ze,a8 as Ee,Y as Ie,aT as J}from"./vendor-icons-HRBKouGg.js";import{motion as $e}from"./ui-animation-Dzb4KUJ1.js";import{p as K}from"./vendor-utils-Cb9OXVhE.js";import{C as Ve}from"./CRMNavigation-9kApijvP.js";import{a as Be}from"./vendor-router-CQXjpROx.js";import"./vendor-supabase-BuXd-BBn.js";import"./ui-radix-core-CdvL28QE.js";import"./vendor-charts-D4YcUEy1.js";function Ae({isOpen:j,onClose:y,companyId:o,companyName:V}){const[i,B]=l.useState([]),[b,F]=l.useState(!1);l.useEffect(()=>{j&&o&&h()},[j,o]);const h=async()=>{if(o){F(!0);try{k.log("ðŸ” Fetching deals for company ID:",o);let{data:a,error:n}=await O.from("deals").select(`
          *,
          deal_stages!inner (
            name,
            color
          )
        `).eq("company_id",o).order("created_at",{ascending:!1});if(n){k.warn("Relationship query failed, trying basic query:",n);const{data:v,error:S}=await O.from("deals").select("*").eq("company_id",o).order("created_at",{ascending:!1});if(S){k.error("Error fetching company deals:",S),I.error("Failed to load company deals");return}a=await Promise.all((v||[]).map(async x=>{if(x.stage_id)try{const{data:u}=await O.from("deal_stages").select("name, color").eq("id",x.stage_id).single();u&&(x.deal_stages=u)}catch(u){k.warn(`Could not fetch stage data for deal ${x.id}:`,u)}return x}))}k.log(`âœ… Found ${a?.length||0} deals for company`),B(a||[])}catch{I.error("Failed to load company deals")}finally{F(!1)}}},d=a=>a?new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",minimumFractionDigits:0,maximumFractionDigits:0}).format(a):"Â£0",N=a=>{switch(a?.toLowerCase()){case"won":return"text-emerald-400 bg-emerald-500/10 border-emerald-500/20";case"lost":return"text-red-400 bg-red-500/10 border-red-500/20";case"active":case"in_progress":return"text-blue-400 bg-blue-500/10 border-blue-500/20";default:return"text-gray-400 bg-gray-500/10 border-gray-500/20"}},A=a=>a.monthly_mrr&&a.monthly_mrr>0?{type:"Subscription",icon:we,color:"text-blue-400",value:d(a.monthly_mrr)+"/mo"}:a.one_off_revenue&&a.one_off_revenue>0?{type:"One-off",icon:Ce,color:"text-orange-400",value:d(a.one_off_revenue)}:{type:"Standard",icon:Se,color:"text-gray-400",value:d(a.value)};return j?e.jsx(M,{open:j,onOpenChange:y,children:e.jsxs(L,{className:"bg-gray-900/95 backdrop-blur-xl border-gray-800/50 text-white p-0 rounded-xl max-w-5xl max-h-[90vh] overflow-hidden",children:[e.jsx(R,{className:"p-6 pb-4 border-b border-gray-800/50",children:e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsxs(q,{className:"text-2xl font-bold text-white mb-2 flex items-center gap-3",children:[e.jsx($,{className:"w-6 h-6 text-blue-400"}),V," - Deals"]}),e.jsxs("div",{className:"text-sm text-gray-400",children:[i.length," ",i.length===1?"deal":"deals"," total"]})]})})}),e.jsx("div",{className:"p-6 max-h-[70vh] overflow-y-auto",children:b?e.jsx("div",{className:"animate-pulse space-y-4",children:[1,2,3].map(a=>e.jsx("div",{className:"h-20 bg-gray-700 rounded-lg"},a))}):i.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx($,{className:"w-12 h-12 text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-400 mb-2",children:"No deals found"}),e.jsx("p",{className:"text-gray-500 text-sm",children:"This company doesn't have any deals yet."})]}):e.jsx("div",{className:"space-y-4",children:i.map(a=>{const n=A(a),v=n.icon;return e.jsx($e.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"bg-gray-800/50 rounded-xl p-4 border border-gray-700/50 hover:border-gray-600/50 transition-all",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:`p-2 rounded-lg bg-gray-700/50 ${n.color}`,children:e.jsx(v,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-white",children:a.name}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-400",children:[e.jsx("span",{className:n.color,children:n.type}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:n.value}),a.expected_close_date&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(be,{className:"w-3 h-3"}),K(new Date(a.expected_close_date),"MMM d, yyyy")]})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[a.status&&e.jsx("div",{className:`px-2 py-1 rounded-full text-xs font-medium border ${N(a.status)}`,children:a.status.replace("_"," ").toUpperCase()}),a.deal_stages&&e.jsx("div",{className:"px-2 py-1 rounded-full text-xs font-medium bg-blue-500/10 border border-blue-500/20 text-blue-400",children:a.deal_stages.name})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"text-gray-400",children:"Total Value"}),e.jsx("div",{className:"font-medium text-white",children:d(a.value)})]}),a.monthly_mrr&&a.monthly_mrr>0&&e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"text-gray-400",children:"Monthly MRR"}),e.jsx("div",{className:"font-medium text-blue-400",children:d(a.monthly_mrr)})]}),a.one_off_revenue&&a.one_off_revenue>0&&e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"text-gray-400",children:"One-off Revenue"}),e.jsx("div",{className:"font-medium text-orange-400",children:d(a.one_off_revenue)})]})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 ml-4",children:[e.jsxs(m,{variant:"ghost",size:"sm",onClick:()=>{window.open(`/pipeline?deal=${a.id}`,"_blank")},className:"text-blue-400 hover:text-blue-300 hover:bg-blue-500/10",children:[e.jsx(Ne,{className:"w-4 h-4 mr-1"}),"View"]}),e.jsxs("div",{className:"text-xs text-gray-500 text-right",children:["Created ",K(new Date(a.created_at),"MMM d")]})]})]})},a.id)})})}),e.jsx(P,{className:"p-6 pt-4 border-t border-gray-800/50",children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs("div",{className:"text-sm text-gray-400",children:["Total Value: ",d(i.reduce((a,n)=>a+(n.value||0),0))]}),e.jsxs(m,{variant:"ghost",onClick:y,className:"bg-gray-800/50 text-gray-300 hover:bg-gray-800",children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),"Close"]})]})})]})}):null}function ss(){const j=Be(),{userData:y}=he(),[o,V]=l.useState(""),[i,B]=l.useState("all"),[b,F]=l.useState("all"),[h,d]=l.useState(y?.id),[N,A]=l.useState("updated_at"),[a,n]=l.useState("desc"),[v,S]=l.useState(null),[D,x]=l.useState(null),[u,T]=l.useState(null);l.useEffect(()=>{y?.id&&h===void 0&&d(y.id)},[y?.id,h]);const{companies:_,isLoading:ee,error:se}=ue({search:o,includeStats:!0}),U=se?.message||null,z=l.useMemo(()=>{let s=_.filter(r=>{const g=i==="all"||r.size===i,c=b==="all"||r.industry===b,t=!h||r.owner_id===h;return g&&c&&t});return s.sort((r,g)=>{let c=r[N],t=g[N];return c==null&&(c=""),t==null&&(t=""),typeof c=="string"&&(c=c.toLowerCase()),typeof t=="string"&&(t=t.toLowerCase()),c<t?a==="asc"?-1:1:c>t?a==="asc"?1:-1:0}),s},[_,i,b,h,N,a]),ae=[...new Set(_.map(s=>s.size).filter(Boolean))],te=[...new Set(_.map(s=>s.industry).filter(Boolean))],w=s=>{N===s?n(a==="asc"?"desc":"asc"):(A(s),n("asc"))},C=s=>N!==s?e.jsx(J,{className:"w-4 h-4 text-gray-400"}):e.jsx(J,{className:`w-4 h-4 ${a==="asc"?"text-blue-400":"text-blue-400 rotate-180"}`}),re=s=>new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP",maximumFractionDigits:0}).format(s),le=s=>s?.startsWith("www.")?s.slice(4):s,ne=()=>{const s=[["Name","Domain","Size","Industry","Contacts","Deals","Value","Created"].join(","),...z.map(t=>[`"${t.name}"`,`"${t.domain||""}"`,`"${t.size||""}"`,`"${t.industry||""}"`,t.contactCount||0,t.dealsCount||0,t.dealsValue||0,new Date(t.created_at).toLocaleDateString()].join(","))].join(`
`),r=new Blob([s],{type:"text/csv;charset=utf-8;"}),g=document.createElement("a"),c=URL.createObjectURL(r);g.setAttribute("href",c),g.setAttribute("download",`companies_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(g),g.click(),document.body.removeChild(g),I.success("Companies exported successfully")},ie=s=>{j(`/companies/${s.id}`)},ce=(s,r)=>{s.stopPropagation(),x(r)},oe=(s,r)=>{s.stopPropagation(),T(r)},de=async()=>{u&&(I.success(`Company "${u.name}" deleted successfully`),T(null))},xe=()=>{j("/companies/new")},me=()=>{let s=`${z.length} of ${_.length} companies`;return h&&(s+=" â€¢ Filtered by owner"),s};return ee?e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsx("div",{className:"bg-gray-900/50 rounded-xl p-8",children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-8 bg-gray-800 rounded w-1/4"}),e.jsx("div",{className:"h-4 bg-gray-800 rounded w-1/2"}),e.jsx("div",{className:"space-y-3 mt-6",children:[1,2,3,4,5].map(s=>e.jsx("div",{className:"h-16 bg-gray-800/50 rounded-lg"},s))})]})})}):U?e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsxs("div",{className:"bg-red-900/20 border border-red-700 rounded-xl p-6",children:[e.jsx("h3",{className:"text-red-400 font-medium mb-2",children:"Error loading companies"}),e.jsx("p",{className:"text-red-300 text-sm",children:U})]})}):e.jsxs("div",{children:[e.jsx(Ve,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx($,{className:"w-8 h-8 text-blue-400"}),e.jsx("h1",{className:"text-3xl font-bold text-white",children:"Companies"})]}),e.jsx("p",{className:"text-gray-400",children:me()})]}),e.jsx("div",{className:"bg-gray-900/50 rounded-xl p-6 mb-6 border border-gray-800",children:e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(De,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"}),e.jsx(ge,{placeholder:"Search companies by name or domain...",value:o,onChange:s=>V(s.target.value),className:"pl-10 bg-gray-800/50 border-gray-700 text-white placeholder-gray-400"})]}),e.jsx(ye,{selectedOwnerId:h,onOwnerChange:d,className:"w-full sm:w-[180px]"})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 flex-1",children:[e.jsxs(H,{value:i,onValueChange:B,children:[e.jsx(W,{className:"w-full sm:w-[180px] bg-gray-800/50 border-gray-700 text-white",children:e.jsx(Z,{placeholder:"All Sizes"})}),e.jsxs(Q,{className:"bg-gray-800 border-gray-700",children:[e.jsx(E,{value:"all",children:"All Sizes"}),ae.map(s=>e.jsx(E,{value:s,children:s},s))]})]}),e.jsxs(H,{value:b,onValueChange:F,children:[e.jsx(W,{className:"w-full sm:w-[180px] bg-gray-800/50 border-gray-700 text-white",children:e.jsx(Z,{placeholder:"All Industries"})}),e.jsxs(Q,{className:"bg-gray-800 border-gray-700",children:[e.jsx(E,{value:"all",children:"All Industries"}),te.map(s=>e.jsx(E,{value:s,children:s},s))]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{onClick:ne,variant:"outline",size:"sm",className:"border-gray-600 bg-gray-800/50 text-gray-100 hover:bg-gray-700/70 hover:text-white hover:border-gray-500",children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Export"]}),e.jsxs(m,{onClick:xe,className:"bg-blue-600 hover:bg-blue-700 text-white",size:"sm",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Add Company"]})]})]})]})}),e.jsxs("div",{className:"bg-gray-900/50 rounded-xl border border-gray-800 overflow-hidden",children:[e.jsxs(je,{children:[e.jsx(pe,{children:e.jsxs(X,{className:"border-gray-800 hover:bg-gray-800/50",children:[e.jsx(p,{className:"text-gray-300 cursor-pointer hover:text-white",onClick:()=>w("name"),children:e.jsxs("div",{className:"flex items-center gap-2",children:["Company ",C("name")]})}),e.jsx(p,{className:"text-gray-300 cursor-pointer hover:text-white",onClick:()=>w("domain"),children:e.jsxs("div",{className:"flex items-center gap-2",children:["Domain ",C("domain")]})}),e.jsx(p,{className:"text-gray-300 cursor-pointer hover:text-white",onClick:()=>w("size"),children:e.jsxs("div",{className:"flex items-center gap-2",children:["Size ",C("size")]})}),e.jsx(p,{className:"text-gray-300 cursor-pointer hover:text-white",onClick:()=>w("industry"),children:e.jsxs("div",{className:"flex items-center gap-2",children:["Industry ",C("industry")]})}),e.jsx(p,{className:"text-gray-300 cursor-pointer hover:text-white text-center",onClick:()=>w("contactCount"),children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:["Contacts ",C("contactCount")]})}),e.jsx(p,{className:"text-gray-300 cursor-pointer hover:text-white text-center",onClick:()=>w("dealsCount"),children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:["Deals ",C("dealsCount")]})}),e.jsx(p,{className:"text-gray-300 cursor-pointer hover:text-white text-right",onClick:()=>w("dealsValue"),children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:["Value ",C("dealsValue")]})}),e.jsx(p,{className:"text-gray-300 text-center",children:"Actions"})]})}),e.jsx(fe,{children:z.map(s=>e.jsxs(X,{className:"border-gray-800 hover:bg-gray-800/50 cursor-pointer transition-colors",onClick:()=>ie(s),children:[e.jsx(f,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"font-medium text-white",children:s.name}),s.description&&e.jsx("div",{className:"text-sm text-gray-400 truncate max-w-xs",children:s.description})]})}),e.jsx(f,{children:e.jsx("div",{className:"flex items-center gap-2",children:s.domain&&e.jsxs(e.Fragment,{children:[e.jsx(Fe,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-gray-300",children:le(s.domain)}),s.website&&e.jsx("a",{href:s.website,target:"_blank",rel:"noopener noreferrer",className:"text-blue-400 hover:text-blue-300",children:e.jsx(Te,{className:"w-3 h-3"})})]})})}),e.jsx(f,{children:s.size&&e.jsx(G,{variant:"outline",className:"text-xs",children:s.size})}),e.jsx(f,{children:s.industry&&e.jsx(G,{variant:"outline",className:"text-xs",children:s.industry})}),e.jsx(f,{className:"text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1 text-gray-300",children:[e.jsx(ze,{className:"w-4 h-4 text-gray-400"}),s.contactCount||0]})}),e.jsx(f,{className:"text-center",children:(s.dealsCount||0)>0?e.jsx("button",{onClick:()=>S({id:s.id,name:s.name}),className:"text-blue-400 hover:text-blue-300 font-medium hover:underline transition-colors",children:s.dealsCount}):e.jsx("span",{className:"text-gray-500",children:"0"})}),e.jsx(f,{className:"text-right text-emerald-400 font-medium",children:re(s.dealsValue||0)}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(m,{variant:"ghost",size:"sm",onClick:r=>ce(r,s),className:"text-gray-400 hover:text-blue-400 hover:bg-blue-400/10 transition-colors",title:"Edit company",children:e.jsx(Ee,{className:"w-4 h-4"})}),e.jsx(m,{variant:"ghost",size:"sm",onClick:r=>oe(r,s),className:"text-gray-400 hover:text-red-400 hover:bg-red-400/10 transition-colors",title:"Delete company",children:e.jsx(Ie,{className:"w-4 h-4"})})]})})]},s.id))})]}),z.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx($,{className:"w-12 h-12 text-gray-600 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-400 mb-2",children:"No companies found"}),e.jsx("p",{className:"text-gray-500 text-sm",children:o||i!=="all"||b!=="all"?"Try adjusting your search criteria or filters":"Get started by adding your first company"})]})]}),e.jsx(Ae,{isOpen:!!v,onClose:()=>S(null),companyId:v?.id||null,companyName:v?.name||""}),e.jsx(M,{open:!!u,onOpenChange:()=>T(null),children:e.jsxs(L,{className:"bg-gray-900 border-gray-800 text-white",children:[e.jsxs(R,{children:[e.jsx(q,{className:"text-red-400",children:"Delete Company"}),e.jsxs(Y,{className:"text-gray-400",children:["Are you sure you want to delete ",e.jsxs("span",{className:"font-semibold text-white",children:['"',u?.name,'"']}),"? This action cannot be undone and will also remove all associated contacts, deals, and activities."]})]}),e.jsxs(P,{className:"gap-2 sm:gap-0",children:[e.jsx(m,{variant:"outline",onClick:()=>T(null),className:"bg-gray-800 border-gray-700 text-white hover:bg-gray-700",children:"Cancel"}),e.jsx(m,{onClick:de,className:"bg-red-600 hover:bg-red-700 text-white",children:"Delete Company"})]})]})}),e.jsx(M,{open:!!D,onOpenChange:()=>x(null),children:e.jsxs(L,{className:"bg-gray-900 border-gray-800 text-white max-w-md",children:[e.jsxs(R,{children:[e.jsx(q,{className:"text-blue-400",children:"Edit Company"}),e.jsxs(Y,{className:"text-gray-400",children:["Editing company: ",e.jsxs("span",{className:"font-semibold text-white",children:['"',D?.name,'"']})]})]}),e.jsx("div",{className:"py-4",children:e.jsx("p",{className:"text-gray-400 text-sm",children:"Full edit functionality coming soon. Click on the company row to view the complete company profile where you can edit all details."})}),e.jsxs(P,{className:"gap-2 sm:gap-0",children:[e.jsx(m,{variant:"outline",onClick:()=>x(null),className:"bg-gray-800 border-gray-700 text-white hover:bg-gray-700",children:"Close"}),e.jsx(m,{onClick:()=>{D&&(j(`/companies/${D.id}`),x(null))},className:"bg-blue-600 hover:bg-blue-700 text-white",children:"Open Profile"})]})]})})]})]})}export{ss as default};
