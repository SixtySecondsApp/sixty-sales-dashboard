<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test View Mode Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        h1, h2 {
            color: #10B981;
        }
        .test-section {
            background: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        button {
            background: #10B981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #059669;
        }
        button:disabled {
            background: #4a4a4a;
            cursor: not-allowed;
        }
        .result {
            background: #1f2937;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Courier New', monospace;
        }
        .success {
            border-left: 4px solid #10B981;
        }
        .error {
            border-left: 4px solid #EF4444;
        }
        .info {
            border-left: 4px solid #3B82F6;
        }
        .warning {
            border-left: 4px solid #F59E0B;
        }
        .user-card {
            display: inline-block;
            padding: 10px 15px;
            margin: 5px;
            background: #374151;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .user-card:hover {
            background: #4B5563;
            transform: translateY(-2px);
        }
        .user-card.active {
            background: #10B981;
            color: white;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #374151;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #10B981;
        }
        .metric-label {
            font-size: 14px;
            color: #9CA3AF;
            margin-top: 5px;
        }
        .view-mode-banner {
            background: #F59E0B;
            color: #1a1a1a;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üîç View Mode Dashboard Test</h1>
    
    <div id="viewModeBanner" class="view-mode-banner" style="display: none;">
        Currently viewing data as: <span id="viewedUserName"></span>
    </div>

    <div class="test-section">
        <h2>üë• Select User to View</h2>
        <div id="userList">Loading users...</div>
        <button onclick="exitViewMode()" style="background: #EF4444; margin-top: 10px;">Exit View Mode</button>
        <div id="userResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üìä Dashboard Metrics</h2>
        <div id="metrics" class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="revenue">$0</div>
                <div class="metric-label">Revenue</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="meetings">0</div>
                <div class="metric-label">Meetings</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="proposals">0</div>
                <div class="metric-label">Proposals</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="outbound">0</div>
                <div class="metric-label">Outbound</div>
            </div>
        </div>
        <button onclick="refreshMetrics()">Refresh Metrics</button>
        <div id="metricsResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>üéØ Activities</h2>
        <button onclick="loadActivities()">Load Activities</button>
        <div id="activitiesResult" class="result"></div>
    </div>

    <div class="test-section">
        <h2>‚úÖ Test Results</h2>
        <button onclick="runFullTest()">Run Full Test</button>
        <div id="testResult" class="result"></div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        
        // Initialize Supabase
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // ViewMode state
        let currentViewMode = null;
        let currentUser = null;
        
        // Load users
        async function loadUsers() {
            const userListDiv = document.getElementById('userList');
            
            try {
                // Get current user first
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    userListDiv.innerHTML = 'Not authenticated. Please log in.';
                    return;
                }
                currentUser = user;
                
                // Get list of users
                const { data: users, error } = await supabase
                    .from('profiles')
                    .select('id, email, first_name, last_name')
                    .order('first_name');
                
                if (error) throw error;
                
                userListDiv.innerHTML = '';
                users.forEach(u => {
                    const card = document.createElement('div');
                    card.className = 'user-card';
                    if (currentViewMode?.id === u.id) {
                        card.className += ' active';
                    }
                    card.innerHTML = `
                        <div>${u.first_name || ''} ${u.last_name || ''}</div>
                        <small>${u.email}</small>
                        ${u.id === currentUser.id ? ' (You)' : ''}
                    `;
                    card.onclick = () => startViewMode(u);
                    userListDiv.appendChild(card);
                });
                
            } catch (error) {
                userListDiv.innerHTML = 'Error loading users: ' + error.message;
            }
        }
        
        // Start view mode
        window.startViewMode = function(user) {
            currentViewMode = user;
            sessionStorage.setItem('viewMode', JSON.stringify(user));
            
            // Update UI
            document.getElementById('viewModeBanner').style.display = 'block';
            document.getElementById('viewedUserName').textContent = 
                `${user.first_name || ''} ${user.last_name || ''} (${user.email})`;
            
            // Update user cards
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.user-card')?.classList.add('active');
            
            document.getElementById('userResult').className = 'result info';
            document.getElementById('userResult').textContent = 
                `Viewing as: ${user.email}\nUser ID: ${user.id}`;
            
            // Refresh metrics
            refreshMetrics();
        };
        
        // Exit view mode
        window.exitViewMode = function() {
            currentViewMode = null;
            sessionStorage.removeItem('viewMode');
            
            // Update UI
            document.getElementById('viewModeBanner').style.display = 'none';
            document.querySelectorAll('.user-card').forEach(card => {
                card.classList.remove('active');
            });
            
            document.getElementById('userResult').className = 'result success';
            document.getElementById('userResult').textContent = 'Exited view mode. Showing your own data.';
            
            // Refresh metrics
            refreshMetrics();
        };
        
        // Refresh metrics
        window.refreshMetrics = async function() {
            const result = document.getElementById('metricsResult');
            result.textContent = 'Loading metrics...';
            
            try {
                const targetUserId = currentViewMode?.id || currentUser?.id;
                if (!targetUserId) {
                    throw new Error('No user selected');
                }
                
                // Get current month activities
                const startOfMonth = new Date();
                startOfMonth.setDate(1);
                startOfMonth.setHours(0, 0, 0, 0);
                
                const endOfMonth = new Date(startOfMonth);
                endOfMonth.setMonth(endOfMonth.getMonth() + 1);
                endOfMonth.setDate(0);
                endOfMonth.setHours(23, 59, 59, 999);
                
                const { data: activities, error } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('user_id', targetUserId)
                    .gte('date', startOfMonth.toISOString())
                    .lte('date', endOfMonth.toISOString());
                
                if (error) throw error;
                
                // Calculate metrics
                const metrics = {
                    revenue: 0,
                    meetings: 0,
                    proposals: 0,
                    outbound: 0
                };
                
                activities.forEach(a => {
                    switch (a.type) {
                        case 'sale':
                            metrics.revenue += a.amount || 0;
                            break;
                        case 'meeting':
                            metrics.meetings += a.quantity || 1;
                            break;
                        case 'proposal':
                            metrics.proposals += a.quantity || 1;
                            break;
                        case 'outbound':
                            metrics.outbound += a.quantity || 1;
                            break;
                    }
                });
                
                // Update UI
                document.getElementById('revenue').textContent = `$${metrics.revenue.toLocaleString()}`;
                document.getElementById('meetings').textContent = metrics.meetings;
                document.getElementById('proposals').textContent = metrics.proposals;
                document.getElementById('outbound').textContent = metrics.outbound;
                
                result.className = 'result success';
                result.textContent = `Metrics loaded for ${currentViewMode ? currentViewMode.email : 'your account'}\n` +
                                    `Total activities: ${activities.length}\n` +
                                    `User ID: ${targetUserId}`;
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'Error loading metrics: ' + error.message;
            }
        };
        
        // Load activities
        window.loadActivities = async function() {
            const result = document.getElementById('activitiesResult');
            result.textContent = 'Loading activities...';
            
            try {
                const targetUserId = currentViewMode?.id || currentUser?.id;
                if (!targetUserId) {
                    throw new Error('No user selected');
                }
                
                const { data: activities, error } = await supabase
                    .from('activities')
                    .select('*')
                    .eq('user_id', targetUserId)
                    .order('date', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                result.className = 'result info';
                result.textContent = `Recent activities for ${currentViewMode ? currentViewMode.email : 'your account'}:\n\n`;
                
                activities.forEach(a => {
                    result.textContent += `${a.date} - ${a.type}: ${a.client_name || 'N/A'} `;
                    if (a.amount) result.textContent += `($${a.amount})`;
                    result.textContent += '\n';
                });
                
                if (activities.length === 0) {
                    result.textContent += 'No activities found.';
                }
                
            } catch (error) {
                result.className = 'result error';
                result.textContent = 'Error loading activities: ' + error.message;
            }
        };
        
        // Run full test
        window.runFullTest = async function() {
            const result = document.getElementById('testResult');
            result.className = 'result info';
            result.textContent = 'Running comprehensive test...\n\n';
            
            try {
                // Test 1: Load users
                result.textContent += '1. Loading users... ';
                await loadUsers();
                result.textContent += '‚úÖ\n';
                
                // Test 2: Get a different user
                const { data: users } = await supabase
                    .from('profiles')
                    .select('id, email, first_name, last_name')
                    .neq('id', currentUser.id)
                    .limit(1)
                    .single();
                
                if (!users) {
                    result.textContent += '‚ö†Ô∏è No other users found for testing\n';
                    return;
                }
                
                // Test 3: Enter view mode
                result.textContent += '2. Entering view mode for ' + users.email + '... ';
                startViewMode(users);
                result.textContent += '‚úÖ\n';
                
                // Test 4: Load metrics in view mode
                result.textContent += '3. Loading metrics in view mode... ';
                await refreshMetrics();
                result.textContent += '‚úÖ\n';
                
                // Test 5: Load activities in view mode
                result.textContent += '4. Loading activities in view mode... ';
                await loadActivities();
                result.textContent += '‚úÖ\n';
                
                // Test 6: Exit view mode
                result.textContent += '5. Exiting view mode... ';
                exitViewMode();
                result.textContent += '‚úÖ\n';
                
                // Test 7: Load own metrics
                result.textContent += '6. Loading own metrics... ';
                await refreshMetrics();
                result.textContent += '‚úÖ\n';
                
                result.className = 'result success';
                result.textContent += '\n‚úÖ All tests passed! View mode is working correctly.';
                
            } catch (error) {
                result.className = 'result error';
                result.textContent += '\n‚ùå Test failed: ' + error.message;
            }
        };
        
        // Initialize on load
        window.addEventListener('load', () => {
            // Check for existing view mode
            const stored = sessionStorage.getItem('viewMode');
            if (stored) {
                try {
                    currentViewMode = JSON.parse(stored);
                    document.getElementById('viewModeBanner').style.display = 'block';
                    document.getElementById('viewedUserName').textContent = 
                        `${currentViewMode.first_name || ''} ${currentViewMode.last_name || ''} (${currentViewMode.email})`;
                } catch (e) {
                    sessionStorage.removeItem('viewMode');
                }
            }
            
            loadUsers();
            refreshMetrics();
        });
    </script>
    
    <div style="margin-top: 40px; padding: 20px; background: #374151; border-radius: 8px;">
        <h3>üìù Instructions</h3>
        <ol>
            <li>Update SUPABASE_URL and SUPABASE_ANON_KEY in the script</li>
            <li>Click on any user card to enter View Mode</li>
            <li>Dashboard metrics should update to show that user's data</li>
            <li>Click "Exit View Mode" to return to your own data</li>
            <li>Run the full test to verify everything works</li>
        </ol>
        
        <h3>‚úÖ What's Fixed</h3>
        <ul>
            <li>Dashboard now respects View Mode context</li>
            <li>Activities are fetched for the viewed user, not current user</li>
            <li>Real-time subscriptions update for the correct user</li>
            <li>Cache keys include View Mode user for proper separation</li>
            <li>All dashboard metrics calculate based on viewed user's data</li>
        </ul>
    </div>
</body>
</html>