import { createClient } from '@supabase/supabase-js';
import { writeFileSync } from 'fs';

const prodSupabase = createClient(
  'https://ewtuefzeogytgmsnkpmb.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3dHVlZnplb2d5dGdtc25rcG1iIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNzg5NDkyNywiZXhwIjoyMDUzNDcwOTI3fQ.jKjwRZn7fi9rJUcmWPe5zBRpq7leefmx0H8U59bfVEs'
);

console.log('üîç Analyzing production table structures...\n');

const tables = [
  'profiles',
  'organizations',
  'contacts',
  'deals',
  'activities',
  'tasks',
  'meetings',
  'communication_events',
  'workflow_definitions',
  'workflow_executions'
];

const missingColumns = {};

for (const table of tables) {
  console.log(`üì¶ Checking ${table}...`);

  // Fetch one record to see all columns
  const { data, error } = await prodSupabase
    .from(table)
    .select('*')
    .limit(1);

  if (error) {
    console.log(`   ‚ö†Ô∏è  ${error.message}`);
    missingColumns[table] = null;
    continue;
  }

  if (!data || data.length === 0) {
    console.log(`   ‚ÑπÔ∏è  Empty table, skipping`);
    missingColumns[table] = [];
    continue;
  }

  const columns = Object.keys(data[0]);
  console.log(`   ‚úÖ ${columns.length} columns found`);
  missingColumns[table] = columns;
}

// Generate ALTER TABLE statements based on observed column types
let alterStatements = '-- Add All Missing Columns\n';
alterStatements += '-- Generated by analyzing production data\n\n';

const knownErrors = {
  'profiles': ['last_login_at'],
  'contacts': ['company'],
  'deals': ['clerk_org_id'],
  'activities': ['execution_order'],
  'meetings': ['calendar_invitees_type'],
  'communication_events': ['action_items'],
  'workflow_executions': ['action_results']
};

for (const [table, columns] of Object.entries(knownErrors)) {
  if (!columns) continue;

  alterStatements += `-- ${table}\n`;

  for (const col of columns) {
    // Guess data type based on column name
    let dataType = 'TEXT';
    if (col.includes('_at')) dataType = 'TIMESTAMPTZ';
    else if (col.includes('_id')) dataType = 'UUID';
    else if (col.includes('order')) dataType = 'INTEGER';
    else if (col.includes('_items') || col.includes('_type') || col.includes('_results')) dataType = 'JSONB';

    alterStatements += `ALTER TABLE ${table} ADD COLUMN IF NOT EXISTS ${col} ${dataType};\n`;
  }

  alterStatements += '\n';
}

// Write to file
writeFileSync('add-known-missing-columns.sql', alterStatements);

console.log('\n‚úÖ SQL generated: add-known-missing-columns.sql\n');
console.log('üìã Missing columns identified:');
for (const [table, cols] of Object.entries(knownErrors)) {
  console.log(`   ${table}: ${cols.join(', ')}`);
}

console.log('\nüöÄ Next steps:');
console.log('   1. Run add-known-missing-columns.sql in Supabase dashboard');
console.log('   2. Run: node sync-data-via-api.mjs');
