name: Seed Development-v2 Branch

on:
  workflow_dispatch:
    inputs:
      include_auth:
        description: 'Include auth.users data'
        required: false
        default: 'true'
        type: boolean

env:
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  seed-dev-branch:
    name: Seed Development-v2 with Full Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Authenticate with Supabase
        run: |
          supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Link to Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Link to Development-v2 Branch
        run: |
          echo "üîó Linking to development-v2 branch..."

          DEV_BRANCH_ID="17b178b9-bb9b-4ccd-a125-5e49398bb989"

          # Switch to the development-v2 branch
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --branch $DEV_BRANCH_ID --experimental

          echo "‚úÖ Linked to development-v2"

      - name: Apply Migrations to Development-v2
        run: |
          echo "üì¶ Applying migrations to development-v2..."

          # Use supabase db push which should work in GitHub Actions
          # The --linked flag uses the branch we just linked to
          supabase db push --linked --debug || {
            echo "‚ö†Ô∏è  db push had warnings, checking if migrations were applied..."

            # Verify migrations were applied by checking if tables exist
            DEV_BRANCH_ID="17b178b9-bb9b-4ccd-a125-5e49398bb989"
            BRANCH_INFO=$(supabase branches get $DEV_BRANCH_ID --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json --experimental)
            NON_POOLING_URL=$(echo "$BRANCH_INFO" | jq -r '.POSTGRES_URL_NON_POOLING // empty')
            DB_NAME=$(echo "$NON_POOLING_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
            DEV_DB_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-us-west-1.pooler.supabase.com:5432/$DB_NAME"

            # Check if profiles table exists
            if psql "$DEV_DB_URL" -c "SELECT 1 FROM profiles LIMIT 1" 2>/dev/null; then
              echo "‚úÖ Migrations were applied successfully"
            else
              echo "‚ùå Migrations failed to apply"
              exit 1
            fi
          }

          echo "‚úÖ Migrations applied"

      - name: Export Production Schema and Data
        run: |
          echo "üì¶ Exporting production database (schema + data)..."

          # Supavisor Session Mode (port 5432) for IPv4 compatibility
          PROD_DB_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-us-west-1.pooler.supabase.com:5432/postgres"

          # Export public schema with data
          pg_dump "$PROD_DB_URL" \
            --no-owner \
            --no-privileges \
            --schema=public \
            --data-only \
            -Fc \
            -f production_data.dump

          DUMP_SIZE=$(du -h production_data.dump | cut -f1)
          echo "‚úÖ Production data exported: $DUMP_SIZE"

      - name: Export Auth Users (if enabled)
        if: inputs.include_auth == true || inputs.include_auth == 'true'
        run: |
          echo "üì¶ Exporting auth.users..."

          PROD_DB_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-us-west-1.pooler.supabase.com:5432/postgres"

          # Export auth schema separately (users, identities, sessions)
          pg_dump "$PROD_DB_URL" \
            --no-owner \
            --no-privileges \
            --schema=auth \
            --data-only \
            --table=auth.users \
            --table=auth.identities \
            -Fc \
            -f auth_data.dump

          AUTH_SIZE=$(du -h auth_data.dump | cut -f1)
          echo "‚úÖ Auth data exported: $AUTH_SIZE"

      - name: Restore Data to Development-v2
        run: |
          echo "üîÑ Restoring data to development-v2..."

          # Get development-v2 connection
          DEV_BRANCH_ID="17b178b9-bb9b-4ccd-a125-5e49398bb989"
          BRANCH_INFO=$(supabase branches get $DEV_BRANCH_ID --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json --experimental || echo "{}")
          NON_POOLING_URL=$(echo "$BRANCH_INFO" | jq -r '.POSTGRES_URL_NON_POOLING // empty')
          DB_NAME=$(echo "$NON_POOLING_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
          DEV_DB_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-us-west-1.pooler.supabase.com:5432/$DB_NAME"

          # Restore public schema data
          echo "üì• Restoring public schema data..."
          pg_restore \
            --dbname="$DEV_DB_URL" \
            --no-owner \
            --no-privileges \
            --disable-triggers \
            --verbose \
            production_data.dump 2>&1 | head -50 || {
              echo "‚ö†Ô∏è  Restore completed with warnings"
            }

          echo "‚úÖ Public data restored"

      - name: Restore Auth Data (if enabled)
        if: inputs.include_auth == true || inputs.include_auth == 'true'
        run: |
          echo "üîÑ Restoring auth.users..."

          DEV_BRANCH_ID="17b178b9-bb9b-4ccd-a125-5e49398bb989"
          BRANCH_INFO=$(supabase branches get $DEV_BRANCH_ID --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json --experimental || echo "{}")
          NON_POOLING_URL=$(echo "$BRANCH_INFO" | jq -r '.POSTGRES_URL_NON_POOLING // empty')
          DB_NAME=$(echo "$NON_POOLING_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
          DEV_DB_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-us-west-1.pooler.supabase.com:5432/$DB_NAME"

          # Restore auth schema data
          echo "üì• Restoring auth schema data..."
          pg_restore \
            --dbname="$DEV_DB_URL" \
            --no-owner \
            --no-privileges \
            --disable-triggers \
            --verbose \
            auth_data.dump 2>&1 | head -50 || {
              echo "‚ö†Ô∏è  Auth restore completed with warnings"
            }

          echo "‚úÖ Auth data restored"

      - name: Verify Data
        run: |
          echo "üîç Verifying data..."

          DEV_BRANCH_ID="17b178b9-bb9b-4ccd-a125-5e49398bb989"
          BRANCH_INFO=$(supabase branches get $DEV_BRANCH_ID --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json --experimental || echo "{}")
          NON_POOLING_URL=$(echo "$BRANCH_INFO" | jq -r '.POSTGRES_URL_NON_POOLING // empty')
          DB_NAME=$(echo "$NON_POOLING_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
          DEV_DB_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-us-west-1.pooler.supabase.com:5432/$DB_NAME"

          # Check table counts
          psql "$DEV_DB_URL" <<'EOF'
          SELECT 'profiles' as table_name, COUNT(*) as count FROM profiles
          UNION ALL
          SELECT 'deals', COUNT(*) FROM deals
          UNION ALL
          SELECT 'contacts', COUNT(*) FROM contacts
          UNION ALL
          SELECT 'meetings', COUNT(*) FROM meetings
          UNION ALL
          SELECT 'activities', COUNT(*) FROM activities
          UNION ALL
          SELECT 'auth.users', COUNT(*) FROM auth.users
          ORDER BY table_name;
          EOF

          echo "‚úÖ Verification complete"

      - name: Summary
        if: always()
        run: |
          echo "## üå± Development-v2 Seeding Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: development-v2 (\`17b178b9-bb9b-4ccd-a125-5e49398bb989\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **Migrations**: ‚úÖ Applied" >> $GITHUB_STEP_SUMMARY
          echo "- **Public Data**: ‚úÖ Synced" >> $GITHUB_STEP_SUMMARY
          echo "- **Auth Users**: ${{ inputs.include_auth == true && '‚úÖ Synced' || '‚è≠Ô∏è  Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f production_data.dump auth_data.dump
          echo "üßπ Cleanup complete"
