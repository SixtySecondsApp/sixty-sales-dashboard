name: Seed Development-v2 Branch

on:
  workflow_dispatch:
    inputs:
      include_auth:
        description: 'Include auth.users data (not recommended with Clerk)'
        required: false
        default: 'false'
        type: boolean
      apply_migrations:
        description: 'Apply migrations before seeding'
        required: false
        default: 'true'
        type: boolean

env:
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  # AWS region for Supavisor pooler (us-west-1 for West US/North California)
  SUPABASE_REGION: us-west-1
  # Development branch ID (development-v2)
  DEV_BRANCH_ID: "17b178b9-bb9b-4ccd-a125-5e49398bb989"

jobs:
  seed-dev-branch:
    name: Seed Development-v2 with Production Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Authenticate with Supabase
        run: |
          supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Link to Supabase Project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Get Development Branch Database Info
        id: get-dev-db
        run: |
          echo "üîç Getting development branch database info..."

          # Get branch details using experimental flag
          BRANCH_INFO=$(supabase --experimental branches get $DEV_BRANCH_ID --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json 2>/dev/null || echo "{}")

          echo "üìã Branch info received"

          # Extract the branch reference from SUPABASE_URL
          BRANCH_URL=$(echo "$BRANCH_INFO" | jq -r '.SUPABASE_URL // empty' 2>/dev/null || echo "")

          if [ -n "$BRANCH_URL" ]; then
            # Extract branch ref from URL (e.g., https://jczngsvpywgrlgdwzjbr.supabase.co -> jczngsvpywgrlgdwzjbr)
            BRANCH_REF=$(echo "$BRANCH_URL" | sed -n 's|https://\([^.]*\)\.supabase\.co|\1|p')
            echo "üìã Branch ref: $BRANCH_REF"
            echo "branch_ref=$BRANCH_REF" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Could not get branch URL, using hardcoded ref"
            echo "branch_ref=jczngsvpywgrlgdwzjbr" >> $GITHUB_OUTPUT
          fi

          echo "db_name=postgres" >> $GITHUB_OUTPUT

      - name: Build Connection URLs
        id: build-urls
        run: |
          echo "üîß Building Supavisor connection URLs..."

          # Production DB URL
          PROD_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-${SUPABASE_REGION}.pooler.supabase.com:5432/postgres"

          # Development DB URL
          DEV_DB_NAME="${{ steps.get-dev-db.outputs.db_name }}"
          DEV_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-${SUPABASE_REGION}.pooler.supabase.com:5432/${DEV_DB_NAME}"

          echo "prod_url=$PROD_URL" >> $GITHUB_OUTPUT
          echo "dev_url=$DEV_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Connection URLs configured"

      - name: Apply Migrations to Development-v2
        if: inputs.apply_migrations == true || inputs.apply_migrations == 'true'
        run: |
          echo "üì¶ Applying migrations to development-v2..."

          # Use supabase db push to apply migrations
          supabase db push --linked --debug 2>&1 | head -100 || {
            echo "‚ö†Ô∏è db push had warnings, verifying tables exist..."

            # Check if key tables exist
            DEV_URL="${{ steps.build-urls.outputs.dev_url }}"
            if psql "$DEV_URL" -c "SELECT 1 FROM profiles LIMIT 1" 2>/dev/null; then
              echo "‚úÖ Tables exist, migrations appear to be applied"
            else
              echo "‚ùå Tables don't exist, migrations may have failed"
              exit 1
            fi
          }

          echo "‚úÖ Migrations applied"

      - name: Export Production Data
        id: export-data
        run: |
          echo "üì¶ Exporting production data..."

          PROD_URL="${{ steps.build-urls.outputs.prod_url }}"

          # Export public schema data only
          pg_dump "$PROD_URL" \
            --no-owner \
            --no-privileges \
            --schema=public \
            --data-only \
            -Fc \
            -f production_data.dump

          DUMP_SIZE=$(du -h production_data.dump | cut -f1)
          echo "‚úÖ Production data exported: $DUMP_SIZE"
          echo "dump_size=$DUMP_SIZE" >> $GITHUB_OUTPUT

      - name: Export Auth Users (if enabled)
        if: inputs.include_auth == true || inputs.include_auth == 'true'
        run: |
          echo "üì¶ Exporting auth.users..."
          echo "‚ö†Ô∏è Note: With Clerk auth, you should use clerk_user_mapping table instead"

          PROD_URL="${{ steps.build-urls.outputs.prod_url }}"

          pg_dump "$PROD_URL" \
            --no-owner \
            --no-privileges \
            --schema=auth \
            --data-only \
            --table=auth.users \
            --table=auth.identities \
            -Fc \
            -f auth_data.dump

          AUTH_SIZE=$(du -h auth_data.dump | cut -f1)
          echo "‚úÖ Auth data exported: $AUTH_SIZE"

      - name: Prepare Development Database
        run: |
          echo "üîß Preparing development database..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          psql "$DEV_URL" <<'EOF' || true
          -- Disable triggers
          SET session_replication_role = replica;

          -- Drop FK constraints that cause issues
          ALTER TABLE IF EXISTS meeting_action_items DROP CONSTRAINT IF EXISTS meeting_action_items_task_id_fkey CASCADE;
          ALTER TABLE IF EXISTS next_action_suggestions DROP CONSTRAINT IF EXISTS next_action_suggestions_created_task_id_fkey CASCADE;

          -- Truncate public tables
          DO $$
          DECLARE
            r RECORD;
          BEGIN
            FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename NOT LIKE 'pg_%')
            LOOP
              EXECUTE 'TRUNCATE TABLE public.' || quote_ident(r.tablename) || ' CASCADE';
            END LOOP;
          END $$;
          EOF

          echo "‚úÖ Development database prepared"

      - name: Restore Data to Development-v2
        run: |
          echo "üîÑ Restoring public schema data..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          pg_restore \
            --dbname="$DEV_URL" \
            --no-owner \
            --no-privileges \
            --disable-triggers \
            --data-only \
            --verbose \
            production_data.dump 2>&1 | grep -E "(processing|restoring|error)" | head -50 || {
              echo "‚ö†Ô∏è Restore completed with warnings"
            }

          echo "‚úÖ Public data restored"

      - name: Restore Auth Data (if enabled)
        if: inputs.include_auth == true || inputs.include_auth == 'true'
        run: |
          echo "üîÑ Restoring auth.users..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          pg_restore \
            --dbname="$DEV_URL" \
            --no-owner \
            --no-privileges \
            --disable-triggers \
            --data-only \
            --verbose \
            auth_data.dump 2>&1 | head -50 || {
              echo "‚ö†Ô∏è Auth restore completed with warnings"
            }

          echo "‚úÖ Auth data restored"

      - name: Restore Constraints
        run: |
          echo "üîß Restoring constraints..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          psql "$DEV_URL" <<'EOF' || true
          -- Re-enable triggers
          SET session_replication_role = DEFAULT;

          -- Restore FK constraints
          ALTER TABLE IF EXISTS meeting_action_items
            ADD CONSTRAINT IF NOT EXISTS meeting_action_items_task_id_fkey
            FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE SET NULL;

          ALTER TABLE IF EXISTS next_action_suggestions
            ADD CONSTRAINT IF NOT EXISTS next_action_suggestions_created_task_id_fkey
            FOREIGN KEY (created_task_id) REFERENCES tasks(id) ON DELETE SET NULL;
          EOF

          echo "‚úÖ Constraints restored"

      - name: Verify Data
        run: |
          echo "üîç Verifying data..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          psql "$DEV_URL" <<'EOF'
          SELECT 'profiles' as table_name, COUNT(*) as count FROM profiles
          UNION ALL SELECT 'deals', COUNT(*) FROM deals
          UNION ALL SELECT 'contacts', COUNT(*) FROM contacts
          UNION ALL SELECT 'meetings', COUNT(*) FROM meetings
          UNION ALL SELECT 'activities', COUNT(*) FROM activities
          UNION ALL SELECT 'clerk_user_mapping', COUNT(*) FROM clerk_user_mapping
          ORDER BY table_name;
          EOF

          echo "‚úÖ Verification complete"

      - name: Summary
        if: always()
        run: |
          echo "## üå± Development-v2 Seeding Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | development-v2 (\`$DEV_BRANCH_ID\`) |" >> $GITHUB_STEP_SUMMARY
          echo "| Migrations | ${{ inputs.apply_migrations && '‚úÖ Applied' || '‚è≠Ô∏è Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Public Data | ‚úÖ Synced (${{ steps.export-data.outputs.dump_size }}) |" >> $GITHUB_STEP_SUMMARY
          echo "| Auth Users | ${{ inputs.include_auth == 'true' && '‚úÖ Synced' || '‚è≠Ô∏è Skipped (using Clerk)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f production_data.dump auth_data.dump
          echo "üßπ Cleanup complete"
