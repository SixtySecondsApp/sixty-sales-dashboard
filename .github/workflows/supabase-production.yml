name: Supabase Production Deploy

on:
  push:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
      - 'supabase/functions/**'
      - '.github/workflows/supabase-production.yml'

env:
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  deploy-migrations:
    name: Deploy Migrations to Production
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-15

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate with Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login --token -

      - name: Link to Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Check for new migrations
        id: check-migrations
        run: |
          # Get the last deployed commit (stored in a file or git tag)
          LAST_DEPLOYED=$(git log --format="%H" -n 1 --grep="supabase-migrations-deployed" || echo "")
          
          # Output LAST_DEPLOYED for use in subsequent steps
          echo "last_deployed=$LAST_DEPLOYED" >> $GITHUB_OUTPUT
          
          if [ -z "$LAST_DEPLOYED" ]; then
            # First time deployment - check all migrations
            echo "First time deployment - checking all migrations"
            MIGRATION_COUNT=$(find supabase/migrations -name "*.sql" | wc -l)
            echo "is_first_deploy=true" >> $GITHUB_OUTPUT
          else
            # Check migrations since last deployment
            MIGRATION_FILES=$(git diff --name-only $LAST_DEPLOYED HEAD | grep '^supabase/migrations/.*\.sql$' || true)
            MIGRATION_COUNT=$(echo "$MIGRATION_FILES" | grep -c . || echo "0")
            echo "is_first_deploy=false" >> $GITHUB_OUTPUT
          fi
          
          echo "migration_count=$MIGRATION_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$MIGRATION_COUNT" -eq "0" ]; then
            echo "â„¹ï¸ No new migrations to deploy"
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ Found $MIGRATION_COUNT migration(s) to deploy"
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy migrations to Production
        if: steps.check-migrations.outputs.skip_deploy == 'false'
        run: |
          echo "ðŸš€ Deploying migrations to Production..."
          
          # Get list of new migration files to apply
          if [ "${{ steps.check-migrations.outputs.is_first_deploy }}" == "true" ]; then
            echo "ðŸ“‹ First deployment - applying all migrations"
            MIGRATION_FILES=$(find supabase/migrations -name "*.sql" | sort)
          else
            LAST_DEPLOYED="${{ steps.check-migrations.outputs.last_deployed }}"
            echo "ðŸ“‹ Applying migrations since: $LAST_DEPLOYED"
            MIGRATION_FILES=$(git diff --name-only $LAST_DEPLOYED HEAD | grep '^supabase/migrations/.*\.sql$' | sort || true)
          fi
          
          # Apply each migration in order
          for migration_file in $MIGRATION_FILES; do
            if [ -f "$migration_file" ]; then
              echo "ðŸ“ Applying migration: $migration_file"
              PGPASSWORD="${{ secrets.SUPABASE_DB_PASSWORD }}" psql \
                "${{ secrets.PRODUCTION_DB_URL }}" \
                -f "$migration_file" \
                -v ON_ERROR_STOP=1
              
              if [ $? -eq 0 ]; then
                echo "âœ… Migration applied: $migration_file"
              else
                echo "âŒ Migration failed: $migration_file"
                exit 1
              fi
            fi
          done
          
          echo "âœ… All migrations deployed successfully"

      - name: Verify migrations applied
        if: steps.check-migrations.outputs.skip_deploy == 'false'
        run: |
          echo "ðŸ” Verifying migrations were applied..."
          
          # Check that we can connect to production database
          PGPASSWORD="${{ secrets.SUPABASE_DB_PASSWORD }}" psql \
            "${{ secrets.PRODUCTION_DB_URL }}" \
            -c "SELECT COUNT(*) as migration_count FROM supabase_migrations.schema_migrations;" || true
          
          echo "âœ… Migration verification complete"

      - name: Create deployment tag
        if: steps.check-migrations.outputs.skip_deploy == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "supabase-migrations-$(date +%Y%m%d-%H%M%S)" -m "Supabase migrations deployed to production" || true
          git push origin --tags || true

  deploy-edge-functions:
    name: Deploy Edge Functions to Production
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Authenticate with Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login --token -

      - name: Link to Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Check for function changes
        id: check-functions
        run: |
          FUNCTION_FILES=$(git diff --name-only origin/main~1 HEAD | grep '^supabase/functions/.*\.ts$' || true)
          FUNCTION_COUNT=$(echo "$FUNCTION_FILES" | grep -c . || echo "0")
          
          echo "function_count=$FUNCTION_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$FUNCTION_COUNT" -eq "0" ]; then
            echo "â„¹ï¸ No edge function changes detected"
            echo "skip_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“ Found $FUNCTION_COUNT function file(s) changed"
            echo "$FUNCTION_FILES"
            echo "skip_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Deploy edge functions
        if: steps.check-functions.outputs.skip_deploy == 'false'
        run: |
          echo "ðŸš€ Deploying edge functions to Production..."
          
          # Deploy all functions
          supabase functions deploy --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
          
          echo "âœ… Edge functions deployed successfully"

      - name: Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Supabase Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Migrations**: ${{ steps.check-migrations.outputs.skip_deploy == 'false' && 'âœ… Deployed' || 'â­ï¸ Skipped (no changes)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Edge Functions**: ${{ steps.check-functions.outputs.skip_deploy == 'false' && 'âœ… Deployed' || 'â­ï¸ Skipped (no changes)' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

