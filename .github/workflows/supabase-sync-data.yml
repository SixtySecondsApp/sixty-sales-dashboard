name: Sync Production Data to Development

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh even if no recent changes'
        required: false
        default: 'false'
        type: boolean
      tables:
        description: 'Specific tables to sync (comma-separated, or "all")'
        required: false
        default: 'all'
        type: string

env:
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
  # AWS region for Supavisor pooler (us-west-1 for West US/North California)
  SUPABASE_REGION: us-west-1
  # Development branch ID (development-v2)
  DEV_BRANCH_ID: "17b178b9-bb9b-4ccd-a125-5e49398bb989"

jobs:
  sync-production-to-development:
    name: Sync Production â†’ Development Branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Authenticate with Supabase
        run: |
          supabase login --token ${{ secrets.SUPABASE_ACCESS_TOKEN }}

      - name: Link to Supabase project
        run: |
          supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}

      - name: Verify Development Branch Exists
        id: verify-branch
        run: |
          echo "ğŸ” Verifying development-v2 branch..."

          # List branches to confirm the branch exists
          BRANCHES=$(supabase --experimental branches list --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json 2>/dev/null || echo "[]")

          echo "ğŸ“‹ Available branches:"
          echo "$BRANCHES" | jq -r '.[].name' 2>/dev/null || echo "Could not parse branches"

          # Check if our target branch exists
          BRANCH_EXISTS=$(echo "$BRANCHES" | jq -r --arg id "$DEV_BRANCH_ID" '.[] | select(.id == $id) | .name' 2>/dev/null || echo "")

          if [ -z "$BRANCH_EXISTS" ]; then
            echo "âš ï¸ Branch $DEV_BRANCH_ID not found in list, but continuing with direct connection..."
          else
            echo "âœ… Found branch: $BRANCH_EXISTS"
          fi

          echo "branch_verified=true" >> $GITHUB_OUTPUT

      - name: Get Development Branch Database Name
        id: get-dev-db
        run: |
          echo "ğŸ” Getting development branch database info..."

          # Get branch details
          BRANCH_INFO=$(supabase --experimental branches get $DEV_BRANCH_ID --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json 2>/dev/null || echo "{}")

          echo "ğŸ“‹ Branch info received"

          # Extract database name from the non-pooling URL
          NON_POOLING_URL=$(echo "$BRANCH_INFO" | jq -r '.POSTGRES_URL_NON_POOLING // empty' 2>/dev/null || echo "")

          if [ -z "$NON_POOLING_URL" ]; then
            echo "âš ï¸ Could not get POSTGRES_URL_NON_POOLING, using default database name"
            DB_NAME="postgres"
          else
            # Extract database name (after the last / and before any ?)
            DB_NAME=$(echo "$NON_POOLING_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
            if [ -z "$DB_NAME" ]; then
              DB_NAME="postgres"
            fi
          fi

          echo "ğŸ“‹ Database name: $DB_NAME"
          echo "db_name=$DB_NAME" >> $GITHUB_OUTPUT

      - name: Build Connection URLs
        id: build-urls
        run: |
          echo "ğŸ”§ Building Supavisor connection URLs..."

          # Production DB URL (Supavisor Session Mode - port 5432 for IPv4)
          PROD_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-${SUPABASE_REGION}.pooler.supabase.com:5432/postgres"

          # Development DB URL
          DEV_DB_NAME="${{ steps.get-dev-db.outputs.db_name }}"
          DEV_URL="postgres://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-${SUPABASE_REGION}.pooler.supabase.com:5432/${DEV_DB_NAME}"

          echo "prod_url=$PROD_URL" >> $GITHUB_OUTPUT
          echo "dev_url=$DEV_URL" >> $GITHUB_OUTPUT

          echo "âœ… Connection URLs configured"

      - name: Test Production Connection
        run: |
          echo "ğŸ” Testing production database connection..."
          psql "${{ steps.build-urls.outputs.prod_url }}" -c "SELECT 'Production connection successful' as status, NOW() as timestamp;" || {
            echo "âŒ Failed to connect to production database"
            exit 1
          }
          echo "âœ… Production connection verified"

      - name: Test Development Connection
        run: |
          echo "ğŸ” Testing development database connection..."
          psql "${{ steps.build-urls.outputs.dev_url }}" -c "SELECT 'Development connection successful' as status, NOW() as timestamp;" || {
            echo "âŒ Failed to connect to development database"
            exit 1
          }
          echo "âœ… Development connection verified"

      - name: Export Production Data
        id: export
        run: |
          echo "ğŸ“¦ Exporting production data..."

          PROD_URL="${{ steps.build-urls.outputs.prod_url }}"

          # Export public schema data only (schema comes from migrations)
          pg_dump "$PROD_URL" \
            --no-owner \
            --no-privileges \
            --schema=public \
            --data-only \
            -Fc \
            -f production_dump.dump

          DUMP_SIZE=$(du -h production_dump.dump | cut -f1)
          echo "âœ… Production data exported: $DUMP_SIZE"
          echo "dump_size=$DUMP_SIZE" >> $GITHUB_OUTPUT

      - name: Prepare Development Database
        run: |
          echo "ğŸ”§ Preparing development database for data restore..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          # Disable triggers temporarily and drop foreign key constraints that might cause issues
          psql "$DEV_URL" <<'EOF' || true
          -- Disable triggers on tables that might conflict
          SET session_replication_role = replica;

          -- Drop problematic FK constraints
          ALTER TABLE IF EXISTS meeting_action_items DROP CONSTRAINT IF EXISTS meeting_action_items_task_id_fkey CASCADE;
          ALTER TABLE IF EXISTS next_action_suggestions DROP CONSTRAINT IF EXISTS next_action_suggestions_created_task_id_fkey CASCADE;

          -- Truncate tables to avoid duplicate key errors (preserves schema)
          DO $$
          DECLARE
            r RECORD;
          BEGIN
            FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public' AND tablename NOT LIKE 'pg_%')
            LOOP
              EXECUTE 'TRUNCATE TABLE public.' || quote_ident(r.tablename) || ' CASCADE';
            END LOOP;
          END $$;
          EOF

          echo "âœ… Development database prepared"

      - name: Restore Data to Development Branch
        run: |
          echo "ğŸ”„ Restoring data to development branch..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          # Restore with triggers disabled
          pg_restore \
            --dbname="$DEV_URL" \
            --no-owner \
            --no-privileges \
            --disable-triggers \
            --data-only \
            --verbose \
            production_dump.dump 2>&1 | grep -E "(processing|restoring|error)" | head -50 || {
              echo "âš ï¸ pg_restore completed with warnings (expected for branch databases)"
            }

          echo "âœ… Data restore completed"

      - name: Restore Constraints and Triggers
        run: |
          echo "ğŸ”§ Restoring constraints and triggers..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"

          psql "$DEV_URL" <<'EOF' || true
          -- Re-enable triggers
          SET session_replication_role = DEFAULT;

          -- Restore FK constraints
          ALTER TABLE IF EXISTS meeting_action_items
            ADD CONSTRAINT IF NOT EXISTS meeting_action_items_task_id_fkey
            FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE SET NULL;

          ALTER TABLE IF EXISTS next_action_suggestions
            ADD CONSTRAINT IF NOT EXISTS next_action_suggestions_created_task_id_fkey
            FOREIGN KEY (created_task_id) REFERENCES tasks(id) ON DELETE SET NULL;
          EOF

          echo "âœ… Constraints restored"

      - name: Verify Data Sync
        id: verify
        run: |
          echo "ğŸ” Verifying data sync..."

          DEV_URL="${{ steps.build-urls.outputs.dev_url }}"
          PROD_URL="${{ steps.build-urls.outputs.prod_url }}"

          echo "ğŸ“Š Comparing table counts:"
          echo ""
          echo "| Table | Production | Development |"
          echo "|-------|------------|-------------|"

          for table in profiles deals contacts meetings activities tasks; do
            PROD_COUNT=$(psql "$PROD_URL" -t -c "SELECT COUNT(*) FROM $table;" 2>/dev/null | tr -d ' ' || echo "N/A")
            DEV_COUNT=$(psql "$DEV_URL" -t -c "SELECT COUNT(*) FROM $table;" 2>/dev/null | tr -d ' ' || echo "N/A")
            echo "| $table | $PROD_COUNT | $DEV_COUNT |"
          done

          echo ""
          echo "âœ… Data sync verification complete"

      - name: Sync Summary
        if: always()
        run: |
          echo "## ğŸ”„ Production â†’ Development Data Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | Production Database |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Development Branch (\`$DEV_BRANCH_ID\`) |" >> $GITHUB_STEP_SUMMARY
          echo "| Dump Size | ${{ steps.export.outputs.dump_size || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status == 'success' && 'âœ… Completed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sync Time | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Scheduled Sync" >> $GITHUB_STEP_SUMMARY
          echo "Sunday at 2:00 AM UTC" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f production_dump.dump
          echo "ğŸ§¹ Cleanup complete"
