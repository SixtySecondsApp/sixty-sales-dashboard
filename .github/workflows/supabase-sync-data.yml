name: Sync Production Data to Development

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC (configurable)
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh even if no recent changes'
        required: false
        default: 'false'
        type: boolean

env:
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  sync-production-to-development:
    name: Sync Production â†’ Development Branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Authenticate with Supabase
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Authenticate using the access token
          supabase login --token $SUPABASE_ACCESS_TOKEN

      - name: Get Development Branch ID
        id: get-dev-branch
        run: |
          echo "ğŸ” Finding development branch..."
          
          # List all branches and find the development branch
          BRANCHES=$(supabase branches list --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json || echo "[]")
          
          DEV_BRANCH=$(echo "$BRANCHES" | jq -r '.[] | select(.name == "development") | .id' || echo "")
          
          if [ -z "$DEV_BRANCH" ]; then
            echo "âŒ Development branch not found. Creating it..."
            
            # Create development branch if it doesn't exist
            DEV_BRANCH=$(supabase branches create development --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json | jq -r '.id' || echo "")
            
            if [ -z "$DEV_BRANCH" ]; then
              echo "âŒ Failed to create development branch"
              exit 1
            fi
            
            echo "âœ… Created development branch: $DEV_BRANCH"
          else
            echo "âœ… Found development branch: $DEV_BRANCH"
          fi
          
          echo "branch_id=$DEV_BRANCH" >> $GITHUB_OUTPUT

      - name: Get Development Branch Connection String
        id: get-dev-connection
        run: |
          echo "ğŸ” Getting development branch connection details..."
          
          BRANCH_INFO=$(supabase branches get ${{ steps.get-dev-branch.outputs.branch_id }} --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json || echo "{}")
          
          DB_URL=$(echo "$BRANCH_INFO" | jq -r '.database_url // empty' || echo "")
          
          if [ -z "$DB_URL" ]; then
            # Construct connection string from branch info
            BRANCH_REF=$(echo "$BRANCH_INFO" | jq -r '.db_url // empty' || echo "")
            if [ -n "$BRANCH_REF" ]; then
              DB_URL="$BRANCH_REF"
            else
              echo "âš ï¸ Could not determine database URL, using connection pooler"
              # Use connection pooler format
              DB_URL="postgresql://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-${{ steps.get-dev-branch.outputs.branch_id }}.pooler.supabase.com:6543/postgres"
            fi
          fi
          
          echo "db_url=$DB_URL" >> $GITHUB_OUTPUT
          echo "âœ… Development branch connection configured"

      - name: Export Production Data
        run: |
          echo "ğŸ“¦ Exporting production data using Supabase CLI..."

          # Use Supabase CLI to dump the database (handles auth and networking)
          supabase db dump \
            --db-url "${{ secrets.PRODUCTION_DB_URL }}" \
            --file production_dump.sql \
            --data-only

          echo "âœ… Production data exported"

          # Get dump size
          DUMP_SIZE=$(du -h production_dump.sql | cut -f1)
          echo "âœ… Production data size: $DUMP_SIZE"
          echo "dump_size=$DUMP_SIZE" >> $GITHUB_OUTPUT

      - name: Restore Data to Development Branch
        run: |
          echo "ğŸ”„ Restoring data to development branch using Supabase CLI..."

          # Use Supabase CLI to push the data to development branch
          supabase db push \
            --db-url "${{ steps.get-dev-connection.outputs.db_url }}" \
            --file production_dump.sql

          echo "âœ… Data restored to development branch"

      - name: Verify Data Sync
        run: |
          echo "ğŸ” Verifying data sync..."

          # Check table counts using development branch connection
          psql --dbname="${{ steps.get-dev-connection.outputs.db_url }}" <<EOF
          SELECT 
            schemaname,
            tablename,
            pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
          FROM pg_tables 
          WHERE schemaname = 'public'
          ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
          LIMIT 10;
          EOF
          
          echo "âœ… Data sync verification complete"

      - name: Sync Summary
        if: always()
        run: |
          echo "## ğŸ”„ Production â†’ Development Data Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: Production Database" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: Development Branch (\`${{ steps.get-dev-branch.outputs.branch_id }}\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **Dump Size**: ${{ steps.get-dev-connection.outputs.dump_size || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status == 'success' && 'âœ… Completed' || 'âŒ Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f production_dump.dump
          echo "ğŸ§¹ Cleanup complete"

