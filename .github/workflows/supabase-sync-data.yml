name: Sync Production Data to Development

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC (configurable)
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh even if no recent changes'
        required: false
        default: 'false'
        type: boolean

env:
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
  SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}

jobs:
  sync-production-to-development:
    name: Sync Production ‚Üí Development Branch
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client-15

      - name: Authenticate with Supabase
        run: |
          echo "${{ secrets.SUPABASE_ACCESS_TOKEN }}" | supabase login --token -

      - name: Get Development Branch ID
        id: get-dev-branch
        run: |
          echo "üîç Finding development branch..."
          
          # List all branches and find the development branch
          BRANCHES=$(supabase branches list --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json || echo "[]")
          
          DEV_BRANCH=$(echo "$BRANCHES" | jq -r '.[] | select(.name == "development") | .id' || echo "")
          
          if [ -z "$DEV_BRANCH" ]; then
            echo "‚ùå Development branch not found. Creating it..."
            
            # Create development branch if it doesn't exist
            DEV_BRANCH=$(supabase branches create development --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json | jq -r '.id' || echo "")
            
            if [ -z "$DEV_BRANCH" ]; then
              echo "‚ùå Failed to create development branch"
              exit 1
            fi
            
            echo "‚úÖ Created development branch: $DEV_BRANCH"
          else
            echo "‚úÖ Found development branch: $DEV_BRANCH"
          fi
          
          echo "branch_id=$DEV_BRANCH" >> $GITHUB_OUTPUT

      - name: Get Development Branch Connection String
        id: get-dev-connection
        run: |
          echo "üîç Getting development branch connection details..."
          
          BRANCH_INFO=$(supabase branches get ${{ steps.get-dev-branch.outputs.branch_id }} --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --output json || echo "{}")
          
          DB_URL=$(echo "$BRANCH_INFO" | jq -r '.database_url // empty' || echo "")
          
          if [ -z "$DB_URL" ]; then
            # Construct connection string from branch info
            BRANCH_REF=$(echo "$BRANCH_INFO" | jq -r '.db_url // empty' || echo "")
            if [ -n "$BRANCH_REF" ]; then
              DB_URL="$BRANCH_REF"
            else
              echo "‚ö†Ô∏è Could not determine database URL, using connection pooler"
              # Use connection pooler format
              DB_URL="postgresql://postgres.${{ secrets.SUPABASE_PROJECT_ID }}:${{ secrets.SUPABASE_DB_PASSWORD }}@aws-0-${{ steps.get-dev-branch.outputs.branch_id }}.pooler.supabase.com:6543/postgres"
            fi
          fi
          
          echo "db_url=$DB_URL" >> $GITHUB_OUTPUT
          echo "‚úÖ Development branch connection configured"

      - name: Export Production Data
        run: |
          echo "üì¶ Exporting production data..."
          
          # Use pg_dump to export production data
          # Exclude system tables and use custom format for better compression
          pg_dump "${{ secrets.PRODUCTION_DB_URL }}" \
            --format=custom \
            --no-owner \
            --no-acl \
            --exclude-table=supabase_migrations.schema_migrations \
            --exclude-table=supabase_migrations.migration_history \
            --file=production_dump.dump \
            --verbose
          
          # Get dump size
          DUMP_SIZE=$(du -h production_dump.dump | cut -f1)
          echo "‚úÖ Production data exported: $DUMP_SIZE"
          echo "dump_size=$DUMP_SIZE" >> $GITHUB_OUTPUT

      - name: Restore Data to Development Branch
        run: |
          echo "üîÑ Restoring data to development branch..."
          
          # Drop all existing data (except migrations)
          echo "‚ö†Ô∏è Dropping existing data in development branch..."
          PGPASSWORD="${{ secrets.SUPABASE_DB_PASSWORD }}" psql "${{ steps.get-dev-connection.outputs.db_url }}" <<EOF
          -- Disable triggers temporarily
          SET session_replication_role = replica;
          
          -- Drop all tables (migrations will recreate schema)
          DO \$\$ 
          DECLARE
            r RECORD;
          BEGIN
            FOR r IN (SELECT tablename FROM pg_tables WHERE schemaname = 'public') LOOP
              EXECUTE 'DROP TABLE IF EXISTS ' || quote_ident(r.tablename) || ' CASCADE';
            END LOOP;
          END \$\$;
          
          -- Re-enable triggers
          SET session_replication_role = DEFAULT;
          EOF
          
          echo "‚úÖ Cleared existing data"
          
          # Restore production data
          echo "üì• Restoring production data..."
          PGPASSWORD="${{ secrets.SUPABASE_DB_PASSWORD }}" pg_restore \
            --dbname="${{ steps.get-dev-connection.outputs.db_url }}" \
            --no-owner \
            --no-acl \
            --verbose \
            production_dump.dump || {
              echo "‚ùå Restore failed, trying alternative method..."
              # Alternative: Use plain SQL format
              pg_dump "${{ secrets.PRODUCTION_DB_URL }}" \
                --format=plain \
                --no-owner \
                --no-acl \
                --exclude-table=supabase_migrations.schema_migrations \
                --exclude-table=supabase_migrations.migration_history \
                | PGPASSWORD="${{ secrets.SUPABASE_DB_PASSWORD }}" psql "${{ steps.get-dev-connection.outputs.db_url }}"
            }
          
          echo "‚úÖ Data restored to development branch"

      - name: Verify Data Sync
        run: |
          echo "üîç Verifying data sync..."
          
          # Check table counts
          PGPASSWORD="${{ secrets.SUPABASE_DB_PASSWORD }}" psql "${{ steps.get-dev-connection.outputs.db_url }}" <<EOF
          SELECT 
            schemaname,
            tablename,
            pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
          FROM pg_tables 
          WHERE schemaname = 'public'
          ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC
          LIMIT 10;
          EOF
          
          echo "‚úÖ Data sync verification complete"

      - name: Sync Summary
        if: always()
        run: |
          echo "## üîÑ Production ‚Üí Development Data Sync" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: Production Database" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: Development Branch (\`${{ steps.get-dev-branch.outputs.branch_id }}\`)" >> $GITHUB_STEP_SUMMARY
          echo "- **Dump Size**: ${{ steps.get-dev-connection.outputs.dump_size || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status == 'success' && '‚úÖ Completed' || '‚ùå Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Sync Time**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f production_dump.dump
          echo "üßπ Cleanup complete"

