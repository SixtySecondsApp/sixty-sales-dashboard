name: Supabase PR Migration Validation

on:
  pull_request:
    branches: [main]
    paths:
      - 'supabase/migrations/**'
      - '.github/workflows/supabase-pr.yml'

jobs:
  validate-migrations:
    name: Validate Database Migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Validate migration files
        run: |
          echo "üîç Validating migration files..."
          
          # Check for migration files in PR
          MIGRATION_FILES=$(git diff --name-only origin/main...HEAD | grep '^supabase/migrations/.*\.sql$' || true)
          
          if [ -z "$MIGRATION_FILES" ]; then
            echo "‚ÑπÔ∏è No migration files changed in this PR"
            exit 0
          fi
          
          echo "üìù Found migration files:"
          echo "$MIGRATION_FILES"
          
          # Validate SQL syntax for each migration
          for file in $MIGRATION_FILES; do
            echo "üîé Validating $file..."
            if ! psql --version > /dev/null 2>&1; then
              echo "‚ö†Ô∏è PostgreSQL client not available, skipping syntax check"
            else
              # Basic SQL syntax validation (doesn't execute, just parses)
              if ! psql -v ON_ERROR_STOP=1 -f "$file" --dry-run 2>&1 | grep -i "error" > /dev/null; then
                echo "‚úÖ $file syntax appears valid"
              else
                echo "‚ùå $file has syntax errors"
                psql -v ON_ERROR_STOP=1 -f "$file" --dry-run 2>&1 | grep -i "error" || true
              fi
            fi
            
            # Check for common issues
            if grep -q "DROP TABLE.*CASCADE" "$file"; then
              echo "‚ö†Ô∏è Warning: $file contains DROP TABLE CASCADE - ensure this is intentional"
            fi
            
            if grep -q "DELETE FROM" "$file"; then
              echo "‚ö†Ô∏è Warning: $file contains DELETE statements - ensure this is intentional"
            fi
          done
          
          echo "‚úÖ Migration validation complete"

      - name: Check migration naming convention
        run: |
          echo "üìã Checking migration naming convention..."
          
          MIGRATION_FILES=$(git diff --name-only origin/main...HEAD | grep '^supabase/migrations/.*\.sql$' || true)
          
          if [ -z "$MIGRATION_FILES" ]; then
            exit 0
          fi
          
          for file in $MIGRATION_FILES; do
            filename=$(basename "$file")
            # Check if filename matches pattern: YYYYMMDDHHMMSS_description.sql
            if ! echo "$filename" | grep -qE '^[0-9]{14}_[a-z0-9_]+\.sql$'; then
              echo "‚ùå Migration file $filename does not match naming convention: YYYYMMDDHHMMSS_description.sql"
              echo "   Example: 20250115120000_add_new_table.sql"
              exit 1
            fi
            echo "‚úÖ $filename follows naming convention"
          done

      - name: Comment PR with migration summary
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            try {
              const migrationFiles = execSync(
                'git diff --name-only origin/main...HEAD | grep "^supabase/migrations/.*\\.sql$" || true',
                { encoding: 'utf-8' }
              ).trim();
              
              if (!migrationFiles) {
                console.log('No migration files in this PR');
                return;
              }
              
              const files = migrationFiles.split('\n').filter(Boolean);
              const fileList = files.map(f => `- \`${f}\``).join('\n');
              
              const comment = `## üìä Database Migration Summary
              
              This PR includes **${files.length}** migration file(s):
              
              ${fileList}
              
              ‚ö†Ô∏è **Note**: These migrations will be applied to Production when this PR is merged to \`main\`.
              
              ‚úÖ Migration validation passed.`;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.log('Could not create PR comment:', error.message);
            }

