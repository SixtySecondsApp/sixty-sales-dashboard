<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Fathom Task Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">üéØ Test Fathom Task Sync</h1>
        <p class="text-gray-400 mb-6">This test demonstrates how sales rep tasks sync to the task list while prospect tasks stay on the meeting page only.</p>
        
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Enter Your Workflow ID</h2>
            <input id="workflowId" type="text" placeholder="e.g., 123e4567-e89b-12d3-a456-426614174000" 
                   class="w-full px-4 py-2 bg-gray-700 rounded-md text-white mb-4">
            <button onclick="runTest()" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-md font-semibold">
                üöÄ Test Task Sync
            </button>
        </div>

        <div id="results" class="space-y-4"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ewtuefzeogytgmsnkpmb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3dHVlZnplb2d5dGdtc25rcG1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4OTQ5MjcsImV4cCI6MjA1MzQ3MDkyN30.O22Zx_xB_UuasB19V66g69fl6GdAdW38vuYQPbGUUf8';

        // Test payload with mixed sales rep and prospect tasks
        const testPayload = {
            action_item: [
                {
                    // Sales rep task - should create task in task list
                    item: "Send proposal to John by Friday",
                    owner: "Jane Smith", // Internal sales rep
                    due_date: "2024-01-19",
                    description: "Send the enterprise proposal with pricing"
                },
                {
                    // Prospect task - should NOT create task in task list
                    item: "Review contract and provide feedback",
                    owner: "John Doe", // External prospect
                    due_date: "2024-01-22",
                    description: "Client needs to review terms and conditions"
                },
                {
                    // Sales rep task - should create task in task list
                    item: "Schedule follow-up call next week",
                    owner: "Andrew Bryce", // You - internal sales rep
                    due_date: "2024-01-23",
                    description: "Follow up on proposal discussion"
                },
                {
                    // Prospect task - should NOT create task in task list
                    item: "Get approval from finance team",
                    owner: "john@acme.com", // External email
                    due_date: "2024-01-25",
                    description: "Customer needs internal approval"
                },
                {
                    // Sales rep task (detected by keywords) - should create task
                    item: "We need to prepare demo environment",
                    owner: "", // No specific owner, but "we need to" indicates internal
                    due_date: "2024-01-20",
                    description: "Set up demo for next meeting"
                }
            ],
            meetingUrl: "https://fathom.video/share/test-sync-123",
            shareId: "test-sync-123"
        };

        async function runTest() {
            const workflowId = document.getElementById('workflowId').value.trim();
            
            if (!workflowId) {
                alert('Please enter your workflow ID first!');
                return;
            }
            
            const webhookUrl = `${SUPABASE_URL}/functions/v1/workflow-webhook/${workflowId}`;
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            // Show info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'bg-blue-900/30 rounded-lg p-4 mb-4';
            infoDiv.innerHTML = `
                <p class="text-sm font-semibold mb-2">üìã Test Scenario:</p>
                <ul class="text-xs space-y-1 ml-4">
                    <li>‚Ä¢ 3 Sales Rep Tasks (Jane Smith, Andrew Bryce, "we need to") ‚Üí Should create tasks</li>
                    <li>‚Ä¢ 2 Prospect Tasks (John Doe, john@acme.com) ‚Üí Should NOT create tasks</li>
                </ul>
            `;
            document.getElementById('results').appendChild(infoDiv);
            
            try {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'bg-gray-800 rounded-lg p-6';
                resultDiv.innerHTML = `<h3 class="text-lg font-semibold mb-2">Testing Action Items with Task Sync...</h3>`;
                document.getElementById('results').appendChild(resultDiv);
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'apikey': SUPABASE_KEY
                    },
                    body: JSON.stringify(testPayload)
                });
                
                const responseData = await response.json();
                
                if (response.ok && responseData.result?.action_items) {
                    const items = responseData.result.action_items;
                    let salesRepTasks = 0;
                    let prospectTasks = 0;
                    
                    const itemsHtml = items.map((item, index) => {
                        if (item.is_sales_rep_task) {
                            salesRepTasks++;
                            return `
                                <div class="bg-green-900/30 p-3 rounded mb-2">
                                    <p class="text-sm">‚úÖ Item ${index + 1}: <span class="font-semibold">Sales Rep Task</span></p>
                                    <p class="text-xs text-gray-400">Action Item ID: ${item.action_item_id}</p>
                                    <p class="text-xs text-gray-400">Task ID: ${item.task_id || 'Creating...'}</p>
                                    <p class="text-xs text-green-400">‚Üí Created in tasks table for sync</p>
                                </div>
                            `;
                        } else {
                            prospectTasks++;
                            return `
                                <div class="bg-blue-900/30 p-3 rounded mb-2">
                                    <p class="text-sm">üìã Item ${index + 1}: <span class="font-semibold">Prospect Task</span></p>
                                    <p class="text-xs text-gray-400">Action Item ID: ${item.action_item_id}</p>
                                    <p class="text-xs text-blue-400">‚Üí Stored in meeting only (no task created)</p>
                                </div>
                            `;
                        }
                    }).join('');
                    
                    resultDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-4">‚úÖ Task Sync Test - SUCCESS</h3>
                        <div class="mb-4">
                            <p class="text-sm text-gray-300 mb-2">Results Summary:</p>
                            <p class="text-sm">‚Ä¢ Sales Rep Tasks Created: <span class="text-green-400 font-bold">${salesRepTasks}</span></p>
                            <p class="text-sm">‚Ä¢ Prospect Tasks (Meeting Only): <span class="text-blue-400 font-bold">${prospectTasks}</span></p>
                        </div>
                        ${itemsHtml}
                        <div class="mt-4 p-3 bg-gray-700 rounded">
                            <p class="text-xs text-gray-400">Meeting ID: ${responseData.result.meeting_id}</p>
                            <details class="mt-2">
                                <summary class="cursor-pointer text-blue-400 text-sm">View Full Response</summary>
                                <pre class="mt-2 text-xs overflow-x-auto">${JSON.stringify(responseData, null, 2)}</pre>
                            </details>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <h3 class="text-lg font-semibold mb-2">‚ùå Test Failed</h3>
                        <div class="bg-red-900/30 p-3 rounded">
                            <pre class="text-xs overflow-x-auto">${JSON.stringify(responseData, null, 2)}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'bg-red-900/30 rounded-lg p-4';
                errorDiv.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2">‚ùå Error</h3>
                    <p class="text-sm">${error.message}</p>
                `;
                document.getElementById('results').appendChild(errorDiv);
            }
            
            // Add next steps
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'bg-gray-800 rounded-lg p-6 mt-6';
            summaryDiv.innerHTML = `
                <h3 class="text-xl font-semibold mb-3">üìä What Happened:</h3>
                <ol class="list-decimal list-inside space-y-2 text-sm text-gray-300">
                    <li><strong>Sales Rep Tasks</strong> were created in both:
                        <ul class="ml-6 mt-1 list-disc">
                            <li>meeting_action_items table (for meeting page display)</li>
                            <li>tasks table (for task list sync)</li>
                        </ul>
                    </li>
                    <li><strong>Prospect Tasks</strong> were only created in:
                        <ul class="ml-6 mt-1 list-disc">
                            <li>meeting_action_items table (meeting page only)</li>
                        </ul>
                    </li>
                    <li><strong>Bi-directional Sync</strong> is enabled:
                        <ul class="ml-6 mt-1 list-disc">
                            <li>Marking task done ‚Üí updates action item</li>
                            <li>Marking action item done ‚Üí updates task</li>
                        </ul>
                    </li>
                </ol>
                <p class="text-gray-400 mt-4 text-sm">Note: Run the SQL migration first if you see any errors about missing columns.</p>
            `;
            document.getElementById('results').appendChild(summaryDiv);
        }
        
        // Allow Enter key to trigger test
        document.getElementById('workflowId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') runTest();
        });
    </script>
</body>
</html>