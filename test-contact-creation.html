<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Contact Creation Test with Website & Company</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    .container {
      background: #16213e;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      border: 1px solid #0f3460;
    }
    h1, h2 {
      color: #e94560;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      background: #0f3460;
      border: 1px solid #533483;
      color: #eee;
      border-radius: 4px;
    }
    button {
      background: #e94560;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #c23650;
    }
    .success {
      color: #4ade80;
      padding: 10px;
      background: rgba(74, 222, 128, 0.1);
      border-radius: 4px;
      margin: 10px 0;
    }
    .error {
      color: #f87171;
      padding: 10px;
      background: rgba(248, 113, 113, 0.1);
      border-radius: 4px;
      margin: 10px 0;
    }
    .info {
      color: #60a5fa;
      padding: 10px;
      background: rgba(96, 165, 250, 0.1);
      border-radius: 4px;
      margin: 10px 0;
    }
    .results {
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      background: #0f3460;
      padding: 10px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
    }
    .test-case {
      padding: 15px;
      margin: 10px 0;
      background: rgba(83, 52, 131, 0.2);
      border-radius: 4px;
      border: 1px solid #533483;
    }
    .test-title {
      font-weight: bold;
      color: #a78bfa;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <h1>ðŸ§ª Contact Creation Test Suite</h1>
  <p>Testing website extraction from email and automatic company creation</p>

  <div class="container">
    <h2>Test Configuration</h2>
    <input type="text" id="supabaseUrl" placeholder="Supabase URL" value="">
    <input type="password" id="supabaseKey" placeholder="Supabase Anon Key" value="">
    <input type="email" id="userEmail" placeholder="Your email" value="">
    <input type="password" id="userPassword" placeholder="Your password" value="">
    <button onclick="initialize()">Initialize & Sign In</button>
    <div id="authStatus"></div>
  </div>

  <div class="container" id="testContainer" style="display: none;">
    <h2>Contact Creation Tests</h2>
    
    <div class="test-case">
      <div class="test-title">Test 1: Create Contact with Work Email (Auto-extract Website)</div>
      <input type="text" id="firstName1" placeholder="First Name" value="John">
      <input type="text" id="lastName1" placeholder="Last Name" value="Smith">
      <input type="email" id="email1" placeholder="Work Email" value="john.smith@techcompany.com">
      <input type="text" id="title1" placeholder="Job Title" value="CTO">
      <button onclick="testContactWithEmail()">Run Test 1</button>
      <div id="result1"></div>
    </div>

    <div class="test-case">
      <div class="test-title">Test 2: Create Contact with Manual Website</div>
      <input type="text" id="firstName2" placeholder="First Name" value="Sarah">
      <input type="text" id="lastName2" placeholder="Last Name" value="Johnson">
      <input type="email" id="email2" placeholder="Email" value="sarah@gmail.com">
      <input type="text" id="website2" placeholder="Website" value="https://sarahcompany.com">
      <input type="text" id="companyName2" placeholder="Company Name" value="Sarah's Startup">
      <button onclick="testContactWithManualWebsite()">Run Test 2</button>
      <div id="result2"></div>
    </div>

    <div class="test-case">
      <div class="test-title">Test 3: Verify Contact & Company Creation</div>
      <input type="email" id="searchEmail" placeholder="Search by Email" value="">
      <button onclick="searchContact()">Search Contact</button>
      <button onclick="listCompanies()">List All Companies</button>
      <div id="result3"></div>
    </div>

    <div class="test-case">
      <div class="test-title">Test 4: Cleanup Test Data</div>
      <button onclick="cleanupTestData()">Delete Test Contacts & Companies</button>
      <div id="result4"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    let supabase = null;
    let currentUser = null;

    window.initialize = async function() {
      const url = document.getElementById('supabaseUrl').value;
      const key = document.getElementById('supabaseKey').value;
      const email = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;

      if (!url || !key || !email || !password) {
        showResult('authStatus', 'Please fill in all fields', 'error');
        return;
      }

      supabase = createClient(url, key);
      
      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        
        currentUser = data.user;
        showResult('authStatus', `âœ… Signed in as ${currentUser.email}`, 'success');
        document.getElementById('testContainer').style.display = 'block';
      } catch (error) {
        showResult('authStatus', `Error: ${error.message}`, 'error');
      }
    };

    window.testContactWithEmail = async function() {
      if (!supabase || !currentUser) {
        showResult('result1', 'Please initialize first', 'error');
        return;
      }

      const firstName = document.getElementById('firstName1').value;
      const lastName = document.getElementById('lastName1').value;
      const email = document.getElementById('email1').value;
      const title = document.getElementById('title1').value;

      try {
        showResult('result1', 'Creating contact...', 'info');

        // Extract website from email
        const emailDomain = email.split('@')[1];
        let websiteUrl = null;
        let suggestedCompanyName = null;

        if (emailDomain && !['gmail.com', 'outlook.com', 'hotmail.com', 'yahoo.com', 'icloud.com'].includes(emailDomain.toLowerCase())) {
          websiteUrl = `https://${emailDomain}`;
          const domainParts = emailDomain.split('.');
          suggestedCompanyName = domainParts[0].charAt(0).toUpperCase() + domainParts[0].slice(1);
        }

        // First, check if company exists or create it
        let companyId = null;
        if (websiteUrl) {
          // Check for existing company
          const { data: existingCompanies } = await supabase
            .from('companies')
            .select('*')
            .or(`domain.ilike.%${emailDomain}%,website.ilike.%${emailDomain}%`)
            .limit(1);

          if (existingCompanies && existingCompanies.length > 0) {
            companyId = existingCompanies[0].id;
            showResult('result1', `Found existing company: ${existingCompanies[0].name}`, 'info');
          } else {
            // Create new company
            const { data: newCompany, error: companyError } = await supabase
              .from('companies')
              .insert({
                name: suggestedCompanyName,
                domain: emailDomain,
                website: websiteUrl,
                owner_id: currentUser.id
              })
              .select()
              .single();

            if (companyError) throw companyError;
            companyId = newCompany.id;
            showResult('result1', `Created new company: ${newCompany.name} with website: ${websiteUrl}`, 'success');
          }
        }

        // Create contact
        const contactData = {
          first_name: firstName,
          last_name: lastName,
          email: email,
          title: title,
          company_id: companyId,
          company_name: suggestedCompanyName,
          owner_id: currentUser.id
        };

        const { data: contact, error } = await supabase
          .from('contacts')
          .insert(contactData)
          .select()
          .single();

        if (error) throw error;

        const result = `
âœ… Contact created successfully!
ID: ${contact.id}
Name: ${contact.first_name} ${contact.last_name}
Email: ${contact.email}
Title: ${contact.title}
Company ID: ${contact.company_id || 'None'}
Company Name: ${contact.company_name || 'None'}
Website (extracted): ${websiteUrl || 'None'}
`;
        showResult('result1', result, 'success');
      } catch (error) {
        showResult('result1', `Error: ${error.message}`, 'error');
      }
    };

    window.testContactWithManualWebsite = async function() {
      if (!supabase || !currentUser) {
        showResult('result2', 'Please initialize first', 'error');
        return;
      }

      const firstName = document.getElementById('firstName2').value;
      const lastName = document.getElementById('lastName2').value;
      const email = document.getElementById('email2').value;
      const website = document.getElementById('website2').value;
      const companyName = document.getElementById('companyName2').value;

      try {
        showResult('result2', 'Creating contact with manual website...', 'info');

        // Extract domain from website
        const domain = website.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0];

        // Create or find company
        let companyId = null;
        if (website && companyName) {
          const { data: newCompany, error: companyError } = await supabase
            .from('companies')
            .insert({
              name: companyName,
              domain: domain,
              website: website,
              owner_id: currentUser.id
            })
            .select()
            .single();

          if (!companyError) {
            companyId = newCompany.id;
            showResult('result2', `Created company: ${companyName} with website: ${website}`, 'success');
          }
        }

        // Create contact
        const { data: contact, error } = await supabase
          .from('contacts')
          .insert({
            first_name: firstName,
            last_name: lastName,
            email: email,
            company_id: companyId,
            company_name: companyName,
            owner_id: currentUser.id
          })
          .select()
          .single();

        if (error) throw error;

        const result = `
âœ… Contact created with manual website!
ID: ${contact.id}
Name: ${contact.first_name} ${contact.last_name}
Email: ${contact.email}
Company ID: ${contact.company_id || 'None'}
Company Name: ${contact.company_name || 'None'}
Manual Website: ${website}
`;
        showResult('result2', result, 'success');
      } catch (error) {
        showResult('result2', `Error: ${error.message}`, 'error');
      }
    };

    window.searchContact = async function() {
      if (!supabase || !currentUser) {
        showResult('result3', 'Please initialize first', 'error');
        return;
      }

      const email = document.getElementById('searchEmail').value;
      if (!email) {
        showResult('result3', 'Please enter an email to search', 'error');
        return;
      }

      try {
        const { data: contacts, error } = await supabase
          .from('contacts')
          .select('*, companies:company_id(*)')
          .eq('email', email);

        if (error) throw error;

        if (contacts && contacts.length > 0) {
          const contact = contacts[0];
          const result = `
Found Contact:
ID: ${contact.id}
Name: ${contact.first_name} ${contact.last_name}
Email: ${contact.email}
Title: ${contact.title || 'N/A'}
Company Name (field): ${contact.company_name || 'N/A'}
Company ID: ${contact.company_id || 'N/A'}

Linked Company Details:
${contact.companies ? `
  Name: ${contact.companies.name}
  Domain: ${contact.companies.domain || 'N/A'}
  Website: ${contact.companies.website || 'N/A'}
` : 'No linked company'}
`;
          showResult('result3', result, 'success');
        } else {
          showResult('result3', 'No contact found with that email', 'info');
        }
      } catch (error) {
        showResult('result3', `Error: ${error.message}`, 'error');
      }
    };

    window.listCompanies = async function() {
      if (!supabase || !currentUser) {
        showResult('result3', 'Please initialize first', 'error');
        return;
      }

      try {
        const { data: companies, error } = await supabase
          .from('companies')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) throw error;

        if (companies && companies.length > 0) {
          const result = companies.map(c => `
Company: ${c.name}
  Domain: ${c.domain || 'N/A'}
  Website: ${c.website || 'N/A'}
  Created: ${new Date(c.created_at).toLocaleString()}
`).join('\n---\n');
          showResult('result3', `Found ${companies.length} companies:\n\n${result}`, 'success');
        } else {
          showResult('result3', 'No companies found', 'info');
        }
      } catch (error) {
        showResult('result3', `Error: ${error.message}`, 'error');
      }
    };

    window.cleanupTestData = async function() {
      if (!supabase || !currentUser) {
        showResult('result4', 'Please initialize first', 'error');
        return;
      }

      try {
        showResult('result4', 'Cleaning up test data...', 'info');

        // Delete test contacts
        const testEmails = [
          'john.smith@techcompany.com',
          'sarah@gmail.com'
        ];

        for (const email of testEmails) {
          const { error } = await supabase
            .from('contacts')
            .delete()
            .eq('email', email)
            .eq('owner_id', currentUser.id);

          if (!error) {
            showResult('result4', `Deleted contact: ${email}`, 'info');
          }
        }

        // Delete test companies
        const testCompanyNames = [
          'Techcompany',
          'Sarah\'s Startup'
        ];

        for (const name of testCompanyNames) {
          const { error } = await supabase
            .from('companies')
            .delete()
            .ilike('name', `%${name}%`)
            .eq('owner_id', currentUser.id);

          if (!error) {
            showResult('result4', `Deleted company: ${name}`, 'info');
          }
        }

        showResult('result4', 'âœ… Test data cleaned up successfully', 'success');
      } catch (error) {
        showResult('result4', `Error: ${error.message}`, 'error');
      }
    };

    function showResult(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      element.className = type;
      element.textContent = message;
    }

    window.showResult = showResult;
  </script>
</body>
</html>