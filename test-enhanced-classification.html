<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Enhanced Fathom Classification</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 p-8">
    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">üéØ Enhanced Fathom AI Classification Test</h1>
        <p class="text-gray-400 mb-6">Test the GPT-4o-inspired classification logic with intelligent priority, category, and deadline detection.</p>
        
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Configuration</h2>
            <input id="workflowId" type="text" placeholder="Enter your workflow ID" 
                   class="w-full px-4 py-2 bg-gray-700 rounded-md text-white mb-4">
            <button onclick="runEnhancedTest()" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-md font-semibold">
                üöÄ Run Enhanced Classification Test
            </button>
        </div>

        <div id="results" class="space-y-4"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ewtuefzeogytgmsnkpmb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV3dHVlZnplb2d5dGdtc25rcG1iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4OTQ5MjcsImV4cCI6MjA1MzQ3MDkyN30.O22Zx_xB_UuasB19V66g69fl6GdAdW38vuYQPbGUUf8';

        // Test scenarios matching GPT-4o prompt logic
        const testScenarios = [
            {
                name: "Urgent Proposal - Friday Meeting",
                action_item: [{
                    item: "Send URGENT proposal to IQPC team by Monday",
                    owner: "Andrew Bryce",
                    // Simulating Friday meeting
                }],
                meeting_end: new Date('2024-01-19T15:00:00'), // Friday
                expected: {
                    priority: "urgent",
                    category: "Proposal",
                    deadline_days: 3 // Monday = 3 days from Friday
                }
            },
            {
                name: "High Priority Email Follow-up",
                action_item: [{
                    item: "Email the case study results - this is important for the deal",
                    owner: "Steve Gibson"
                }],
                meeting_end: new Date('2024-01-15T10:00:00'), // Monday
                expected: {
                    priority: "high",
                    category: "Email",
                    deadline_days: 2
                }
            },
            {
                name: "LinkedIn Connection Request",
                action_item: [{
                    item: "Connect with John on LinkedIn and send a message about our discussion",
                    owner: "Andrew Bryce"
                }],
                expected: {
                    priority: "medium",
                    category: "LinkedIn Message",
                    deadline_days: 3
                }
            },
            {
                name: "Low Priority Information Sharing",
                action_item: [{
                    item: "Share the product documentation whenever you get a chance, no rush",
                    owner: "Jane Smith"
                }],
                expected: {
                    priority: "low",
                    category: "Send Information",
                    deadline_days: 7
                }
            },
            {
                name: "Call by Specific Day",
                action_item: [{
                    item: "Call the client by Wednesday to discuss next steps",
                    owner: "Andrew Bryce"
                }],
                meeting_end: new Date('2024-01-15T10:00:00'), // Monday
                expected: {
                    priority: "medium",
                    category: "Call",
                    deadline_days: 2 // Wednesday from Monday
                }
            },
            {
                name: "WhatsApp Follow-up",
                action_item: [{
                    item: "Send a WhatsApp message with the meeting notes ASAP",
                    owner: "Steve Gibson"
                }],
                expected: {
                    priority: "urgent",
                    category: "Whatsapp / Text",
                    deadline_days: 1
                }
            },
            {
                name: "Client Task (Not Sales Rep)",
                action_item: [{
                    item: "Please review the contract and provide feedback",
                    owner: "john@acme.com"
                }],
                expected: {
                    priority: "medium",
                    category: "Send Information",
                    is_prospect_task: true
                }
            },
            {
                name: "This Week Deadline",
                action_item: [{
                    item: "Prepare and send the demo environment details this week",
                    owner: "Andrew Bryce"
                }],
                meeting_end: new Date('2024-01-15T10:00:00'), // Monday
                expected: {
                    priority: "medium",
                    category: "Send Information",
                    deadline_days: 4 // Friday from Monday
                }
            }
        ];

        async function runEnhancedTest() {
            const workflowId = document.getElementById('workflowId').value.trim();
            
            if (!workflowId) {
                alert('Please enter your workflow ID first!');
                return;
            }
            
            const webhookUrl = `${SUPABASE_URL}/functions/v1/workflow-webhook/${workflowId}`;
            
            // Clear previous results
            document.getElementById('results').innerHTML = '';
            
            // Show test info
            const infoDiv = document.createElement('div');
            infoDiv.className = 'bg-blue-900/30 rounded-lg p-4 mb-4';
            infoDiv.innerHTML = `
                <p class="text-sm font-semibold mb-2">üß™ Testing ${testScenarios.length} Classification Scenarios</p>
                <p class="text-xs text-gray-400">Using GPT-4o-inspired logic for priority, category, and deadline calculation</p>
            `;
            document.getElementById('results').appendChild(infoDiv);
            
            // Test each scenario
            for (const scenario of testScenarios) {
                const payload = {
                    action_item: scenario.action_item,
                    meeting_end: scenario.meeting_end?.toISOString(),
                    endedAt: scenario.meeting_end?.toISOString(),
                    meetingUrl: "https://fathom.video/share/test-enhanced",
                    shareId: `test-${Date.now()}-${Math.random()}`
                };
                
                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    const responseData = await response.json();
                    
                    // Create result card
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'bg-gray-800 rounded-lg p-4 mb-4';
                    
                    if (response.ok && responseData.result?.action_items) {
                        const item = responseData.result.action_items[0];
                        const success = response.ok;
                        
                        // Extract classification details from response
                        // Note: We may need to update the Edge Function to return more details
                        
                        resultDiv.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="text-lg font-semibold ${success ? 'text-green-400' : 'text-red-400'}">
                                    ${success ? '‚úÖ' : '‚ùå'} ${scenario.name}
                                </h3>
                                <span class="text-xs text-gray-500">Scenario ${testScenarios.indexOf(scenario) + 1}</span>
                            </div>
                            <div class="text-sm space-y-1">
                                <p class="text-gray-300">"${scenario.action_item[0].item}"</p>
                                <div class="grid grid-cols-3 gap-4 mt-3 p-3 bg-gray-700 rounded">
                                    <div>
                                        <span class="text-xs text-gray-400">Priority:</span>
                                        <p class="font-semibold">${scenario.expected.priority}</p>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-400">Category:</span>
                                        <p class="font-semibold">${scenario.expected.category}</p>
                                    </div>
                                    <div>
                                        <span class="text-xs text-gray-400">Deadline:</span>
                                        <p class="font-semibold">${scenario.expected.deadline_days} days</p>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs">
                                    <span class="${item.is_sales_rep_task ? 'text-green-400' : 'text-blue-400'}">
                                        ${item.is_sales_rep_task ? '‚Üí Created in task list' : '‚Üí Meeting page only (prospect task)'}
                                    </span>
                                </div>
                            </div>
                            <details class="mt-3">
                                <summary class="cursor-pointer text-xs text-blue-400">View Response</summary>
                                <pre class="mt-2 text-xs overflow-x-auto bg-gray-900 p-2 rounded">${JSON.stringify(responseData.result, null, 2)}</pre>
                            </details>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <h3 class="text-lg font-semibold text-red-400">‚ùå ${scenario.name} - Failed</h3>
                            <pre class="mt-2 text-xs text-red-300">${JSON.stringify(responseData, null, 2)}</pre>
                        `;
                    }
                    
                    document.getElementById('results').appendChild(resultDiv);
                    
                } catch (error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'bg-red-900/30 rounded-lg p-4 mb-4';
                    errorDiv.innerHTML = `
                        <h3 class="text-lg font-semibold">‚ùå ${scenario.name} - Error</h3>
                        <p class="text-sm mt-2">${error.message}</p>
                    `;
                    document.getElementById('results').appendChild(errorDiv);
                }
                
                // Small delay between tests
                await new Promise(r => setTimeout(r, 500));
            }
            
            // Summary
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'bg-gray-800 rounded-lg p-6 mt-6';
            summaryDiv.innerHTML = `
                <h3 class="text-xl font-semibold mb-3">üìä Classification Logic Summary</h3>
                <div class="space-y-3 text-sm text-gray-300">
                    <div>
                        <strong class="text-gray-200">Priority Detection:</strong>
                        <ul class="ml-4 mt-1 list-disc text-xs">
                            <li>Urgent: "urgent", "asap", "immediately", "critical" ‚Üí 1 day deadline</li>
                            <li>High: "important", "priority", "soon", "quickly" ‚Üí 2 day deadline</li>
                            <li>Medium: Default ‚Üí 3 day deadline</li>
                            <li>Low: "whenever", "no rush", "when possible" ‚Üí 7 day deadline</li>
                        </ul>
                    </div>
                    <div>
                        <strong class="text-gray-200">Category Classification:</strong>
                        <ul class="ml-4 mt-1 list-disc text-xs">
                            <li>Call: "call", "phone", "meeting", "discuss"</li>
                            <li>Email: "email", "send" + "@"</li>
                            <li>Proposal: "proposal", "quote", "pricing"</li>
                            <li>LinkedIn: "linkedin" + context</li>
                            <li>WhatsApp: "whatsapp", "text", "sms"</li>
                            <li>Send Information: Default or "send", "share", "provide"</li>
                        </ul>
                    </div>
                    <div>
                        <strong class="text-gray-200">Deadline Intelligence:</strong>
                        <ul class="ml-4 mt-1 list-disc text-xs">
                            <li>Day names (Monday-Friday) ‚Üí Calculate days until that day</li>
                            <li>"This week" ‚Üí Days until Friday</li>
                            <li>"Next week" ‚Üí 7 days</li>
                            <li>Weekends automatically skipped</li>
                            <li>Priority-based defaults when no date specified</li>
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('results').appendChild(summaryDiv);
        }
    </script>
</body>
</html>