# Complete Schema Fix Guide

## Problem Summary

The bootstrap schema created basic tables, but is missing many columns that exist in production. This causes all data inserts to fail.

## Solution: Two-Step Process

### Step 1: Add Missing Columns

Run this SQL in the Supabase dashboard SQL Editor:

```sql
-- Add All Missing Columns
-- Generated by analyzing production data

-- profiles
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS last_login_at TIMESTAMPTZ;

-- contacts
ALTER TABLE contacts ADD COLUMN IF NOT EXISTS company TEXT;

-- deals
ALTER TABLE deals ADD COLUMN IF NOT EXISTS clerk_org_id UUID;

-- activities
ALTER TABLE activities ADD COLUMN IF NOT EXISTS execution_order INTEGER;

-- meetings
ALTER TABLE meetings ADD COLUMN IF NOT EXISTS calendar_invitees_type JSONB;

-- communication_events
ALTER TABLE communication_events ADD COLUMN IF NOT EXISTS action_items JSONB;

-- workflow_executions
ALTER TABLE workflow_executions ADD COLUMN IF NOT EXISTS action_results JSONB;

-- Create workflow_definitions table (missing from bootstrap)
CREATE TABLE IF NOT EXISTS workflow_definitions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    user_id UUID REFERENCES auth.users(id),
    organization_id UUID REFERENCES organizations(id),
    trigger_type TEXT NOT NULL,
    trigger_config JSONB,
    actions JSONB NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### Step 2: Handle Foreign Key Constraints

The `organizations` table has a `created_by` foreign key that references `auth.users`. This will cause errors during sync because:
1. Organizations reference users that don't exist yet
2. We need to either:
   - Sync auth.users first (recommended)
   - OR temporarily disable the constraint

**Option A: Disable constraint temporarily**
```sql
ALTER TABLE organizations DROP CONSTRAINT IF EXISTS organizations_created_by_fkey;
```

**Option B: Sync auth.users first**
This is handled automatically in the sync script (see below).

### Step 3: Run Data Sync

After adding the columns, run:

```bash
node sync-data-via-api.mjs
```

## Expected Results

After completing all steps, you should see:

```
✅ profiles: 20 records
✅ organizations: 10 records
✅ contacts: 1838 records
✅ deals: 652 records
✅ activities: 6841 records
✅ tasks: 0 records (empty in production)
✅ meetings: 1563 records
✅ communication_events: 16 records
✅ workflow_definitions: 0 records (doesn't exist in production)
✅ workflow_executions: 9 records
✅ auth.users: X users
```

## Troubleshooting

### If you still get "column not found" errors

Wait 2-3 minutes for PostgREST schema cache to refresh, then retry the sync.

### If you get foreign key constraint violations

1. Drop the constraint:
   ```sql
   ALTER TABLE organizations DROP CONSTRAINT organizations_created_by_fkey;
   ```

2. Re-run sync

3. Re-add constraint after sync completes:
   ```sql
   ALTER TABLE organizations
   ADD CONSTRAINT organizations_created_by_fkey
   FOREIGN KEY (created_by) REFERENCES auth.users(id);
   ```

### If sync still fails

Check which specific columns are missing by looking at the error messages, then add them:
```sql
ALTER TABLE [table_name] ADD COLUMN IF NOT EXISTS [column_name] [data_type];
```

## Files Reference

- **add-known-missing-columns.sql** - Generated SQL with missing columns
- **get-production-columns.mjs** - Script that identified missing columns
- **sync-data-via-api.mjs** - Data sync script

## Timeline

- Step 1 (Add columns): 30 seconds
- Step 2 (Disable constraint): 10 seconds
- PostgREST cache refresh: 2-3 minutes
- Step 3 (Data sync): 3-5 minutes
- **Total: 6-9 minutes**
